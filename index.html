<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Loading...</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK Compat Version -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

    <style>
        /* ... Existing CSS ... */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary: #2563eb; --secondary: #f97316; --dark: #1f2937; --gray: #6b7280; --light: #f9fafb; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); --transition: all 0.3s ease; }
        body { font-family: 'Poppins', sans-serif; color: var(--dark); background-color: var(--light); line-height: 1.6; overflow-x: hidden; }
        .container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .page-section { display: none; animation: fadeIn 0.5s ease; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translate(-50%, 100px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        header { background-color: white; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100; }
        .header-content { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; height: 70px; }
        .progress-bar { height: 4px; background-color: var(--primary); width: 0%; position: absolute; bottom: -4px; left: 0; transition: width 0.4s ease-out, opacity 0.3s ease; opacity: 1; }
        .logo { display: flex; align-items: center; height: 100%; max-width: 180px; cursor: pointer; }
        .logo img { max-height: 35px; width: auto; object-fit: contain; }
        .header-actions { display: flex; align-items: center; gap: 20px; }
        .search-container { position: relative; }
        .header-search-icon { cursor: pointer; color: var(--dark); transition: var(--transition); }
        .header-search-icon:hover { color: var(--primary); }
        .cart-icon { position: relative; cursor: pointer; }
        .cart-count { position: absolute; top: -8px; right: -8px; background-color: var(--secondary); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; display: none; }
        .auth-buttons { display: flex; gap: 10px; }
        .btn { padding: 8px 20px; border-radius: 4px; border: none; font-family: 'Poppins', sans-serif; font-weight: 500; cursor: pointer; transition: var(--transition); }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-outline { background-color: transparent; color: var(--primary); border: 1px solid var(--primary); }
        .btn-outline:hover { background-color: var(--primary); color: white; }
        .btn-secondary { background-color: var(--secondary); color: white; }
        .btn-secondary:hover { background-color: #ea580c; }
        
        .menu-toggle { display: block; cursor: pointer; width: 30px; height: 20px; position: relative; z-index: 101; }
        .menu-bar { display: block; width: 100%; height: 3px; background-color: var(--dark); margin: 4px 0; transition: 0.4s; position: absolute; }
        .menu-bar:nth-child(1) { top: 0; }
        .menu-bar:nth-child(2) { top: 8px; }
        .menu-bar:nth-child(3) { top: 16px; }
        .menu-toggle.active .menu-bar:nth-child(1) { transform: rotate(-45deg); top: 8px; }
        .menu-toggle.active .menu-bar:nth-child(2) { opacity: 0; }
        .menu-toggle.active .menu-bar:nth-child(3) { transform: rotate(45deg); top: 8px; }
        .mobile-menu { display: block; position: absolute; top: 100%; left: 0; right: 0; background-color: white; box-shadow: var(--shadow); padding: 20px; z-index: 99; opacity: 0; transform: translateY(-20px); pointer-events: none; transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); }
        .mobile-menu.active { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .mobile-nav-links { list-style: none; }
        .mobile-nav-links li { margin-bottom: 15px; }
        .mobile-nav-links a { text-decoration: none; color: var(--dark); font-weight: 500; display: block; padding: 10px 0; }
        .mobile-auth { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        
        /* [Change 1] Reduced margin-bottom here */
        .hero { position: relative; color: white; width: 100%; aspect-ratio: 2.5 / 1; max-height: 80vh; margin-bottom: 20px; overflow: hidden; display: flex; align-items: center; }
        .hero-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        .hero-slide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; transition: opacity 1s ease; }
        .hero-slide.active { opacity: 1; }
        .hero-slide img, .hero-slide video, .hero-slide iframe { width: 100%; height: 100%; object-fit: cover; border: none; }
        .hero-slide iframe { pointer-events: none; transform: scale(1.5); }
        .hero::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); z-index: 1; }
        .hero-content { max-width: 600px; position: relative; z-index: 2; padding: 20px; }
        .hero h1 { font-size: 2.8rem; margin-bottom: 20px; line-height: 1.2; }
        .hero p { font-size: 1.2rem; margin-bottom: 30px; opacity: 0.9; }
        .section-title { text-align: center; font-size: 2rem; margin-bottom: 40px; color: var(--dark); }
        
        /* Category Update */
        #categories .section-title { display: none; }
        /* [Change 1] Reduced padding here */
        .categories { padding: 10px 0 20px; }
        .category-grid { display: flex; gap: 30px; overflow-x: auto; padding: 10px; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; justify-content: flex-start; }
        .category-card { background-color: white; border-radius: 16px; width: 100px; height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: var(--shadow); transition: var(--transition); cursor: pointer; scroll-snap-align: center; flex-shrink: 0; border: 1px solid #eee; overflow: hidden; }
        .category-card:hover { transform: translateY(-5px); outline: 2px solid var(--primary); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); }
        .category-icon { font-size: 1.5rem; color: var(--primary); margin-bottom: 5px; }
        .category-card img { width: 50px; height: 50px; object-fit: cover; }
        .category-card h3 { font-size: 0.8rem; font-weight: 600; text-align: center; line-height: 1.2; padding: 0 5px; z-index: 2; }
        
        .products { padding: 60px 0; background-color: #f3f4f6; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 30px; }
        .product-card { background-color: white; border-radius: 8px; overflow: hidden; box-shadow: var(--shadow); transition: var(--transition); cursor: pointer; position: relative; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); }
        .product-img { height: 200px; background-color: #e5e7eb; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .product-img img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
        .product-card:hover .product-img img { transform: scale(1.05); }
        .discount-badge { position: absolute; top: 15px; right: 15px; background-color: var(--secondary); color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; z-index: 10; }
        .product-info { padding: 20px; }
        .product-info h3 { font-size: 1.2rem; margin-bottom: 10px; }
        .price { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .current-price { font-size: 1.3rem; font-weight: 700; color: var(--primary); }
        .original-price { font-size: 1rem; color: var(--gray); text-decoration: line-through; }
        .rating { color: #fbbf24; margin-bottom: 15px; }
        
        .product-card.out-of-stock { pointer-events: none; opacity: 0.8; }
        .out-of-stock-watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg); font-size: 1.2rem; color: rgba(255, 0, 0, 0.7); border: 2px solid rgba(255, 0, 0, 0.7); padding: 5px 15px; text-transform: uppercase; font-weight: 800; letter-spacing: 2px; background: rgba(255,255,255,0.7); border-radius: 4px; z-index: 10; pointer-events: none; }

        .offers { padding: 60px 0; background-color: white; }
        .offer-banner { background: linear-gradient(120deg, var(--primary), #8b5cf6); color: white; border-radius: 20px; padding: 50px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; position: relative; overflow: hidden; box-shadow: 0 20px 40px rgba(37, 99, 235, 0.2); }
        .offer-banner::before, .offer-banner::after { content: ''; position: absolute; width: 200px; height: 200px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; }
        .offer-banner::before { top: -50px; left: -50px; }
        .offer-banner::after { bottom: -50px; right: -50px; }
        .offer-text h2 { font-size: 2.5rem; margin-bottom: 15px; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .timer { display: flex; gap: 15px; text-align: center; z-index: 2; }
        .time-unit { background-color: rgba(255, 255, 255, 0.25); backdrop-filter: blur(5px); padding: 15px; border-radius: 12px; min-width: 80px; border: 1px solid rgba(255, 255, 255, 0.3); }
        .time-value { font-size: 2.2rem; font-weight: 700; line-height: 1; margin-bottom: 5px; }
        .product-details-container { padding: 40px 0; background-color: white; min-height: 80vh; padding-bottom: 120px; }
        .back-btn { display: inline-flex; align-items: center; gap: 8px; margin-bottom: 20px; color: var(--gray); text-decoration: none; cursor: pointer; font-weight: 500; }
        .back-btn:hover { color: var(--primary); }
        .details-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 50px; }
        .details-gallery { display: flex; flex-direction: column; gap: 15px; }
        .main-image { width: 100%; height: 400px; background-color: #f3f4f6; border-radius: 10px; overflow: hidden; border: 1px solid #e5e7eb; cursor: zoom-in; }
        .main-image img { width: 100%; height: 100%; object-fit: contain; }
        .thumbnail-list { display: flex; gap: 10px; overflow-x: auto; }
        .thumbnail { width: 80px; height: 80px; border-radius: 6px; cursor: pointer; opacity: 0.6; transition: var(--transition); border: 2px solid transparent; object-fit: cover; }
        .thumbnail.active, .thumbnail:hover { opacity: 1; border-color: var(--primary); }
        .details-info h1 { font-size: 2.2rem; margin-bottom: 10px; line-height: 1.2; }
        .details-meta { display: flex; gap: 20px; margin-bottom: 20px; font-size: 0.9rem; color: var(--gray); }
        .details-description { margin-bottom: 30px; font-size: 1.1rem; color: #4b5563; }
        .details-actions { display: none; }
        .sticky-actions-bar { position: fixed; bottom: 0; left: 0; width: 100%; background-color: white; box-shadow: 0 -4px 10px rgba(0,0,0,0.1); padding: 15px 20px; z-index: 999; display: flex; gap: 15px; justify-content: center; }
        .sticky-actions-bar .btn { flex: 1; max-width: 300px; }
        .btn-lg { padding: 12px 30px; font-size: 1.1rem; }
        
        /* [Change 2] Variant Selection Update */
        .variant-selector { margin-bottom: 20px; }
        .variant-selector h4 { font-weight: 600; margin-bottom: 10px; }
        .variant-options { display: flex; gap: 10px; flex-wrap: wrap; }
        .variant-option { padding: 8px 20px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: var(--transition); font-weight: 500; display: inline-flex; flex-direction: column; align-items: center; gap: 5px; background-color: #fff; color: var(--dark); min-width: 60px; justify-content: center; position: relative; }
        .variant-option .variant-img { width: 60px; height: 60px; border-radius: 4px; object-fit: cover; border: none; }
        /* Box-shadow simulates outline beautifully and works perfectly with border-radius */
        .variant-option.selected { border-color: var(--primary); background-color: #eff6ff; color: var(--primary); box-shadow: 0 0 0 1px var(--primary); }
        .variant-option.disabled { opacity: 0.5; cursor: not-allowed; background-color: #f3f4f6; }
        
        .options-panel-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1002; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .options-panel-overlay.active { opacity: 1; pointer-events: auto; }
        .options-panel { position: fixed; bottom: 0; left: 0; width: 100%; background-color: white; z-index: 1003; padding: 20px; border-top-left-radius: 16px; border-top-right-radius: 16px; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); transform: translateY(100%); transition: transform 0.3s ease; }
        .options-panel.active { transform: translateY(0); }
        .options-panel-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; gap: 15px; }
        .options-panel-product-info { display: flex; align-items: center; gap: 15px; flex-grow: 1; }
        .options-panel-product-info img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; }
        .options-panel-product-info h4 { font-size: 1.1rem; margin: 0; line-height: 1.2; }
        .options-panel-product-info .current-price { font-size: 1.2rem; }
        .options-panel-close { font-size: 1.5rem; cursor: pointer; background: none; border: none; color: var(--gray); align-self: flex-start; }
        .options-panel-body .quantity-selector { display: flex; align-items: center; justify-content: space-between; margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee; }
        .options-panel-actions .btn { width: 100%; padding: 12px; }
        .checkout { padding: 60px 0; }
        .checkout-form { background-color: white; border-radius: 8px; padding: 30px; box-shadow: var(--shadow); max-width: 800px; margin: 0 auto; }
        .form-group { margin-bottom: 20px; }
        .form-group.password-group { position: relative; }
        .password-toggle-icon { position: absolute; top: 68%; right: 15px; transform: translateY(-50%); cursor: pointer; color: var(--gray); }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-control { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Poppins', sans-serif; }
        .address-management { margin-bottom: 20px; }
        .address-management .form-group { display: flex; align-items: center; gap: 15px; }
        #shippingInfoForm.hidden { display: none; }
        
        /* [Change 3] Payment Methods layout update */
        .payment-methods { display: flex; flex-direction: column; gap: 12px; margin: 20px 0; }
        .payment-method { display: flex; flex-direction: row; align-items: center; justify-content: flex-start; padding: 15px 20px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: var(--transition); gap: 15px; background-color: #fff; text-align: left; position: relative; }
        .payment-method img { max-width: 40px; max-height: 40px; object-fit: contain; }
        .payment-method i { font-size: 24px; color: var(--primary); width: 40px; text-align: center; }
        .payment-method p { margin: 0; font-weight: 500; flex-grow: 1; font-size: 1rem; color: var(--dark); }
        .payment-method::after { content: '\f105'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: #ccc; font-size: 1.2rem; }
        .payment-method:hover { border-color: var(--primary); }
        .payment-method.active { border-color: var(--primary); background-color: #eff6ff; }
        .payment-method.active::after { color: var(--primary); }

        .auth-container { max-width: 450px; margin: 60px auto; background: white; padding: 40px; border-radius: 8px; box-shadow: var(--shadow); }
        .auth-title { text-align: center; margin-bottom: 30px; color: var(--primary); }
        .social-login { margin-top: 25px; padding-top: 25px; border-top: 1px solid #eee; }
        .google-btn { width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; background-color: white; border: 1px solid #ddd; color: #555; padding: 10px; border-radius: 4px; cursor: pointer; transition: var(--transition); font-weight: 500; }
        .google-btn:hover { background-color: #f8f9fa; border-color: #ccc; }
        .google-btn img { width: 20px; height: 20px; }
        .auth-switch { text-align: center; margin-top: 20px; font-size: 0.9rem; }
        .auth-switch a { color: var(--primary); text-decoration: none; font-weight: 500; }
        .cart-overlay { position: fixed; top: 0; right: 0; bottom: 0; width: 100%; max-width: 400px; background-color: white; box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1); transform: translateX(100%); transition: transform 0.3s ease; z-index: 1001; display: flex; flex-direction: column; }
        .cart-overlay.active { transform: translateX(0); }
        .cart-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #e5e7eb; }
        .close-cart { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        .cart-items { flex: 1; overflow-y: auto; padding: 20px; }
        .cart-item { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid #f3f4f6; gap: 10px; }
        .cart-item-details-link { display: flex; align-items: center; flex-grow: 1; text-decoration: none; color: inherit; cursor: pointer; }
        .cart-item-img { width: 80px; height: 80px; background-color: #e5e7eb; border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 15px; overflow: hidden; }
        .cart-item-img img { width: 100%; height: 100%; object-fit: cover; }
        .cart-item-info { flex: 1; padding-left: 10px;}
        .cart-item-info h4 { font-size: 1rem; margin-bottom: 5px; }
        .cart-item-price { color: var(--primary); font-weight: 600; margin-bottom: 5px; }
        .cart-item-actions { display: flex; align-items: center; gap: 10px; }
        .cart-item-qty { width: 50px; text-align: center; padding: 5px; border: 1px solid #ddd; }
        .remove-item { background: none; border: none; color: #ef4444; cursor: pointer; }
        .cart-footer { padding: 20px; border-top: 1px solid #e5e7eb; }
        .cart-total { display: flex; justify-content: space-between; font-size: 1.3rem; font-weight: 700; margin-bottom: 20px; }
        footer { background-color: var(--dark); color: white; padding: 60px 0 30px; }
        .footer-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 40px; margin-bottom: 40px; }
        .footer-logo { display: flex; align-items: center; max-width: 180px; cursor: pointer; margin-bottom: 20px; }
        .footer-logo img { max-height: 50px; width: auto; object-fit: contain; filter: brightness(0) invert(1); }
        .footer-about p { margin-bottom: 20px; opacity: 0.8; }
        .footer-links h3, .footer-contact h3 { font-size: 1.2rem; margin-bottom: 20px; }
        .footer-links ul { list-style: none; }
        .footer-links li { margin-bottom: 10px; }
        .footer-links a { color: white; text-decoration: none; opacity: 0.8; transition: var(--transition); }
        .footer-links a:hover { opacity: 1; color: var(--primary); }
        .footer-contact p { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; opacity: 0.8; }
        .social-icons { display: flex; gap: 15px; margin-top: 20px; }
        .social-icon { width: 40px; height: 40px; background-color: rgba(255, 255, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; text-decoration: none; transition: var(--transition); }
        .social-icon:hover { background-color: var(--primary); transform: translateY(-3px); }
        .copyright { text-align: center; padding-top: 30px; border-top: 1px solid rgba(255, 255, 255, 0.1); opacity: 0.7; }
        .search-page-container { min-height: 60vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; }
        .search-page-container h1 { font-size: 2.5rem; margin-bottom: 30px; color: var(--dark); }
        .search-page-form { width: 100%; max-width: 600px; display: flex; box-shadow: var(--shadow); border-radius: 8px; overflow: hidden; position: relative; }
        .search-page-input { flex: 1; border: none; padding: 15px 25px; font-size: 1.1rem; font-family: 'Poppins', sans-serif; border: 2px solid transparent; transition: var(--transition); }
        .search-page-input:focus { outline: none; border-color: var(--primary); }
        .search-page-btn { padding: 0 30px; border: none; background-color: var(--primary); color: white; font-size: 1.2rem; cursor: pointer; transition: var(--transition); }
        .search-page-btn:hover { background-color: #1d4ed8; }
        .keyword-suggestions { max-width: 600px; width: 100%; margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .keyword-chip { background-color: #e5e7eb; color: var(--dark); padding: 5px 12px; border-radius: 15px; font-size: 0.9rem; cursor: pointer; transition: var(--transition); }
        .keyword-chip:hover { background-color: var(--primary); color: white; }
        .search-results-container { padding: 40px 0; min-height: 80vh; }
        #search-suggestions-list { width: 100%; max-width: 600px; background: white; border-radius: 8px; box-shadow: var(--shadow); margin-top: 10px; overflow: hidden; max-height: 300px; overflow-y: auto; }
        .suggestion-item { padding: 12px 20px; cursor: pointer; transition: var(--transition); border-bottom: 1px solid #f3f4f6; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: #f3f4f6; color: var(--primary); }
        .lightbox { display: none; position: fixed; z-index: 1002; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
        .lightbox-content { margin: auto; display: block; max-width: 90vw; max-height: 90vh; object-fit: contain; transition: transform 0.3s ease; cursor: zoom-in; image-rendering: -webkit-optimize-contrast; image-rendering: crisp-edges; }
        .lightbox-content.zoomed { transform: scale(1.5); cursor: zoom-out; }
        .close-lightbox { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; transition: 0.3s; cursor: pointer; }
        .quantity-selector { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .qty-btn, .cart-item-actions .qty-btn { width: 30px; height: 30px; border: 1px solid #ddd; background-color: #f8f9fa; cursor: pointer; font-size: 1.2rem; font-weight: bold; color: var(--dark); border-radius: 4px; transition: var(--transition); }
        .qty-btn:hover, .cart-item-actions .qty-btn:hover { background-color: #e9ecef; border-color: #ccc; }
        .qty-input, .cart-item-qty { width: 50px; height: 30px; text-align: center; border: 1px solid #ddd; border-radius: 4px; font-family: 'Poppins', sans-serif; -moz-appearance: textfield; }
        .qty-input::-webkit-outer-spin-button, .qty-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .search-clear-btn { position: absolute; right: 85px; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 1.8rem; line-height: 1; color: #999; cursor: pointer; padding: 0 10px; }
        .delivery-info { background-color: #eef2ff; border-left: 4px solid var(--primary); padding: 10px 15px; margin: 15px 0; border-radius: 4px; font-size: 0.9rem; color: var(--dark); }
        .delivery-info .delivery-charge { font-weight: 600; color: var(--primary); }
        .cart-item-selector { display: flex; align-items: center; justify-content: center; }
        .cart-item-checkbox { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary); }
        
        .profile-icon { display: none !important; }
        body.user-logged-in .auth-buttons, body.user-logged-in .mobile-auth { display: none; }
        
        #profile-page .container { padding-top: 10px; padding-bottom: 10px; }
        .profile-container { display: flex; gap: 30px; }
        .sidebar { width: 250px; flex-shrink: 0; }
        .profile-card { background-color: white; border-radius: 10px; padding: 25px; text-align: center; box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05); margin-bottom: 20px; }
        .profile-picture { width: 100px; height: 100px; border-radius: 50%; background-color: #eef2ff; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; color: var(--primary); font-size: 40px; border: 3px solid var(--primary); }
        .profile-name { font-size: 22px; font-weight: 600; margin-bottom: 5px; }
        .profile-email { color: var(--gray); font-size: 14px; margin-bottom: 15px; }
        .nav-menu { background-color: white; border-radius: 10px; overflow: hidden; box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05); }
        .nav-item { display: flex; align-items: center; padding: 18px 20px; color: var(--dark); text-decoration: none; border-left: 4px solid transparent; transition: all 0.3s ease; cursor: pointer; }
        .nav-item:hover { background-color: var(--light); color: var(--primary); }
        .nav-item.active { background-color: #eef2ff; color: var(--primary); border-left-color: var(--primary); }
        .nav-item i { margin-right: 12px; font-size: 18px; width: 24px; }
        .main-content { flex-grow: 1; }
        .content-section { background-color: white; border-radius: 10px; padding: 30px; margin-bottom: 25px; box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05); display: none; }
        .content-section.active { display: block; animation: fadeIn 0.5s; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #ddd; }
        .section-header .section-title { font-size: 22px; font-weight: 600; color: var(--primary); margin-bottom: 0; text-align: left; }
        .form-row { display: flex; gap: 20px; }
        .form-row .form-group { flex: 1; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--dark); }
        .main-content .form-control { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; transition: border 0.3s ease; }
        .main-content .form-control:focus { outline: none; border-color: var(--primary); }
        .locations-list { margin-top: 20px; }
        .skeleton-card { background-color: white; border-radius: 8px; overflow: hidden; box-shadow: var(--shadow); }
        .skeleton-img, .skeleton-line { background-color: #e2e8f0; background: linear-gradient(90deg, #e2e8f0 25%, #f8fafc 50%, #e2e8f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        .skeleton-img { height: 200px; }
        .skeleton-info { padding: 20px; }
        .skeleton-line { height: 16px; border-radius: 4px; margin-bottom: 10px; }
        .skeleton-line.short { width: 60%; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .suggested-products-section { padding: 60px 0; background-color: #f9fafb; }
        .suggested-products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .suggested-product-card { background-color: white; border-radius: 8px; overflow: hidden; box-shadow: var(--shadow); transition: var(--transition); cursor: pointer; border: 1px solid #e5e7eb; }
        .suggested-product-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); border-color: var(--primary); }
        .suggested-product-img { height: 150px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .suggested-product-img img { width: 100%; height: 100%; object-fit: contain; }
        .suggested-product-info { padding: 15px; text-align: center; }
        .suggested-product-info h4 { font-size: 1rem; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .suggested-product-info .current-price { font-size: 1.1rem; font-weight: 600; }
        .filter-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px; }
        .filter-controls .section-title { margin-bottom: 0; text-align: left; }
        .filter-options { display: flex; flex-wrap: wrap; gap: 10px; }
        .filter-options button { background-color: #fff; border: 1px solid #ddd; padding: 8px 15px; border-radius: 20px; cursor: pointer; transition: var(--transition); }
        .filter-options button:hover { background-color: #f3f4f6; border-color: #ccc; }
        .filter-options button.active { background-color: var(--primary); color: white; border-color: var(--primary); }
        
        .custom-alert-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .custom-alert-overlay.active { opacity: 1; pointer-events: auto; }
        .custom-alert-box { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); text-align: center; max-width: 400px; width: 90%; transform: scale(0.9); transition: transform 0.3s ease; }
        .custom-alert-overlay.active .custom-alert-box { transform: scale(1); }
        .custom-alert-box h3 { margin-bottom: 15px; color: var(--dark); }
        .custom-alert-box p { margin-bottom: 25px; color: var(--gray); }
        .custom-alert-actions { display: flex; justify-content: center; gap: 15px; }
        
        .welcome-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.8); z-index: 3000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.4s ease; }
        .welcome-overlay.active { display: flex; opacity: 1; }
        .welcome-box { width: 100vw; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; transform: scale(1); background: transparent !important; box-shadow: none !important; padding: 0 !important; }

        .order-details-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2500; display: none; align-items: flex-end; justify-content: center; }
        .order-details-overlay.active { display: flex; animation: fadeIn 0.3s ease; }
        .order-details-modal { background: #f5f5f5; width: 100%; max-width: 500px; height: 90vh; border-radius: 12px 12px 0 0; display: flex; flex-direction: column; overflow-y: auto; position: relative; font-family: 'Poppins', sans-serif; animation: slideUp 0.4s ease; }
        @media(min-width: 576px) { .order-details-modal { height: auto; max-height: 90vh; border-radius: 12px; margin: 20px; animation: fadeIn 0.3s ease; } .order-details-overlay { align-items: center; } }
        .od-header { padding: 15px 20px; background: white; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
        .od-header h3 { font-size: 1.1rem; margin: 0; font-weight: 600; }
        .od-header button { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray); transition: color 0.2s; }
        .od-header button:hover { color: #ef4444; }
        .od-section { background: white; padding: 15px 20px; border-bottom: 8px solid #f5f5f5; }
        .od-section:last-of-type { border-bottom: none; }
        .od-item { display: flex; gap: 15px; margin-bottom: 15px; }
        .od-item:last-child { margin-bottom: 0; }
        .od-item img { width: 70px; height: 70px; object-fit: cover; border-radius: 6px; border: 1px solid #eee; }
        .od-item-info { flex: 1; }
        .od-item-info h4 { font-size: 0.9rem; margin: 0 0 5px 0; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3; font-weight: 500; }
        .od-item-variant { font-size: 0.75rem; color: #666; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-bottom: 5px; }
        .od-item-price-row { display: flex; justify-content: space-between; align-items: center; }
        .od-item-price { font-weight: 600; font-size: 0.9rem; }
        .od-item-qty { font-size: 0.85rem; color: #666; font-weight: 500; }
        .od-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; color: #333; }
        .od-row:last-child { margin-bottom: 0; }
        .od-row span:first-child { color: #666; }
        .od-total { border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px; font-weight: 700; font-size: 1rem; }
        .od-total span:first-child { color: #333; }
        .od-meta-section { font-size: 0.85rem; }
        .od-meta-section .od-row { margin-bottom: 12px; }
        .od-actions { padding: 15px 20px; background: white; position: sticky; bottom: 0; border-top: 1px solid #eee; }

        .promo-popup { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(200%); background-color: white; border: 2px solid #000; border-radius: 12px; display: flex; flex-direction: row !important; align-items: stretch; width: 400px; max-width: 95vw; z-index: 1500; transition: transform 0.5s cubic-bezier(0.165, 0.84, 0.44, 1); padding: 0; box-shadow: 0 10px 25px rgba(0,0,0,0.2); overflow: hidden; }
        .promo-popup.visible { transform: translateX(-50%) translateY(0); }
        .promo-popup-img { width: 130px; height: auto; object-fit: cover; border-right: 1px solid #eee; flex-shrink: 0; }
        .promo-popup-content { display: flex; flex-direction: column; justify-content: center; padding: 15px; flex-grow: 1; position: relative; }
        .promo-popup-content h4 { font-size: 1.1rem; margin: 0 0 5px 0; max-width: 100%; white-space: normal; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; font-weight: 700; color: #000; line-height: 1.3; }
        .promo-popup-content .price { display: flex; align-items: baseline; gap: 8px; margin: 0 0 10px 0; }
        .promo-popup-content .current-price { font-size: 1.25rem; font-weight: 800; color: #000; }
        .promo-popup-content .original-price { display: inline-block; font-size: 0.9rem; color: #666; text-decoration: line-through; }
        .promo-popup-content .btn { background-color: #38bdf8; border: none; border-radius: 30px; font-weight: 700; font-size: 1.1rem; padding: 8px; width: 100%; color: white; transition: background 0.3s; cursor: pointer; }
        .promo-popup-content .btn:hover { background-color: #0ea5e9; }
        .promo-popup-discount { position: absolute; top: 0; right: 0; background-color: #dc2626; color: white; padding: 8px 15px; border-bottom-left-radius: 20px; font-weight: 800; font-size: 1rem; text-align: center; line-height: 1.1; z-index: 2; }
        .promo-popup-close { position: absolute; top: 5px; left: 5px; background: rgba(0,0,0,0.4); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; border: none; cursor: pointer; z-index: 10; margin: 0; }

        @media (max-width: 992px) { .details-wrapper { grid-template-columns: 1fr; } .offer-banner { flex-direction: column; text-align: center; gap: 30px; } .profile-container { flex-direction: column; } .sidebar { width: 100%; } .form-row { flex-direction: column; gap: 0; } }
        @media (max-width: 768px) { 
            .header-actions .auth-buttons, .search-container { display: none; } 
            .body.user-logged-in .header-actions .auth-buttons { display: none; } 
            .header-actions { gap: 15px; } 
            .hero { aspect-ratio: 3 / 2; } 
            .hero h1 { font-size: 2.2rem; } 
            .filter-controls { flex-direction: column; align-items: stretch; } 
        }
        @media (max-width: 576px) { 
            .product-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); } 
            .timer { flex-wrap: wrap; justify-content: center; } 
            .category-card { width: 80px; height: 80px; border-radius: 12px; } 
            .category-icon { font-size: 1.2rem; } 
            .category-card h3 { font-size: 0.7rem; } 
            .suggested-products-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); } 
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <a href="#home" class="logo" onclick="navigateTo('home')">
                    <img id="headerLogo" src="" alt="Logo">
                </a>
                
                <div class="header-actions">
                    <div class="header-search-icon" onclick="navigateTo('search')">
                        <i class="fas fa-search fa-lg"></i>
                    </div>
                    
                    <div class="cart-icon" id="cartIcon">
                        <i class="fas fa-shopping-cart fa-lg"></i>
                        <span class="cart-count">0</span>
                    </div>
                    
                    <div class="auth-buttons" id="authButtons">
                        <button class="btn btn-outline" onclick="navigateTo('login')">Login</button>
                        <button class="btn btn-primary" onclick="navigateTo('register')">Register</button>
                    </div>

                    <div class="menu-toggle" id="menuToggle">
                        <span class="menu-bar"></span>
                        <span class="menu-bar"></span>
                        <span class="menu-bar"></span>
                    </div>
                </div>
            </div>
            
            <div class="progress-bar" id="progressBar"></div>

            <div class="mobile-menu" id="mobileMenu">
                <div id="menuProfileSection" style="display: none; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; text-align: center;">
                    <div class="profile-picture" style="width: 60px; height: 60px; margin: 0 auto 10px; font-size: 24px; border-radius: 50%; background-color: #eef2ff; color: var(--primary); display: flex; align-items: center; justify-content: center; border: 2px solid var(--primary);"><i class="fas fa-user"></i></div>
                    <h4 id="menuProfileName" style="margin-bottom: 5px;">User Name</h4>
                    <button class="btn btn-outline" onclick="navigateTo('profile'); toggleMenu()" style="width: 100%; font-size: 0.9rem; padding: 8px;">My Profile</button>
                </div>

                <ul class="mobile-nav-links">
                    <li><a href="#home" onclick="navigateTo('home'); toggleMenu()">Home</a></li>
                    <li><a href="#search" onclick="navigateTo('search'); toggleMenu()">Search</a></li>
                    <li><a href="#home" onclick="navigateTo('home'); toggleMenu(); document.getElementById('shop').scrollIntoView()">Shop</a></li>
                    <li><a href="#home" onclick="navigateTo('home'); toggleMenu(); document.getElementById('categories').scrollIntoView()">Categories</a></li>
                    <li><a href="#home" onclick="navigateTo('home'); toggleMenu(); document.getElementById('offers').scrollIntoView()">Offers</a></li>
                    <li><a href="#home" onclick="navigateTo('home'); toggleMenu(); document.getElementById('contact').scrollIntoView()">About</a></li>
                    <li><a href="#home" onclick="navigateTo('home'); toggleMenu(); document.getElementById('contact').scrollIntoView()">Contact</a></li>
                </ul>
                
                <div class="mobile-auth" id="mobileAuth">
                    <button class="btn btn-outline" onclick="navigateTo('login'); toggleMenu()">Login</button>
                    <button class="btn btn-primary" onclick="navigateTo('register'); toggleMenu()">Register</button>
                </div>
            </div>
        </div>
    </header>

    <main>
        <!-- HOME PAGE SECTION -->
        <div id="home-page" class="page-section">
            <section class="hero" id="home">
                <div class="hero-bg" id="heroBg"></div>
                <div class="container">
                    <div class="hero-content">
                        <h1 id="heroTitle"></h1>
                        <p id="heroDesc"></p>
                        <button class="btn btn-secondary btn-shop">Start Shoping</button>
                    </div>
                </div>
            </section>

            <section class="categories" id="categories">
                <div class="container">
                    <h2 class="section-title">Shop by Category</h2>
                    <div class="category-grid" id="categoryGrid"></div>
                </div>
            </section>

            <section class="products" id="shop">
                <div class="container">
                    <div class="filter-controls">
                        <h2 class="section-title" id="shopTitle">Featured Products</h2>
                        <div class="filter-options" id="homeFilterOptions">
                            <button data-filter="default" class="active">Default</button>
                            <button data-filter="price-asc">Price: Low to high</button>
                            <button data-filter="price-desc">Price: High to low</button>
                            <button data-filter="top-selling">Top Selling</button>
                            <button data-filter="most-discount">Most Discount</button>
                        </div>
                    </div>
                    <div class="product-grid" id="productGrid"></div>
                </div>
            </section>

            <section class="offers" id="offers">
                <div class="container">
                    <h2 class="section-title">Special Offers</h2>
                    <div class="offer-banner">
                        <div class="offer-text">
                            <h2 id="offerTitle"></h2>
                            <p id="offerSubtitle"></p>
                            <p id="offerDesc"></p>
                        </div>
                        <div class="timer">
                            <div class="time-unit">
                                <div class="time-value" id="days">00</div>
                                <div>Days</div>
                            </div>
                            <div class="time-unit">
                                <div class="time-value" id="hours">00</div>
                                <div>Hours</div>
                            </div>
                            <div class="time-unit">
                                <div class="time-value" id="minutes">00</div>
                                <div>Minutes</div>
                            </div>
                            <div class="time-unit">
                                <div class="time-value" id="seconds">00</div>
                                <div>Seconds</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- PRODUCT DETAILS PAGE SECTION -->
        <div id="product-details-page" class="page-section">
            <div class="container product-details-container">
                <div class="back-btn" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i> Back
                </div>
                
                <div class="details-wrapper">
                    <div class="details-gallery">
                        <div class="main-image">
                            <img id="detailMainImg" src="" alt="Product">
                        </div>
                        <div class="thumbnail-list" id="detailThumbnails"></div>
                    </div>
                    
                    <div class="details-info">
                        <h1 id="detailName">Product Name</h1>
                        <div class="rating" id="detailRating"></div>
                        <div class="price">
                            <span class="current-price" id="detailPrice">৳0.00</span>
                            <span class="original-price" id="detailOldPrice">৳0.00</span>
                        </div>
                        
                        <div class="delivery-info">
                            <p><i class="fas fa-truck"></i> <strong>Delivery Charge:</strong> <span class="delivery-charge" id="deliveryInsideTk"></span> inside Dhaka, <span class="delivery-charge" id="deliveryOutsideTk"></span> outside Dhaka.</p>
                        </div>
                        <div id="detailPaymentGateways" style="display: flex; gap: 10px; margin: 15px 0; align-items: center; flex-wrap: wrap;"></div>

                        <div id="detailVariantSelectors"></div>
                        
                        <div class="quantity-selector">
                            <label>Quantity:</label>
                            <button class="qty-btn" id="detailDecQty">-</button>
                            <input type="number" class="qty-input" id="detailQty" value="1" min="1">
                            <button class="qty-btn" id="detailIncQty">+</button>
                            <span id="detailStockStatus" style="margin-left: 10px; font-size: 0.9rem; color: var(--gray);"></span>
                        </div>
                        
                        <div class="details-description">
                            <p id="detailDesc">Description goes here...</p>
                        </div>

                        <div class="details-actions">
                            <button class="btn btn-outline btn-lg" id="detailAddToCartOriginal">Add to Cart</button>
                            <button class="btn btn-primary btn-lg" id="detailBuyNowOriginal">Buy Now</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <section class="suggested-products-section">
                <div class="container">
                    <h2 class="section-title">You Might Also Like</h2>
                    <div class="suggested-products-grid" id="suggestedProductsGrid"></div>
                </div>
            </section>

            <div class="sticky-actions-bar">
                 <button class="btn btn-outline btn-lg" id="detailAddToCartSticky">Add to Cart</button>
                 <button class="btn btn-primary btn-lg" id="detailBuyNowSticky">Buy Now</button>
            </div>
        </div>
        
        <!-- SEARCH PAGE SECTION -->
        <div id="search-page" class="page-section">
            <div class="container search-page-container">
                <h1>Search For Products</h1>
                <form class="search-page-form" id="searchPageForm">
                    <input type="text" class="search-page-input" id="searchPageInput" placeholder="What are you looking for?" required autocomplete="off">
                    <button type="button" class="search-clear-btn" id="searchClearBtn" style="display: none;">&times;</button>
                    <button type="submit" class="search-page-btn"><i class="fas fa-search"></i></button>
                </form>
                <div class="keyword-suggestions" id="keywordSuggestions"></div>
                <div id="search-suggestions-list"></div>
            </div>
        </div>
        
        <!-- SEARCH RESULTS PAGE SECTION -->
        <div id="search-results-page" class="page-section">
            <div class="container search-results-container">
                <div class="back-btn" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i> Back to Search
                </div>
                <div class="filter-controls">
                    <h2 class="section-title" id="searchResultsTitle">Search Results</h2>
                    <div class="filter-options" id="searchFilterOptions">
                        <button data-filter="default" class="active">Default</button>
                        <button data-filter="price-asc">Price: Low to high</button>
                        <button data-filter="price-desc">Price: High to low</button>
                        <button data-filter="top-selling">Top Selling</button>
                        <button data-filter="most-discount">Most Discount</button>
                    </div>
                </div>
                <div class="product-grid" id="searchResultsGrid"></div>
            </div>
        </div>

        <!-- CHECKOUT PAGE SECTION -->
        <div id="checkout-page" class="page-section">
            <section class="checkout" id="checkout">
                <div class="container">
                    <div class="back-btn" onclick="goBack()">
                        <i class="fas fa-arrow-left"></i> Back
                    </div>
                    <h2 class="section-title">Checkout</h2>
                    <div class="checkout-form">
                        <h3>Shipping Information</h3>
                        <form id="checkoutForm">
                            <div class="address-management">
                                <div class="form-group" id="addressSelectorGroup" style="width: 100%;">
                                    <select id="savedAddresses" class="form-control" style="flex-grow: 1;"></select>
                                    <button type="button" class="btn btn-outline" id="addNewAddressBtn">Add New</button>
                                </div>
                            </div>

                            <div id="shippingInfoForm">
                                <div class="form-group">
                                    <label for="name">Full Name</label>
                                    <input type="text" id="name" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="phone">Phone Number</label>
                                    <input type="tel" id="phone" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="address">Delivery Address</label>
                                    <textarea id="address" class="form-control" rows="3" required placeholder="E.g., House No, Road, Area"></textarea>
                                </div>
                                 <div class="form-group">
                                    <input type="checkbox" id="saveAddressCheck" checked>
                                    <label for="saveAddressCheck">Save this address for future use</label>
                                </div>
                            </div>
                            
                            <h3>Payment Method</h3>
                            <div class="payment-methods" id="checkoutPaymentMethods">
                                <!-- Dynamic Payment Methods Injected via JS -->
                            </div>
                            
                            <button type="submit" class="btn btn-primary btn-block" style="width: 100%; padding: 15px;">Place Order</button>
                        </form>
                    </div>
                </div>
            </section>
        </div>

        <!-- LOGIN PAGE SECTION -->
        <div id="login-page" class="page-section">
            <div class="container">
                <div class="auth-container">
                    <h2 class="auth-title">Login</h2>
                    <form id="loginForm">
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" class="form-control" placeholder="Enter your email" required>
                        </div>
                        <div class="form-group password-group">
                            <label>Password</label>
                            <input type="password" class="form-control" placeholder="Enter your password" required>
                            <i class="fas fa-eye password-toggle-icon"></i>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                    </form>
                    
                    <div class="social-login">
                        <button class="google-btn">
                            <img src="https://cdn.iconscout.com/icon/free/png-256/free-google-160-189824.png" alt="Google">
                            Sign in with Google
                        </button>
                    </div>

                    <div class="auth-switch">
                        <p>Don't have an account? <a href="#register" onclick="navigateTo('register')">Register</a></p>
                        <p style="margin-top: 10px;"><a href="#home" onclick="navigateTo('home')">Back to Home</a></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- REGISTER PAGE SECTION -->
        <div id="register-page" class="page-section">
            <div class="container">
                <div class="auth-container">
                    <h2 class="auth-title">Create Account</h2>
                    <form id="registerForm">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="registerName" class="form-control" placeholder="Enter full name" required>
                        </div>
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="registerEmail" class="form-control" placeholder="Enter email" required>
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" id="registerPhone" class="form-control" placeholder="Enter phone number" required>
                        </div>
                        <div class="form-group password-group">
                            <label>Password</label>
                            <input type="password" class="form-control" placeholder="Create password" required>
                             <i class="fas fa-eye password-toggle-icon"></i>
                        </div>
                        <div class="form-group password-group">
                            <label>Confirm Password</label>
                            <input type="password" class="form-control" placeholder="Confirm password" required>
                             <i class="fas fa-eye password-toggle-icon"></i>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">Register</button>
                    </form>
                    
                    <div class="social-login">
                        <button class="google-btn">
                            <img src="https://cdn.iconscout.com/icon/free/png-256/free-google-160-189824.png" alt="Google">
                            Sign in with Google
                        </button>
                    </div>

                    <div class="auth-switch">
                        <p>Already have an account? <a href="#login" onclick="navigateTo('login')">Login</a></p>
                        <p style="margin-top: 10px;"><a href="#home" onclick="navigateTo('home')">Back to Home</a></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- PROFILE PAGE SECTION -->
        <div id="profile-page" class="page-section">
            <div class="container">
                <div class="profile-container">
                    <!-- Sidebar -->
                    <div class="sidebar">
                        <div class="profile-card">
                            <div class="profile-picture">
                                <i class="fas fa-user"></i>
                            </div>
                            <h2 class="profile-name" id="profileNameDisplay">User Name</h2>
                            <p class="profile-email" id="profileEmailDisplay">user@email.com</p>
                        </div>
                        
                        <div class="nav-menu" id="profileNav">
                            <a href="#" class="nav-item active" onclick="event.preventDefault(); showProfileSection('setup')">
                                <i class="fas fa-user-cog"></i>
                                Profile Setup
                            </a>
                            <a href="#" class="nav-item" onclick="event.preventDefault(); showProfileSection('location')">
                                <i class="fas fa-map-marker-alt"></i>
                                Location Setup
                            </a>
                            <a href="#" class="nav-item" onclick="event.preventDefault(); showProfileSection('tracking')">
                                <i class="fas fa-box"></i>
                                Order History
                            </a>
                            <a href="#" class="nav-item" onclick="event.preventDefault(); logout()">
                                <i class="fas fa-sign-out-alt"></i>
                                Logout
                            </a>
                        </div>
                    </div>
                    
                    <!-- Main Content -->
                    <div class="main-content">
                        <!-- Profile Setup Section -->
                        <section id="profile-section-setup" class="content-section active">
                            <div class="section-header">
                                <h2 class="section-title">Profile Information</h2>
                            </div>
                            <form id="profileSetupForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="profileName" class="form-label">Full Name</label>
                                        <input type="text" id="profileName" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label for="profilePhone" class="form-label">Phone Number</label>
                                        <input type="tel" id="profilePhone" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="profileEmail" class="form-label">Email Address</label>
                                    <input type="email" id="profileEmail" class="form-control" disabled>
                                </div>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </form>
                        </section>
                        <!-- Location Setup Section -->
                        <section id="profile-section-location" class="content-section">
                            <div class="section-header">
                                <h2 class="section-title">Manage Your Addresses</h2>
                            </div>
                            <form id="newAddressForm">
                                <div class="form-group">
                                    <label for="newAddress" class="form-label">Add New Address</label>
                                    <textarea id="newAddress" class="form-control" rows="3" placeholder="Enter full address"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Save New Address</button>
                            </form>
                            <hr style="margin: 30px 0;">
                            <h4>Saved Addresses:</h4>
                            <div id="savedAddressesList" class="locations-list"></div>
                        </section>
                        <!-- Order History Section -->
                        <section id="profile-section-tracking" class="content-section">
                            <div class="section-header">
                                <h2 class="section-title">Order History</h2>
                            </div>
                            <div id="userOrdersList">
                                <div style="text-align: center; padding: 40px; color: var(--gray);">
                                    <i class="fas fa-receipt fa-3x"></i>
                                    <p style="margin-top: 15px;">Loading orders...</p>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </div>

    </main>
    
    <!-- Footer -->
    <footer id="contact">
        <div class="container">
            <div class="footer-content">
                <div class="footer-about">
                    <a href="#home" class="footer-logo" onclick="navigateTo('home')">
                        <img id="footerLogo" src="" alt="Logo">
                    </a>
                    <p id="footerAboutText"></p>
                    <div class="social-icons" id="footerSocials"></div>
                </div>
                
                <div class="footer-links">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="#home" onclick="navigateTo('home')">Home</a></li>
                        <li><a href="#shop" onclick="navigateTo('home')">Shop</a></li>
                        <li><a href="#offers" onclick="navigateTo('home')">Offers</a></li>
                        <li><a href="#contact" onclick="navigateTo('home')">Contact</a></li>
                    </ul>
                </div>
                
                <div class="footer-contact">
                    <h3>Contact Info</h3>
                    <p><i class="fas fa-map-marker-alt"></i> <span id="footerAddress"></span></p>
                    <p><i class="fas fa-phone"></i> <span id="footerPhone"></span></p>
                    <p><i class="fas fa-envelope"></i> <span id="footerEmail"></span></p>
                </div>
            </div>
            <div class="copyright">
                <p id="footerCopyright"></p>
            </div>
        </div>
    </footer>

    <!-- Cart Sidebar -->
    <div class="cart-overlay" id="cartOverlay">
        <div class="cart-header">
            <h2>Your Cart</h2>
            <button class="close-cart" id="closeCart">&times;</button>
        </div>
        <div class="cart-items" id="cartItems">
            <p class="empty-cart-message" id="emptyCartMessage">Your cart is empty</p>
        </div>
        <div class="cart-footer">
            <div class="cart-total">
                <span>Total:</span>
                <span id="cartTotalPrice">৳0.00</span>
            </div>
            <button class="btn btn-primary btn-block" id="checkoutBtn" style="width: 100%;">Proceed to Checkout</button>
        </div>
    </div>
    
    <div id="lightbox" class="lightbox">
      <span class="close-lightbox" id="closeLightbox">&times;</span>
      <img class="lightbox-content" id="lightboxImg">
    </div>

    <div class="options-panel-overlay" id="optionsPanelOverlay">
        <div class="options-panel" id="optionsPanel">
            <div class="options-panel-header">
                <div class="options-panel-product-info" id="panelProductInfo">
                    <img src="" alt="product">
                    <div>
                        <h4>Product Name</h4>
                        <span class="current-price">৳0.00</span>
                    </div>
                </div>
                <button class="options-panel-close" id="optionsPanelClose">&times;</button>
            </div>
            <div class="options-panel-body">
                <div id="panelVariantSelectors"></div>
                <div class="quantity-selector" id="panelQuantitySelector">
                    <h4>Quantity:</h4>
                    <div>
                        <button class="qty-btn" id="panelDecQty">-</button>
                        <input type="number" class="qty-input" id="panelQty" value="1" min="1">
                        <button class="qty-btn" id="panelIncQty">+</button>
                    </div>
                </div>
            </div>
            <div class="options-panel-actions">
                <button class="btn btn-primary" id="panelConfirmBtn">Confirm</button>
            </div>
        </div>
    </div>
    
    <div class="custom-alert-overlay" id="customAlert">
        <div class="custom-alert-box">
            <h3 id="customAlertTitle">Alert</h3>
            <p id="customAlertMessage">Message goes here.</p>
            <div class="custom-alert-actions">
                <button class="btn btn-outline" id="customAlertCancel">Cancel</button>
                <button class="btn btn-primary" id="customAlertOk">OK</button>
            </div>
        </div>
    </div>

    <div class="welcome-overlay" id="welcomeOverlay">
        <div class="welcome-box">
            <div style="position: relative; text-align: center; max-width: 90vw;">
                <img id="welcomeLogo" src="" alt="Promo" style="max-width: 100%; max-height: 70vh; border-radius: 12px; object-fit: contain;">
                <button class="btn btn-primary" id="welcomeActionBtn" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); border-radius: 30px; padding: 10px 40px; font-weight: bold; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3); white-space: nowrap;">Shop Now</button>
            </div>
            <button class="ad-close-btn" id="closeWelcomeOverlay" style="position: static; margin-top: 20px; background: transparent; border: 2px solid white; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; padding: 0; color: white;">
                <i class="fas fa-times" style="font-size: 22px;"></i>
            </button>
            <div id="adCountdown" style="color: white; margin-top: 10px; font-size: 14px; text-align: center;">Auto close in 5s</div>
        </div>
    </div>

    <div class="promo-popup" id="promoPopup">
        <div class="promo-popup-discount" id="promoPopupDiscount">20%<br>OFF</div>
        <button class="promo-popup-close" id="promoPopupClose">&times;</button>
        <img src="" alt="Promo Product" class="promo-popup-img" id="promoPopupImg">
        <div class="promo-popup-content">
            <h4 id="promoPopupName">Product Title (20 character Max)</h4>
            <div class="price">
                <span class="current-price" id="promoPopupPrice">0.00 ৳</span>
                <span class="original-price" id="promoPopupOldPrice">0.00 ৳</span>
            </div>
            <button class="btn" id="promoPopupAction">Buy Now</button>
        </div>
    </div>

    <div class="order-details-overlay" id="orderDetailsOverlay">
        <div class="order-details-modal">
            <div class="od-header">
                <h3>Order Details</h3>
                <button id="closeOrderDetails">&times;</button>
            </div>
            <div class="od-section" id="odBody" style="border-bottom: 8px solid #f5f5f5;"></div>
            <div class="od-section" style="border-bottom: 8px solid #f5f5f5;">
                <h4 style="margin-bottom: 15px; font-size: 1rem;">Order Summary</h4>
                <div class="od-row"><span>Subtotal</span><span id="odSubtotal"></span></div>
                <div class="od-row"><span>Shipping Fee</span><span id="odShipping"></span></div>
                <div class="od-row"><span>COD Handling Fee</span><span id="odCOD"></span></div>
                <div class="od-total od-row"><span style="color:#333;">Total</span><span id="odTotal"></span></div>
            </div>
            <div class="od-section" style="border-bottom: 8px solid #f5f5f5;">
                <h4 style="margin-bottom: 10px; font-size: 1rem;">Paid by</h4>
                <div class="od-row"><span id="odPaidMethodName">Cash on Delivery</span><span id="odPaidAmount"></span></div>
            </div>
            <div class="od-section od-meta-section">
                <div class="od-row"><span>Order No.</span><span><span id="odOrderNo" style="color:#333;font-weight:600;"></span> <a href="#" id="odCopy" style="color:var(--primary);text-decoration:none;margin-left:5px;font-weight:600;">Copy</a></span></div>
                <div class="od-row"><span>Placed on</span><span id="odDate" style="color:#333;"></span></div>
                <div class="od-row"><span>Paid by</span><span id="odPaymentMethod" style="color:#333;"></span></div>
            </div>
            <div class="od-actions">
                <button class="btn btn-primary" id="odContinueShopping" style="width: 100%;">Continue Shopping</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD5p-7Cgep9aGf6omMXDH8LOTy0C76jJaQ",
            authDomain: "e-commerce-shop-24.firebaseapp.com",
            projectId: "e-commerce-shop-24",
            storageBucket: "e-commerce-shop-24.firebasestorage.app",
            messagingSenderId: "1000897291264",
            appId: "1:1000897291264:web:4f1e78554c3e69d310a4e5",
            measurementId: "G-MCFXRFDFT5"
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        let products = [];
        let heroSlidesData = [];
        let cart =[];
        let currentProduct = null;
        let imageSliderInterval = null;
        let selectedVariant = null;
        let actionToConfirm = null; 
        let isLoggedIn = false;
        let currentUser = null;
        let savedAddresses = [];
        let currentlyDisplayedProducts =[];
        let lastSearchTerm = '';
        let paymentGateways =[];

        const productGrid = document.getElementById('productGrid');
        const cartIcon = document.getElementById('cartIcon');
        const cartOverlay = document.getElementById('cartOverlay');
        const closeCart = document.getElementById('closeCart');
        const cartItems = document.getElementById('cartItems');
        const emptyCartMessage = document.getElementById('emptyCartMessage');
        const cartTotalPrice = document.getElementById('cartTotalPrice');
        const cartCount = document.querySelector('.cart-count');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const checkoutForm = document.getElementById('checkoutForm');
        const menuToggle = document.getElementById('menuToggle');
        const mobileMenu = document.getElementById('mobileMenu');
        const shopNowBtn = document.querySelector('.btn-shop');
        const heroBg = document.getElementById('heroBg');

        const detailMainImg = document.getElementById('detailMainImg');
        const detailThumbnails = document.getElementById('detailThumbnails');
        const detailName = document.getElementById('detailName');
        const detailPrice = document.getElementById('detailPrice');
        const detailOldPrice = document.getElementById('detailOldPrice');
        const detailDesc = document.getElementById('detailDesc');
        const detailRating = document.getElementById('detailRating');
        const detailVariantSelectors = document.getElementById('detailVariantSelectors');
        const detailQty = document.getElementById('detailQty');
        const detailIncQty = document.getElementById('detailIncQty');
        const detailDecQty = document.getElementById('detailDecQty');
        const detailAddToCartSticky = document.getElementById('detailAddToCartSticky');
        const detailBuyNowSticky = document.getElementById('detailBuyNowSticky');
        
        const optionsPanelOverlay = document.getElementById('optionsPanelOverlay');
        const optionsPanel = document.getElementById('optionsPanel');
        const optionsPanelClose = document.getElementById('optionsPanelClose');
        const panelProductInfo = document.getElementById('panelProductInfo');
        const panelVariantSelectors = document.getElementById('panelVariantSelectors');
        const panelQty = document.getElementById('panelQty');
        const panelIncQty = document.getElementById('panelIncQty');
        const panelDecQty = document.getElementById('panelDecQty');
        const panelConfirmBtn = document.getElementById('panelConfirmBtn');
        
        const allPages = document.querySelectorAll('.page-section');
        const searchResultsGrid = document.getElementById('searchResultsGrid');
        const searchResultsTitle = document.getElementById('searchResultsTitle');
        const searchPageForm = document.getElementById('searchPageForm');
        const searchPageInput = document.getElementById('searchPageInput');
        const keywordSuggestions = document.getElementById('keywordSuggestions');
        const searchSuggestionsList = document.getElementById('search-suggestions-list');
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightboxImg');
        const closeLightbox = document.getElementById('closeLightbox');
        const progressBar = document.getElementById('progressBar');
        const customAlert = document.getElementById('customAlert');
        const welcomeOverlay = document.getElementById('welcomeOverlay');
        const promoPopup = document.getElementById('promoPopup');

        async function loadInitialData() {
            try {
                const settingsSnap = await db.collection('settings').doc('general').get();
                if(settingsSnap.exists) {
                    const data = settingsSnap.data();
                    document.getElementById('pageTitle').textContent = data.siteName || 'Online Shop';
                    document.getElementById('headerLogo').src = data.logoUrl || '';
                    document.getElementById('footerLogo').src = data.logoUrl || '';
                    document.getElementById('heroTitle').textContent = data.heroTitle || '';
                    document.getElementById('heroDesc').textContent = data.heroDesc || '';
                    document.getElementById('offerTitle').textContent = data.offerTitle || '';
                    document.getElementById('offerSubtitle').textContent = data.offerSubtitle || '';
                    document.getElementById('offerDesc').textContent = data.offerDesc || '';
                    document.getElementById('deliveryInsideTk').textContent = `৳${data.deliveryInside || 0}`;
                    document.getElementById('deliveryOutsideTk').textContent = `৳${data.deliveryOutside || 0}`;
                    document.getElementById('footerAboutText').textContent = data.footerAbout || '';
                    document.getElementById('footerAddress').textContent = data.footerAddress || '';
                    document.getElementById('footerPhone').textContent = data.footerPhone || '';
                    document.getElementById('footerEmail').textContent = data.footerEmail || '';
                    document.getElementById('footerCopyright').innerHTML = data.footerCopyright || '';
                }

                const popupSnap = await db.collection('popups').where('section', '==', 'opening').get();
                if(!popupSnap.empty) {
                    const popupData = popupSnap.docs[0].data();
                    const welcomeLogo = document.getElementById('welcomeLogo');
                    welcomeLogo.src = popupData.bannerLogo || '';
                    
                    if(popupData.actionButton) {
                        const actionBtn = document.getElementById('welcomeActionBtn');
                        actionBtn.style.display = 'block';
                        actionBtn.textContent = popupData.actionButtonName || 'Shop Now';
                        actionBtn.onclick = () => { 
                            if(popupData.actionButtonLink) window.location.href = popupData.actionButtonLink; 
                            document.getElementById('welcomeOverlay').classList.remove('active');
                        };
                    }
                } else {
                    document.getElementById('welcomeOverlay').style.display = 'none';
                }

                const catSnap = await db.collection('categories').get();
                const categoryGrid = document.getElementById('categoryGrid');
                categoryGrid.innerHTML = '';
                catSnap.forEach(doc => {
                    const cat = doc.data();
                    let iconHtml = '';
                    if (cat.mediaType === 'image' && cat.imageUrl) {
                         iconHtml = `<img src="${cat.imageUrl}" alt="${cat.name}">`;
                    } else {
                         iconHtml = `<div class="category-icon"><i class="${cat.iconClass || 'fas fa-box'}"></i></div>`;
                    }
                    
                    categoryGrid.innerHTML += `
                        <div class="category-card" data-category="${cat.slug}" title="Shop for ${cat.name}">
                            ${iconHtml}
                            <h3>${cat.name}</h3>
                        </div>
                    `;
                });

                const socialSnap = await db.collection('socials').get();
                const socialGrid = document.getElementById('footerSocials');
                socialGrid.innerHTML = '';
                socialSnap.forEach(doc => {
                    const social = doc.data();
                    socialGrid.innerHTML += `<a href="${social.url}" class="social-icon" target="_blank"><i class="${social.iconClass}"></i></a>`;
                });

                const slidesSnap = await db.collection('heroSlides').orderBy('order').get();
                heroSlidesData =[];
                slidesSnap.forEach(doc => { heroSlidesData.push(doc.data()); });

                const gatewaysSnap = await db.collection('paymentGateways').get();
                paymentGateways =[];
                gatewaysSnap.forEach(doc => {
                    paymentGateways.push({ id: doc.id, ...doc.data() });
                });

                const prodSnap = await db.collection('products').get();
                products =[];
                prodSnap.forEach(doc => {
                    const data = doc.data();
                    if(data.status !== 'Inactive') {
                        products.push({ id: doc.id, ...data });
                    }
                });
                currentlyDisplayedProducts = [...products];
            } catch(e) {
                console.error("Error loading data from Firebase: ", e);
            }
        }

        function init() {
            renderSkeletons(4, productGrid);
            setTimeout(() => {
                applyFilterAndRender(products, 'default', productGrid);
            }, 1500);
            
            setupEventListeners();
            startOfferTimer();
            updateCartCount();
            initHeroSlider();
            updateAuthStateUI();

            window.addEventListener('hashchange', handleRouteChange);
            handleRouteChange(true);
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    currentUser = { 
                        name: userDoc.exists ? userDoc.data().name : (user.displayName || 'User'), 
                        email: user.email, 
                        phone: userDoc.exists ? userDoc.data().phone : '' 
                    };
                    isLoggedIn = true;
                    updateAuthStateUI();
                    if(window.location.hash.includes('login') || window.location.hash.includes('register')){
                        navigateTo('profile');
                    }
                } else {
                    isLoggedIn = false;
                    currentUser = null;
                    updateAuthStateUI();
                }
            });
        }

        function simulatePageLoad(pageLoadFunction) {
            progressBar.style.opacity = '1';
            progressBar.style.width = '0%';
            setTimeout(() => { progressBar.style.width = '90%'; }, 10);
            setTimeout(() => {
                if (pageLoadFunction) pageLoadFunction();
                progressBar.style.width = '100%';
                setTimeout(() => {
                    progressBar.style.opacity = '0';
                    setTimeout(() => { progressBar.style.width = '0%'; }, 300);
                }, 400);
            }, 500); 
        }

        function handleRouteChange(isInitialLoad = false) {
            const path = window.location.hash.substring(1) || 'home';
            const[pageId, queryString] = path.split('?');
            const params = new URLSearchParams(queryString);

            const displayPageAndData = () => {
                let finalPageId = pageId;
                if (!isLoggedIn && (finalPageId === 'profile' || finalPageId === 'checkout')) {
                    finalPageId = 'login';
                }

                allPages.forEach(p => p.classList.remove('active'));
                const targetPage = document.getElementById(`${finalPageId}-page`);

                if (targetPage) {
                    targetPage.classList.add('active');
                } else {
                    document.getElementById('home-page').classList.add('active');
                }
                window.scrollTo(0, 0);

                if (imageSliderInterval) {
                    clearInterval(imageSliderInterval);
                    imageSliderInterval = null;
                }

                if (finalPageId === 'product-details' && params.has('id')) {
                    const productId = params.get('id');
                    if (productId) { openProductPage(productId); }
                } else if (finalPageId === 'profile') {
                    populateProfileData();
                } else if (finalPageId === 'checkout') {
                    populateSavedAddresses();
                    renderPaymentMethods();
                }
            };
            
            if (isInitialLoad === true) {
                displayPageAndData();
            } else {
                simulatePageLoad(displayPageAndData);
            }
        }
        
        function navigateTo(path) {
            const currentPath = window.location.hash.substring(1) || 'home';
            if (currentPath.split('?')[0] === path.split('?')[0]) {
                 handleRouteChange(); return;
            }
            window.location.hash = path;
        }

        function goBack() { history.back(); }
        
        function showCustomAlert(title, message, onOkCallback = null) {
            document.getElementById('customAlertTitle').textContent = title;
            document.getElementById('customAlertMessage').textContent = message;
            
            const okBtn = document.getElementById('customAlertOk');
            const cancelBtn = document.getElementById('customAlertCancel');
            
            cancelBtn.style.display = 'none';
            okBtn.textContent = 'OK';

            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);

            newOkBtn.addEventListener('click', () => {
                customAlert.classList.remove('active');
                if (onOkCallback) onOkCallback();
            });

            customAlert.classList.add('active');
        }

        function requireLogin(callback) {
            if (!isLoggedIn) {
                const title = "Login Required";
                const message = "You need to be logged in to perform this action.";
                const okBtn = document.getElementById('customAlertOk');
                const cancelBtn = document.getElementById('customAlertCancel');
                document.getElementById('customAlertTitle').textContent = title;
                document.getElementById('customAlertMessage').textContent = message;
                cancelBtn.style.display = 'inline-flex';
                okBtn.textContent = "Go to Login";
                const newOkBtn = okBtn.cloneNode(true);
                okBtn.parentNode.replaceChild(newOkBtn, okBtn);
                const newCancelBtn = cancelBtn.cloneNode(true);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

                newOkBtn.addEventListener('click', () => {
                    customAlert.classList.remove('active');
                    navigateTo('login');
                });
                newCancelBtn.addEventListener('click', () => {
                    customAlert.classList.remove('active');
                });
                customAlert.classList.add('active');
                return false;
            }
            if (callback) callback();
            return true;
        }

        function renderSkeletons(count, targetGrid) {
            targetGrid.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const skeletonCard = document.createElement('div');
                skeletonCard.className = 'skeleton-card';
                skeletonCard.innerHTML = `
                    <div class="skeleton-img"></div>
                    <div class="skeleton-info">
                        <div class="skeleton-line"></div>
                        <div class="skeleton-line short"></div>
                        <div class="skeleton-line" style="width: 80%;"></div>
                    </div>
                `;
                targetGrid.appendChild(skeletonCard);
            }
        }

        function showProfileSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(`profile-section-${sectionId}`).classList.add('active');
            document.querySelectorAll('#profileNav .nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`#profileNav .nav-item[onclick*="'${sectionId}'"]`).classList.add('active');
        }

        function updateAuthStateUI() {
            if (isLoggedIn) {
                document.body.classList.add('user-logged-in');
                document.getElementById('menuProfileSection').style.display = 'block';
                document.getElementById('menuProfileName').textContent = currentUser?.name || 'User';
            } else {
                document.body.classList.remove('user-logged-in');
                document.getElementById('menuProfileSection').style.display = 'none';
            }
        }

        async function logout() {
            try {
                await auth.signOut();
                isLoggedIn = false;
                currentUser = null;
                updateAuthStateUI();
                navigateTo('home');
                showNotification("You have been logged out.");
            } catch(e) {
                console.error("Logout Error:", e);
            }
        }

        function populateProfileData() {
            if (currentUser) {
                document.getElementById('profileNameDisplay').textContent = currentUser.name;
                document.getElementById('profileEmailDisplay').textContent = currentUser.email;
                document.getElementById('profileName').value = currentUser.name;
                document.getElementById('profileEmail').value = currentUser.email;
                document.getElementById('profilePhone').value = currentUser.phone;
                fetchUserOrders();
            }
        }
        
        async function fetchUserOrders() {
            if (!isLoggedIn || !currentUser) return;
            const ordersContainer = document.getElementById('userOrdersList');
            ordersContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--gray);"><i class="fas fa-spinner fa-spin fa-3x"></i><p style="margin-top: 15px;">Loading your orders...</p></div>';
            
            try {
                const snap = await db.collection('orders').where('userId', '==', auth.currentUser.uid).get();
                if (snap.empty) {
                    ordersContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--gray);">
                            <i class="fas fa-receipt fa-3x"></i>
                            <p style="margin-top: 15px;">You have no active orders.</p>
                        </div>`;
                    return;
                }
                
                let ordersHtml = '';
                snap.forEach(doc => {
                    const order = doc.data();
                    let itemsHtml = '';
                    if (order.cartItems && order.cartItems.length > 0) {
                        order.cartItems.forEach(item => {
                            let vStr = '';
                            if (item.color && item.color !== 'N/A') vStr += item.color;
                            if (item.size && item.size !== 'N/A') vStr += (vStr ? ', ' : '') + item.size;
                            if (vStr) vStr = ` <span style="font-size:0.8rem; color:var(--gray)">(${vStr})</span>`;
                            
                            itemsHtml += `
                                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:10px;">
                                    <img src="${item.image}" style="width:50px; height:50px; object-fit:cover; border-radius:4px;">
                                    <div style="flex:1;">
                                        <div style="font-weight:500; font-size:0.95rem;">${item.name}${vStr}</div>
                                        <div style="font-size:0.85rem; color:var(--gray);">Qty: ${item.qty} | ৳${item.price}</div>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    
                    ordersHtml += `
                        <div style="border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: left; background: #fff;">
                            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px;">
                                <div>
                                    <span style="font-weight:600;">Order #${order.id.substring(0,8)}</span><br>
                                    <span style="font-size:0.85rem; color:var(--gray);">${order.date}</span>
                                </div>
                                <div style="text-align: right;">
                                    <span style="display:inline-block; padding:3px 10px; border-radius:12px; font-size:0.8rem; font-weight:600; background:#eef2ff; color:var(--primary);">${order.status || 'Pending'}</span>
                                </div>
                            </div>
                            ${itemsHtml}
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                                <div style="font-weight:600; color:var(--primary);">Total: ৳${order.amount}</div>
                                <button class="btn btn-outline" style="padding: 5px 15px; font-size: 0.85rem;" onclick="showOrderTracking('${order.id}', '${order.status || 'Pending'}')">Track Order</button>
                            </div>
                        </div>
                    `;
                });
                ordersContainer.innerHTML = ordersHtml;
            } catch (e) {
                console.error("Error fetching orders:", e);
                ordersContainer.innerHTML = '<p>Error loading orders.</p>';
            }
        }

        function showOrderTracking(orderId, status) {
            showCustomAlert('Tracking Info', `Order #${orderId.substring(0,8)} is currently: ${status}. We will notify you upon further updates.`);
        }
        
        function toggleMenu() {
            menuToggle.classList.toggle('active');
            mobileMenu.classList.toggle('active');
        }

        function initHeroSlider() {
            let currentSlideIndex = 0;
            heroBg.innerHTML = '';
            heroSlidesData.forEach((slide, index) => {
                const slideEl = document.createElement('div');
                slideEl.className = `hero-slide ${index === 0 ? 'active' : ''}`;
                if (slide.type === 'image') {
                    const img = document.createElement('img');
                    img.src = slide.src;
                    slideEl.appendChild(img);
                } else if (slide.type === 'iframe') {
                    const iframe = document.createElement('iframe');
                    iframe.src = slide.src;
                    iframe.allow = "autoplay; encrypted-media";
                    slideEl.appendChild(iframe);
                }
                heroBg.appendChild(slideEl);
            });
            const slides = document.querySelectorAll('.hero-slide');
            if(slides.length <= 1) return;
            function showNextSlide() {
                slides[currentSlideIndex].classList.remove('active');
                currentSlideIndex = (currentSlideIndex + 1) % slides.length;
                slides[currentSlideIndex].classList.add('active');
                const delay = heroSlidesData[currentSlideIndex].type === 'iframe' ? 15000 : 3000;
                setTimeout(showNextSlide, delay);
            }
            setTimeout(showNextSlide, 3000);
        }
        
        function renderProducts(productsToRender, targetGrid) {
            targetGrid.innerHTML = '';
            if (productsToRender.length === 0) {
                targetGrid.innerHTML = '<p>No products found.</p>';
                return;
            }
            productsToRender.forEach(product => {
                const isOutOfStock = product.status === 'Out of Stock' || product.stock <= 0;
                
                const productCard = document.createElement('div');
                productCard.className = 'product-card' + (isOutOfStock ? ' out-of-stock' : '');
                productCard.dataset.id = product.id;
                const price = product.variants && product.variants.length > 0 ? product.variants[0].price : (product.price || 0);
                const discountBadge = product.discount ? `<div class="discount-badge">${product.discount}% OFF</div>` : '';
                const watermark = isOutOfStock ? `<div class="out-of-stock-watermark">Out of Stock</div>` : '';
                const displayImg = (product.images && product.images.length > 0) ? product.images[0] : 'https://via.placeholder.com/200';

                productCard.innerHTML = `
                    <div class="product-img"><img src="${displayImg}" alt="${product.name}">${discountBadge}${watermark}</div>
                    <div class="product-info">
                        <h3>${product.name}</h3>
                        <div class="price">
                            <span class="current-price">৳${price.toFixed(2)}</span>
                            <span class="original-price">৳${product.originalPrice ? product.originalPrice.toFixed(2) : '0.00'}</span>
                        </div>
                        <div class="rating">${getStarRating(product.rating || 5)}<span>(${product.rating || 5})</span></div>
                        <button class="btn btn-primary add-to-cart-btn" style="width:100%" ${isOutOfStock ? 'disabled' : ''}>${isOutOfStock ? 'Out of Stock' : ((product.variants && product.variants.length > 0) ? 'Select Options' : 'Add to Cart')}</button>
                    </div>`;
                
                if(!isOutOfStock) {
                    productCard.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('add-to-cart-btn')) {
                           navigateTo(`product-details?id=${product.id}`);
                        }
                    });

                    const actionBtn = productCard.querySelector('.add-to-cart-btn');
                    actionBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        requireLogin(() => {
                            if (product.variants && product.variants.length > 0) {
                               navigateTo(`product-details?id=${product.id}`);
                            } else {
                                addToCart(product.id, 1, null);
                            }
                        });
                    });
                }
                targetGrid.appendChild(productCard);
            });
        }

        // [Change 4] Updated renderSuggestedProducts logic
        function renderSuggestedProducts(currentProd) {
            const grid = document.getElementById('suggestedProductsGrid');
            grid.innerHTML = '';
            
            const currentNameWords = currentProd.name.toLowerCase().split(' ');

            const suggested = products.filter(p => {
                if (p.id == currentProd.id) return false;

                // Name Match (matching parts of the name)
                const nameMatch = currentNameWords.some(word => word.length > 3 && p.name.toLowerCase().includes(word));
                // Keyword Match
                const keywordMatch = p.keywords && currentProd.keywords && p.keywords.some(k => currentProd.keywords.includes(k));
                // Category Match
                const categoryMatch = p.category && currentProd.category && p.category === currentProd.category;

                return nameMatch || keywordMatch || categoryMatch;
            }).slice(0, 4); 

            if (suggested.length === 0) {
                document.querySelector('.suggested-products-section').style.display = 'none';
                return;
            }
            document.querySelector('.suggested-products-section').style.display = 'block';
            suggested.forEach(product => {
                const card = document.createElement('div');
                card.className = 'suggested-product-card';
                card.dataset.id = product.id;
                const price = product.variants && product.variants.length > 0 ? product.variants[0].price : (product.price || 0);
                const displayImg = (product.images && product.images.length > 0) ? product.images[0] : 'https://via.placeholder.com/200';
                card.innerHTML = `
                    <div class="suggested-product-img">
                        <img src="${displayImg}" alt="${product.name}">
                    </div>
                    <div class="suggested-product-info">
                        <h4>${product.name}</h4>
                        <div class="price">
                            <span class="current-price">৳${price.toFixed(2)}</span>
                        </div>
                    </div>
                `;
                card.addEventListener('click', () => {
                    navigateTo(`product-details?id=${product.id}`);
                });
                grid.appendChild(card);
            });
        }

        function getStarRating(rating) {
            let stars = '';
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;
            for (let i = 0; i < fullStars; i++) stars += '<i class="fas fa-star"></i>';
            if (halfStar) stars += '<i class="fas fa-star-half-alt"></i>';
            const emptyStars = 5 - Math.ceil(rating);
            for (let i = 0; i < emptyStars; i++) stars += '<i class="far fa-star"></i>';
            return stars;
        }

        function openProductPage(productId) {
            currentProduct = products.find(p => p.id == productId);
            if (!currentProduct) {
                navigateTo('home');
                return;
            }
            selectedVariant = null;
            
            detailName.textContent = currentProduct.name;
            const price = currentProduct.variants && currentProduct.variants.length > 0 ? currentProduct.variants[0].price : (currentProduct.price || 0);
            detailPrice.textContent = `৳${price.toFixed(2)}`;
            detailOldPrice.textContent = `৳${currentProduct.originalPrice ? currentProduct.originalPrice.toFixed(2) : '0.00'}`;
            detailDesc.textContent = currentProduct.description;
            detailRating.innerHTML = `${getStarRating(currentProduct.rating || 5)} <span>(${currentProduct.rating || 5})</span>`;
            detailQty.value = 1;
            detailQty.max = currentProduct.stock || 1;
            document.getElementById('detailStockStatus').textContent = `(Stock: ${currentProduct.stock || 0})`;
            
            const gatewaysContainer = document.getElementById('detailPaymentGateways');
            gatewaysContainer.innerHTML = '';
            if (currentProduct.allowedGateways && currentProduct.allowedGateways.length > 0) {
                let gatewayHtml = '<span style="font-size: 0.9rem; color: var(--dark); font-weight: 600; margin-right: 5px;">Payment Options:</span>';
                currentProduct.allowedGateways.forEach(gwId => {
                    if (gwId === 'COD') {
                        gatewayHtml += `<div title="Cash on Delivery" style="height: 28px; padding: 0 10px; border: 1px solid #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; font-size: 11px; font-weight: 700; color: var(--primary);">COD</div>`;
                    } else {
                        const gw = paymentGateways.find(g => g.id === gwId);
                        if (gw && gw.logo) {
                            gatewayHtml += `<img src="${gw.logo}" alt="${gw.name}" title="${gw.name}" style="height: 28px; width: auto; object-fit: contain; border: 1px solid #ddd; border-radius: 4px; padding: 2px; background: white;">`;
                        }
                    }
                });
                gatewaysContainer.innerHTML = gatewayHtml;
            }
            
            detailMainImg.src = currentProduct.images[0];
            detailThumbnails.innerHTML = '';
            
            currentProduct.images.forEach((imgSrc, index) => {
                const thumb = document.createElement('img');
                thumb.src = imgSrc;
                thumb.className = `thumbnail ${index === 0 ? 'active' : ''}`;
                thumb.onclick = () => {
                    if (imageSliderInterval) clearInterval(imageSliderInterval);
                    detailMainImg.src = imgSrc;
                    document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
                    thumb.classList.add('active');
                };
                detailThumbnails.appendChild(thumb);
            });
            
            renderVariantSelectors(currentProduct, detailVariantSelectors);
            renderSuggestedProducts(currentProduct);
            
            let currentImageIndex = 0;
            const thumbnails = detailThumbnails.querySelectorAll('.thumbnail');
            if (imageSliderInterval) clearInterval(imageSliderInterval);
            if(currentProduct.images.length > 1) {
                imageSliderInterval = setInterval(() => {
                    currentImageIndex = (currentImageIndex + 1) % currentProduct.images.length;
                    detailMainImg.src = currentProduct.images[currentImageIndex];
                    thumbnails.forEach(t => t.classList.remove('active'));
                    if(thumbnails[currentImageIndex]) thumbnails[currentImageIndex].classList.add('active');
                }, 3000);
            }
        }
        
        function renderVariantSelectors(product, container) {
            container.innerHTML = '';
            if (!product.variants || product.variants.length === 0) return;

            const colors = [...new Set(product.variants.map(v => v.color).filter(c => c && c !== 'N/A'))];
            const sizes = [...new Set(product.variants.map(v => v.size).filter(s => s && s !== 'N/A'))];

            if (colors.length > 0) {
                const colorOpts = colors.map(c => {
                    const variantWithImg = product.variants.find(v => v.color === c && v.image);
                    return { value: c, image: variantWithImg ? variantWithImg.image : null };
                });
                container.innerHTML += createSelectorHTML('Color', colorOpts, 'color');
            }
            if (sizes.length > 0) {
                const sizeOpts = sizes.map(s => {
                    const variantWithImg = product.variants.find(v => v.size === s && v.image);
                    return { value: s, image: variantWithImg ? variantWithImg.image : null };
                });
                container.innerHTML += createSelectorHTML('Size', sizeOpts, 'size');
            }

            attachVariantListeners(container);
        }

        function createSelectorHTML(title, options, type) {
            let optionsHTML = '';
            options.forEach(opt => {
                if(opt && opt.value) {
                    const imgTag = opt.image ? `<img src="${opt.image}" class="variant-img" alt="${opt.value}">` : '';
                    optionsHTML += `<div class="variant-option ${type}-option" data-value="${opt.value}">${imgTag}<span>${opt.value}</span></div>`;
                } else if(typeof opt === 'string' && opt) {
                    optionsHTML += `<div class="variant-option ${type}-option" data-value="${opt}"><span>${opt}</span></div>`;
                }
            });
            if(optionsHTML === '') return '';
            return `
                <div class="variant-selector">
                    <h4>${title}:</h4>
                    <div class="variant-options">${optionsHTML}</div>
                </div>`;
        }
        
        let currentSelections = { color: null, size: null };

        function attachVariantListeners(container) {
            const colorOptions = container.querySelectorAll('.color-option');
            const sizeOptions = container.querySelectorAll('.size-option');

            colorOptions.forEach(opt => opt.addEventListener('click', () => handleVariantSelection(colorOptions, opt, 'color')));
            sizeOptions.forEach(opt => opt.addEventListener('click', () => handleVariantSelection(sizeOptions, opt, 'size')));
            
            currentSelections = { color: null, size: null };
            selectedVariant = null;
        }
        
        function handleVariantSelection(options, selectedOption, type) {
            const value = selectedOption.dataset.value;
            
            if (selectedOption.classList.contains('selected')) {
                selectedOption.classList.remove('selected');
                currentSelections[type] = null;
            } else {
                options.forEach(o => o.classList.remove('selected'));
                selectedOption.classList.add('selected');
                currentSelections[type] = value;
            }
            
            const variant = currentProduct.variants.find(v => {
                 const colorMatch = currentSelections.color ? v.color === currentSelections.color : true;
                 const sizeMatch = currentSelections.size ? v.size === currentSelections.size : true;
                 const hasColor = v.color && v.color !== 'N/A';
                 const hasSize = v.size && v.size !== 'N/A';
                 
                 if (currentSelections.color && !currentSelections.size && hasSize) return false;
                 if (!currentSelections.color && currentSelections.size && hasColor) return false;

                 return colorMatch && sizeMatch;
            });

            if (variant) {
                selectedVariant = variant;
                const price = `৳${variant.price.toFixed(2)}`;
                detailPrice.textContent = price;
                if(panelProductInfo) panelProductInfo.querySelector('.current-price').textContent = price;
                if(variant.image) {
                     detailMainImg.src = variant.image;
                     if(imageSliderInterval) clearInterval(imageSliderInterval);
                }
            } else {
                selectedVariant = null;
            }
        }
        
        function toggleOptionsPanel(show) {
            if (show) {
                panelProductInfo.querySelector('img').src = currentProduct.images[0];
                panelProductInfo.querySelector('h4').textContent = currentProduct.name;
                const price = selectedVariant ? selectedVariant.price : (currentProduct.variants.length > 0 ? currentProduct.variants[0].price : (currentProduct.price || 0));
                panelProductInfo.querySelector('.current-price').textContent = `৳${price.toFixed(2)}`;

                renderVariantSelectors(currentProduct, panelVariantSelectors);
                attachVariantListeners(panelVariantSelectors);
                panelQty.value = detailQty.value || 1;
                optionsPanelOverlay.classList.add('active');
                optionsPanel.classList.add('active');
            } else {
                optionsPanelOverlay.classList.remove('active');
                optionsPanel.classList.remove('active');
            }
        }

        function addToCart(productId, quantity, variant) {
            const product = products.find(p => p.id == productId);
            if (!product) return;
            
            const variantId = variant ? variant.variantId : 'no-variant';
            const cartId = `${productId}-${variantId}`;
            
            const existingItem = cart.find(item => item.cartId === cartId);
            
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                const itemPrice = variant ? variant.price : (product.price || 0);
                let itemName = product.name;
                if(variant) {
                   if(variant.color && variant.color !== 'N/A' && variant.size && variant.size !== 'N/A') {
                       itemName = `${product.name} (${variant.color}, ${variant.size})`;
                   } else if (variant.color && variant.color !== 'N/A') {
                       itemName = `${product.name} (${variant.color})`;
                   } else if (variant.size && variant.size !== 'N/A') {
                       itemName = `${product.name} (${variant.size})`;
                   }
                }

                cart.push({ 
                    id: product.id,
                    pid: product.pid,
                    cartId: cartId,
                    name: itemName, 
                    price: itemPrice, 
                    image: (variant && variant.image) ? variant.image : product.images[0], 
                    quantity: quantity,
                    variant: variant,
                    selected: true,
                    color: variant ? variant.color : 'N/A',
                    size: variant ? variant.size : 'N/A'
                });
            }
            
            updateCartCount();
            renderCartItems();
            showNotification(`${product.name} added to cart!`);
        }

        function removeFromCart(cartId) {
            cart = cart.filter(item => item.cartId !== cartId);
            updateCartCount();
            renderCartItems();
        }

        function updateCartItemQuantity(cartId, quantity) {
            const item = cart.find(item => item.cartId === cartId);
            if (quantity < 1) {
                removeFromCart(cartId);
                return;
            }
            if (item) {
                item.quantity = quantity;
                updateCartCount();
                renderCartItems();
            }
        }

        function renderCartItems() {
            cartItems.innerHTML = '';
            if (cart.length === 0) {
                emptyCartMessage.style.display = 'block';
                cartTotalPrice.textContent = '৳0.00';
                checkoutBtn.disabled = true;
                return;
            }
            
            emptyCartMessage.style.display = 'none';
            checkoutBtn.disabled = false;
            let total = 0;
            
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                if (item.selected) {
                    total += itemTotal;
                }

                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.dataset.id = item.id;
                cartItem.dataset.cartId = item.cartId;

                cartItem.innerHTML = `
                    <div class="cart-item-selector">
                        <input type="checkbox" class="cart-item-checkbox" ${item.selected ? 'checked' : ''}>
                    </div>
                    <div class="cart-item-details-link">
                        <div class="cart-item-img"><img src="${item.image}" alt="${item.name}"></div>
                        <div class="cart-item-info">
                            <h4>${item.name}</h4>
                            <div class="cart-item-price">৳${item.price.toFixed(2)}</div>
                        </div>
                    </div>
                    <div class="cart-item-actions">
                        <button class="qty-btn decrease-item">-</button>
                        <input type="number" class="cart-item-qty" value="${item.quantity}" min="1">
                        <button class="qty-btn increase-item">+</button>
                        <button class="remove-item"><i class="fas fa-trash"></i></button>
                    </div>`;
                cartItems.appendChild(cartItem);
            });
            
            cartTotalPrice.textContent = `৳${total.toFixed(2)}`;
            attachCartItemListeners();
        }

        function attachCartItemListeners() {
            document.querySelectorAll('.cart-item-details-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    const id = this.closest('.cart-item').dataset.id;
                    navigateTo(`product-details?id=${id}`);
                    cartOverlay.classList.remove('active');
                });
            });
            document.querySelectorAll('.decrease-item').forEach(btn => btn.addEventListener('click', function() {
                const cartId = this.closest('.cart-item').dataset.cartId;
                const item = cart.find(i => i.cartId === cartId);
                if(item) updateCartItemQuantity(cartId, item.quantity - 1);
            }));
            document.querySelectorAll('.increase-item').forEach(btn => btn.addEventListener('click', function() {
                const cartId = this.closest('.cart-item').dataset.cartId;
                const item = cart.find(i => i.cartId === cartId);
                if(item) updateCartItemQuantity(cartId, item.quantity + 1);
            }));
            document.querySelectorAll('.remove-item').forEach(btn => btn.addEventListener('click', function() {
                const cartId = this.closest('.cart-item').dataset.cartId;
                removeFromCart(cartId);
            }));
            document.querySelectorAll('.cart-item-checkbox').forEach(box => {
                box.addEventListener('change', function() {
                    const cartId = this.closest('.cart-item').dataset.cartId;
                    const item = cart.find(i => i.cartId === cartId);
                    if (item) {
                        item.selected = this.checked;
                        renderCartItems(); 
                    }
                });
            });
        }

        function updateCartCount() {
            const count = cart.length; 
            if (count > 0) {
                cartCount.textContent = count;
                cartCount.style.display = 'flex';
            } else {
                cartCount.style.display = 'none';
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed; bottom: 20px; left: 50%;
                transform: translateX(-50%);
                background-color: var(--dark); color: white;
                padding: 12px 25px; border-radius: 25px;
                box-shadow: var(--shadow); z-index: 10000;
                animation: slideUp 0.5s ease;
            `;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => document.body.removeChild(notification), 500);
            }, 3000);
        }
        
        function handleSearch(e, searchTermFromChip) {
            e.preventDefault();
            const term = (searchTermFromChip || searchPageInput.value).trim().toLowerCase();
            lastSearchTerm = term;
            if (!term) return;
            
            navigateTo('search-results');
            searchResultsTitle.textContent = `Searching for "${term}"...`;
            renderSkeletons(8, searchResultsGrid);
            
            setTimeout(() => {
                const filteredProducts = products.filter(p => 
                    p.name.toLowerCase().includes(term) ||
                    (p.keywords && p.keywords.some(k => k.toLowerCase().includes(term)))
                );
                
                searchResultsTitle.textContent = `Results for "${term}"`;
                currentlyDisplayedProducts = [...filteredProducts];
                applyFilterAndRender(currentlyDisplayedProducts, 'default', searchResultsGrid);
                searchSuggestionsList.innerHTML = '';
            }, 1500);
        }

        function populateSavedAddresses() {
            const select = document.getElementById('savedAddresses');
            const selectorGroup = document.getElementById('addressSelectorGroup');
            const shippingForm = document.getElementById('shippingInfoForm');
            select.innerHTML = '';

            if (savedAddresses.length === 0) {
                selectorGroup.style.display = 'none';
                shippingForm.classList.remove('hidden');
                shippingForm.reset();
            } else {
                selectorGroup.style.display = 'flex';
                shippingForm.classList.remove('hidden');
                savedAddresses.forEach((addr, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = addr.address;
                    select.appendChild(option);
                });
                select.dispatchEvent(new Event('change'));
            }
        }
        
        // [Change 3] Javascript structure update for the new Gateway design
        function renderPaymentMethods() {
            const container = document.getElementById('checkoutPaymentMethods');
            container.innerHTML = '';
            
            // Add COD option
            const codDiv = document.createElement('div');
            codDiv.className = 'payment-method active'; // Default active
            codDiv.dataset.method = 'Cash on Delivery';
            codDiv.innerHTML = `<i class="fas fa-money-bill-wave fa-2x"></i><p>Cash on Delivery</p>`;
            codDiv.onclick = () => selectPaymentMethod(codDiv);
            container.appendChild(codDiv);

            // Add Dynamic Gateways from Admin
            paymentGateways.forEach(gw => {
                const gwDiv = document.createElement('div');
                gwDiv.className = 'payment-method';
                gwDiv.dataset.method = gw.name;
                gwDiv.innerHTML = `<img src="${gw.logo}" alt="${gw.name}"><p>${gw.name}</p>`;
                gwDiv.onclick = () => selectPaymentMethod(gwDiv);
                container.appendChild(gwDiv);
            });
        }
        
        function selectPaymentMethod(element) {
            document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
            element.classList.add('active');
        }

        function renderSavedAddressesList() {
            const listContainer = document.getElementById('savedAddressesList');
            listContainer.innerHTML = '';
            if (savedAddresses.length === 0) {
                listContainer.innerHTML = '<p>No saved addresses.</p>';
            } else {
                savedAddresses.forEach(addr => {
                    listContainer.innerHTML += `<div style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px;">${addr.address}</div>`;
                });
            }
        }
        
        function applyFilterAndRender(productsList, filter, targetGrid) {
            let sortedProducts = [...productsList];
            const getPrice = p => (p.variants && p.variants.length > 0) ? p.variants[0].price : (p.price || 0);

            switch(filter) {
                case 'price-asc': sortedProducts.sort((a, b) => getPrice(a) - getPrice(b)); break;
                case 'price-desc': sortedProducts.sort((a, b) => getPrice(b) - getPrice(a)); break;
                case 'top-selling': sortedProducts.sort((a, b) => (b.sales || 0) - (a.sales || 0)); break;
                case 'most-discount': sortedProducts.sort((a, b) => (b.discount || 0) - (a.discount || 0)); break;
                case 'default': default: break;
            }
            renderProducts(sortedProducts, targetGrid);
        }

        function showPromoPopup() {
            if(products.length === 0) return;
            const popupData = products[Math.floor(Math.random() * products.length)];
            const price = popupData.variants && popupData.variants.length > 0 ? popupData.variants[0].price : (popupData.price || 0);
            
            document.getElementById('promoPopupImg').src = popupData.images[0];
            
            let title = popupData.name;
            if (title.length > 20) {
                title = title.substring(0, 20) + '...';
            }
            document.getElementById('promoPopupName').textContent = title;
            document.getElementById('promoPopupPrice').textContent = `${price.toFixed(0)} ৳`;
            
            const originalPriceEl = document.getElementById('promoPopupOldPrice');
            const discountBadge = document.getElementById('promoPopupDiscount');

            if (popupData.originalPrice && popupData.originalPrice > price) {
                originalPriceEl.textContent = `${popupData.originalPrice.toFixed(0)} ৳`;
                originalPriceEl.style.display = 'inline-block';
                
                const discount = Math.round(((popupData.originalPrice - price) / popupData.originalPrice) * 100);
                if (discountBadge) {
                    discountBadge.innerHTML = `${discount}%<br>OFF`;
                    discountBadge.style.display = 'block';
                }
            } else {
                originalPriceEl.style.display = 'none';
                if (discountBadge) discountBadge.style.display = 'none';
            }
            
            const actionBtn = document.getElementById('promoPopupAction');
            actionBtn.onclick = () => {
                navigateTo(`product-details?id=${popupData.id}`);
                hidePromoPopup();
            };
            promoPopup.classList.add('visible');
        }

        function hidePromoPopup() {
            promoPopup.classList.remove('visible');
        }
        
        function showPromoPopupWithCheck() {
            const isAnyOverlayActive = document.querySelector('.cart-overlay.active, .options-panel-overlay.active, .custom-alert-overlay.active, .welcome-overlay.active, .order-details-overlay.active, .lightbox[style*="display: flex"]');
            if (!isAnyOverlayActive) {
                showPromoPopup();
            }
        }

        function setupEventListeners() {
            let adTimer;
            let timeLeft = 5;

            function closeAdBanner() {
                welcomeOverlay.classList.remove('active');
                clearInterval(adTimer);
                setTimeout(showPromoPopup, 8000);
                setInterval(showPromoPopupWithCheck, 120000);
            }

            document.getElementById('closeWelcomeOverlay').addEventListener('click', closeAdBanner);
            const welcomeLogoImg = document.getElementById('welcomeLogo');
            
            if (document.getElementById('welcomeOverlay').style.display !== 'none') {
                 timeLeft = 5;
                 document.getElementById('adCountdown').textContent = `Auto close in ${timeLeft}s`;
                 welcomeOverlay.classList.add('active'); 
                 adTimer = setInterval(() => {
                    timeLeft--;
                    document.getElementById('adCountdown').textContent = `Auto close in ${timeLeft}s`;
                    if (timeLeft <= 0) {
                        closeAdBanner();
                    }
                }, 1000);
            } else {
                 setTimeout(showPromoPopup, 8000);
                 setInterval(showPromoPopupWithCheck, 120000);
            }
            
            document.getElementById('promoPopupClose').addEventListener('click', hidePromoPopup);
            cartIcon.addEventListener('click', () => cartOverlay.classList.add('active'));
            closeCart.addEventListener('click', () => cartOverlay.classList.remove('active'));
            
            detailDecQty.addEventListener('click', () => { if (detailQty.value > 1) detailQty.value--; });
            detailIncQty.addEventListener('click', () => { 
                const maxStock = currentProduct ? (currentProduct.stock || 0) : Infinity;
                if (parseInt(detailQty.value) < maxStock) {
                    detailQty.value++; 
                } else {
                    showCustomAlert('Stock Limit', 'Cannot select more than available stock.');
                }
            });
            
            detailQty.addEventListener('change', () => {
                const maxStock = currentProduct ? (currentProduct.stock || 0) : 1;
                let val = parseInt(detailQty.value);
                if(isNaN(val) || val < 1) val = 1;
                if(val > maxStock) {
                    val = maxStock;
                    showCustomAlert('Stock Limit', 'Cannot select more than available stock.');
                }
                detailQty.value = val;
            });
            
            const handleAddToCart = () => {
                actionToConfirm = 'addToCart';
                if (!currentProduct.variants || currentProduct.variants.length === 0) {
                    addToCart(currentProduct.id, parseInt(detailQty.value), null);
                } else {
                    toggleOptionsPanel(true);
                }
            };

            const handleBuyNow = () => {
                actionToConfirm = 'buyNow';
                if (!currentProduct.variants || currentProduct.variants.length === 0) {
                    addToCart(currentProduct.id, parseInt(detailQty.value), null);
                    cartOverlay.classList.remove('active');
                    navigateTo('checkout');
                } else {
                    toggleOptionsPanel(true);
                }
            };

            detailAddToCartSticky.addEventListener('click', () => requireLogin(handleAddToCart));
            detailBuyNowSticky.addEventListener('click', () => requireLogin(handleBuyNow));
            
            optionsPanelClose.addEventListener('click', () => toggleOptionsPanel(false));
            optionsPanelOverlay.addEventListener('click', (e) => {
                if(e.target === optionsPanelOverlay) toggleOptionsPanel(false);
            });
            panelDecQty.addEventListener('click', () => { if (panelQty.value > 1) panelQty.value--; });
            panelIncQty.addEventListener('click', () => { panelQty.value++; });
            panelConfirmBtn.addEventListener('click', () => {
                requireLogin(() => {
                    if (currentProduct.variants.length > 0 && !selectedVariant) {
                        showCustomAlert('Selection Required', 'Please select all product options.');
                        return;
                    }
                    const qty = parseInt(panelQty.value);
                    if (actionToConfirm === 'addToCart') {
                        addToCart(currentProduct.id, qty, selectedVariant);
                    } else if (actionToConfirm === 'buyNow') {
                        addToCart(currentProduct.id, qty, selectedVariant);
                        cartOverlay.classList.remove('active');
                        navigateTo('checkout');
                    }
                    toggleOptionsPanel(false);
                });
            });
            
            checkoutBtn.addEventListener('click', () => {
                requireLogin(() => {
                     const selectedItems = cart.filter(item => item.selected);
                    if (selectedItems.length === 0) {
                        showCustomAlert('No Item Selected', 'Please select an item to checkout.');
                        return;
                    }
                    cartOverlay.classList.remove('active');
                    navigateTo('checkout');
                });
            });
            
            checkoutForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const saveAddress = document.getElementById('saveAddressCheck').checked;
                
                if (saveAddress) {
                    const newAddr = {
                        name: document.getElementById('name').value,
                        phone: document.getElementById('phone').value,
                        address: document.getElementById('address').value
                    };
                    if (!savedAddresses.some(a => a.address === newAddr.address)) {
                         savedAddresses.push(newAddr);
                    }
                }

                const selectedItems = cart.filter(item => item.selected);
                if (selectedItems.length === 0) { 
                    showCustomAlert('Cart Empty', 'Your cart is empty or no item is selected.'); 
                    return; 
                }
                
                const orderNo = Math.floor(Math.random() * 1000000000000) + 1000000000000;
                const dateObj = new Date();
                const date = dateObj.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) + ' ' + dateObj.toLocaleTimeString('en-GB', { hour12: false });
                
                const activePayment = document.querySelector('.payment-method.active');
                const paymentMethodText = activePayment ? activePayment.dataset.method : 'Cash on Delivery';
                
                let subtotal = 0;
                let itemsHtml = '';
                
                selectedItems.forEach(item => {
                    subtotal += item.price * item.quantity;
                    const variantText = (item.color!=='N/A' ? item.color : '') + (item.size!=='N/A' ? `, ${item.size}` : '');
                    itemsHtml += `
                        <div class="od-item">
                            <img src="${item.image}" alt="">
                            <div class="od-item-info">
                                <h4>${item.name}</h4>
                                ${variantText ? `<div class="od-item-variant">${variantText}</div>` : ''}
                                <div class="od-item-price-row">
                                    <span class="od-item-price">৳ ${item.price.toFixed(0)}</span>
                                    <span class="od-item-qty">Qty: ${item.quantity}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                const deliveryInside = parseFloat(document.getElementById('deliveryInsideTk').textContent.replace('৳','')) || 60;
                const shippingFee = deliveryInside; 
                const total = subtotal + shippingFee;

                if(isLoggedIn && currentUser) {
                     const orderData = {
                         id: orderNo.toString(),
                         customer: document.getElementById('name').value,
                         phone: document.getElementById('phone').value,
                         address: document.getElementById('address').value,
                         amount: total,
                         date: date,
                         status: 'Pending',
                         payment: paymentMethodText,
                         cartItems: selectedItems.map(i => ({
                             pid: i.pid || i.id,
                             name: i.name,
                             price: i.price,
                             qty: i.quantity,
                             color: i.color,
                             size: i.size,
                             image: i.image
                         })),
                         userId: auth.currentUser.uid
                     };
                     db.collection('orders').doc(orderNo.toString()).set(orderData);
                }
                
                document.getElementById('odBody').innerHTML = itemsHtml;
                document.getElementById('odSubtotal').textContent = `৳ ${subtotal.toFixed(0)}`;
                document.getElementById('odShipping').textContent = `৳ ${shippingFee}`;
                document.getElementById('odCOD').textContent = `৳ 0`;
                document.getElementById('odTotal').textContent = `৳ ${total.toFixed(0)}`;
                document.getElementById('odPaidAmount').textContent = `৳ ${total.toFixed(0)}`;
                document.getElementById('odPaidMethodName').textContent = paymentMethodText;
                document.getElementById('odOrderNo').textContent = orderNo;
                document.getElementById('odDate').textContent = date;
                document.getElementById('odPaymentMethod').textContent = paymentMethodText;
                
                document.getElementById('orderDetailsOverlay').classList.add('active');
                
                cart = cart.filter(item => !item.selected);
                updateCartCount();
                renderCartItems();
                this.reset();
            });

            document.getElementById('closeOrderDetails').addEventListener('click', () => {
                document.getElementById('orderDetailsOverlay').classList.remove('active');
                navigateTo('home');
            });
            document.getElementById('odContinueShopping').addEventListener('click', () => {
                document.getElementById('orderDetailsOverlay').classList.remove('active');
                navigateTo('home');
            });
            document.getElementById('odCopy').addEventListener('click', (e) => {
                e.preventDefault();
                navigator.clipboard.writeText(document.getElementById('odOrderNo').textContent);
                const orig = e.target.textContent;
                e.target.textContent = 'Copied!';
                setTimeout(() => e.target.textContent = orig, 2000);
            });

            document.getElementById('loginForm')?.addEventListener('submit', async (e) => { 
                e.preventDefault(); 
                const email = e.target.querySelector('input[type=email]').value;
                const password = e.target.querySelector('input[type=password]').value;
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    showCustomAlert('Login Successful', 'Welcome back!', () => navigateTo('profile')); 
                } catch(error) {
                    showCustomAlert('Login Failed', error.message);
                }
            });

            document.getElementById('registerForm')?.addEventListener('submit', async (e) => { 
                e.preventDefault(); 
                const name = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const phone = document.getElementById('registerPhone').value;
                const passwords = e.target.querySelectorAll('input[type=password]');
                const password = passwords[0].value;
                const confirmPassword = passwords[1].value;

                if (password !== confirmPassword) {
                    showCustomAlert('Error', 'Passwords do not match');
                    return;
                }
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await userCredential.user.updateProfile({ displayName: name });
                    await db.collection('users').doc(userCredential.user.uid).set({ name, email, phone });
                    showCustomAlert('Registration Successful', 'Your account has been created successfully.', () => navigateTo('profile')); 
                } catch(error) {
                    showCustomAlert('Registration Failed', error.message);
                }
            });

            document.querySelectorAll('.google-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const provider = new firebase.auth.GoogleAuthProvider();
                    try {
                        const result = await auth.signInWithPopup(provider);
                        const userDoc = await db.collection('users').doc(result.user.uid).get();
                        if (!userDoc.exists) {
                            await db.collection('users').doc(result.user.uid).set({
                                name: result.user.displayName,
                                email: result.user.email,
                                phone: ''
                            });
                        }
                        showCustomAlert('Login Successful', 'Welcome!', () => navigateTo('profile'));
                    } catch(error) {
                        showCustomAlert('Login Failed', error.message);
                    }
                });
            });
            
            document.getElementById('profileSetupForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                if(!auth.currentUser) return;
                const newName = document.getElementById('profileName').value;
                const newPhone = document.getElementById('profilePhone').value;
                try {
                    await auth.currentUser.updateProfile({ displayName: newName });
                    await db.collection('users').doc(auth.currentUser.uid).update({ name: newName, phone: newPhone });
                    currentUser.name = newName;
                    currentUser.phone = newPhone;
                    populateProfileData();
                    showNotification("Profile updated successfully!");
                } catch(error) {
                    showCustomAlert('Error', error.message);
                }
            });

            const savedAddressesSelect = document.getElementById('savedAddresses');
            const shippingInfoFormDiv = document.getElementById('shippingInfoForm');
            const addNewAddressBtn = document.getElementById('addNewAddressBtn');

            savedAddressesSelect.addEventListener('change', (e) => {
                const selectedAddress = savedAddresses[e.target.value];
                if (selectedAddress) {
                    document.getElementById('name').value = selectedAddress.name || (currentUser?.name || '');
                    document.getElementById('phone').value = selectedAddress.phone || (currentUser?.phone || '');
                    document.getElementById('address').value = selectedAddress.address;
                }
            });

            addNewAddressBtn.addEventListener('click', () => {
                savedAddressesSelect.value = "";
                shippingInfoFormDiv.reset();
                if(currentUser) {
                    document.getElementById('name').value = currentUser.name;
                    document.getElementById('phone').value = currentUser.phone;
                }
                document.getElementById('address').focus();
            });
            
            document.getElementById('newAddressForm').addEventListener('submit', e => {
                e.preventDefault();
                const newAddressValue = document.getElementById('newAddress').value.trim();
                if (newAddressValue) {
                    savedAddresses.push({ address: newAddressValue });
                    renderSavedAddressesList();
                    e.target.reset();
                }
            });

            ['homeFilterOptions', 'searchFilterOptions'].forEach(id => {
                 document.getElementById(id).addEventListener('click', e => {
                    if (e.target.tagName === 'BUTTON') {
                        const filter = e.target.dataset.filter;
                        document.querySelectorAll(`#${id} button`).forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                        const grid = id === 'homeFilterOptions' ? productGrid : searchResultsGrid;
                        const productSource = id === 'homeFilterOptions' ? products : currentlyDisplayedProducts;
                        applyFilterAndRender(productSource, filter, grid);
                    }
                });
            });
            
            document.querySelectorAll('.category-card').forEach(card => {
                card.addEventListener('click', () => {
                    const category = card.dataset.category;
                    navigateTo('home');
                    setTimeout(() => { 
                        const shopSection = document.getElementById('shop');
                        shopSection.scrollIntoView({ behavior: 'smooth' });
                        document.getElementById('shopTitle').textContent = `Products in: ${category.charAt(0).toUpperCase() + category.slice(1)}`;
                        currentlyDisplayedProducts = products.filter(p => p.category === category);
                        applyFilterAndRender(currentlyDisplayedProducts, 'default', productGrid);
                    }, 600);
                });
            });

            menuToggle.addEventListener('click', () => { menuToggle.classList.toggle('active'); mobileMenu.classList.toggle('active'); });
            cartOverlay.addEventListener('click', (e) => { if (e.target === cartOverlay) cartOverlay.classList.remove('active'); });
            shopNowBtn.addEventListener('click', () => { document.getElementById('shop').scrollIntoView({ behavior: 'smooth' }); });

            document.addEventListener('click', (e) => {
                if (mobileMenu.classList.contains('active') && !mobileMenu.contains(e.target) && !menuToggle.contains(e.target)) {
                    mobileMenu.classList.remove('active');
                    menuToggle.classList.remove('active');
                }
            });
            
            searchPageForm.addEventListener('submit', handleSearch);
            
            const searchClearBtn = document.getElementById('searchClearBtn');
            searchPageInput.addEventListener('input', () => {
                const term = searchPageInput.value.toLowerCase();
                if(term.length > 0) { searchClearBtn.style.display = 'block'; } else { searchClearBtn.style.display = 'none'; }
                keywordSuggestions.innerHTML = '';
                searchSuggestionsList.innerHTML = '';
                if(term.length < 2) return;

                const allKeywords = new Set();
                const matchedProducts = new Set();
                
                products.forEach(p => {
                    if(p.name.toLowerCase().includes(term) || (p.keywords && p.keywords.some(k => k.toLowerCase().includes(term)))) {
                        matchedProducts.add(p);
                    }
                    if(p.keywords) { p.keywords.forEach(k => { if(k.toLowerCase().startsWith(term)) allKeywords.add(k); }); }
                });
                
                allKeywords.forEach(k => {
                    const chip = document.createElement('div');
                    chip.className = 'keyword-chip';
                    chip.textContent = k;
                    chip.onclick = () => handleSearch(new Event('submit'), k);
                    keywordSuggestions.appendChild(chip);
                });

                matchedProducts.forEach(p => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.textContent = p.name;
                    item.onclick = () => { navigateTo(`product-details?id=${p.id}`); searchPageInput.value = ''; searchSuggestionsList.innerHTML = ''; };
                    searchSuggestionsList.appendChild(item);
                });
            });
            
            searchClearBtn.addEventListener('click', () => {
                searchPageInput.value = '';
                searchClearBtn.style.display = 'none';
                searchSuggestionsList.innerHTML = '';
                keywordSuggestions.innerHTML = '';
                searchPageInput.focus();
            });

            searchPageInput.addEventListener('blur', () => {
                setTimeout(() => { searchSuggestionsList.innerHTML = ''; }, 200);
            });

            detailMainImg.addEventListener('click', () => {
                lightbox.style.display = 'flex';
                lightboxImg.src = detailMainImg.src;
            });

            function closeAndResetLightbox() {
                lightbox.style.display = 'none';
                lightboxImg.classList.remove('zoomed');
            }

            closeLightbox.addEventListener('click', closeAndResetLightbox);
            lightbox.addEventListener('click', (e) => { if(e.target === lightbox) { closeAndResetLightbox(); } });
            lightboxImg.addEventListener('click', (e) => { e.stopPropagation(); lightboxImg.classList.toggle('zoomed'); });

            document.querySelectorAll('.password-toggle-icon').forEach(icon => {
                icon.addEventListener('click', function() {
                    const input = this.previousElementSibling;
                    const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                    input.setAttribute('type', type);
                    this.classList.toggle('fa-eye');
                    this.classList.toggle('fa-eye-slash');
                });
            });
        }

        function startOfferTimer() {
            const endDate = new Date();
            endDate.setDate(endDate.getDate() + 3);
            const timerInterval = setInterval(updateTimer, 1000);
            function updateTimer() {
                const distance = endDate - new Date().getTime();
                if (distance < 0) { clearInterval(timerInterval); return; };
                const d = Math.floor(distance / (1000*60*60*24)).toString().padStart(2,'0');
                const h = Math.floor((distance % (1000*60*60*24))/(1000*60*60)).toString().padStart(2,'0');
                const m = Math.floor((distance % (1000*60*60))/(1000*60)).toString().padStart(2,'0');
                const s = Math.floor((distance % (1000*60))/1000).toString().padStart(2,'0');
                document.getElementById('days').textContent = d;
                document.getElementById('hours').textContent = h;
                document.getElementById('minutes').textContent = m;
                document.getElementById('seconds').textContent = s;
            }
            updateTimer();
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadInitialData();
            init();
        });
    </script>
</body>
</html>
