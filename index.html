
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Loading...</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Material icons for Product Card -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20,400,1,0" />
    
    <!-- Firebase SDK Compat Version -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

    <style>
        /* ... Existing CSS ... */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary: #2563eb; --secondary: #f97316; --dark: #1f2937; --gray: #6b7280; --light: #f9fafb; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); --transition: all 0.3s ease; }
        body { font-family: 'Poppins', sans-serif; color: var(--dark); background-color: var(--light); line-height: 1.6; overflow-x: hidden; }
        .container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .page-section { display: none; animation: fadeIn 0.5s ease; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translate(-50%, 100px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        header { background-color: white; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100; }
        .header-content { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; height: 70px; }
        .progress-bar { height: 4px; background-color: var(--primary); width: 0%; position: absolute; bottom: -4px; left: 0; transition: width 0.4s ease-out, opacity 0.3s ease; opacity: 1; }
        .logo { display: flex; align-items: center; height: 100%; max-width: 180px; cursor: pointer; }
        .logo img { max-height: 35px; width: auto; object-fit: contain; }
        .header-actions { display: flex; align-items: center; gap: 20px; }
        .search-container { position: relative; }
        .header-search-icon { cursor: pointer; color: var(--dark); transition: var(--transition); }
        .header-search-icon:hover { color: var(--primary); }
        .cart-icon { position: relative; cursor: pointer; }
        .cart-count { position: absolute; top: -8px; right: -8px; background-color: var(--secondary); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; display: none; }
        .auth-buttons { display: flex; gap: 10px; }
        .btn { padding: 8px 20px; border-radius: 4px; border: none; font-family: 'Poppins', sans-serif; font-weight: 500; cursor: pointer; transition: var(--transition); }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-outline { background-color: transparent; color: var(--primary); border: 1px solid var(--primary); }
        .btn-outline:hover { background-color: var(--primary); color: white; }
        .btn-secondary { background-color: var(--secondary); color: white; }
        .btn-secondary:hover { background-color: #ea580c; }
        
        .menu-toggle { display: block; cursor: pointer; width: 30px; height: 20px; position: relative; z-index: 101; }
        .menu-bar { display: block; width: 100%; height: 3px; background-color: var(--dark); margin: 4px 0; transition: 0.4s; position: absolute; }
        .menu-bar:nth-child(1) { top: 0; }
        .menu-bar:nth-child(2) { top: 8px; }
        .menu-bar:nth-child(3) { top: 16px; }
        .menu-toggle.active .menu-bar:nth-child(1) { transform: rotate(-45deg); top: 8px; }
        .menu-toggle.active .menu-bar:nth-child(2) { opacity: 0; }
        .menu-toggle.active .menu-bar:nth-child(3) { transform: rotate(45deg); top: 8px; }
        .mobile-menu { display: block; position: absolute; top: 100%; left: 0; right: 0; background-color: white; box-shadow: var(--shadow); padding: 20px; z-index: 99; opacity: 0; transform: translateY(-20px); pointer-events: none; transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); }
        .mobile-menu.active { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .mobile-nav-links { list-style: none; }
        .mobile-nav-links li { margin-bottom: 15px; }
        .mobile-nav-links a { text-decoration: none; color: var(--dark); font-weight: 500; display: block; padding: 10px 0; }
        .mobile-auth { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        
        .hero { position: relative; color: white; width: 100%; aspect-ratio: 2.5 / 1; max-height: 80vh; margin-bottom: 20px; overflow: hidden; display: flex; align-items: center; }
        .hero-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        .hero-slide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; transition: opacity 1s ease; }
        .hero-slide.active { opacity: 1; }
        .hero-slide img, .hero-slide video, .hero-slide iframe { width: 100%; height: 100%; object-fit: cover; border: none; }
        .hero-slide iframe { pointer-events: none; transform: scale(1.5); }
        .hero::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); z-index: 1; }
        .hero-content { max-width: 600px; position: relative; z-index: 2; padding: 20px; }
        .hero h1 { font-size: 2.8rem; margin-bottom: 20px; line-height: 1.2; }
        .hero p { font-size: 1.2rem; margin-bottom: 30px; opacity: 0.9; }
        .section-title { text-align: center; font-size: 2rem; margin-bottom: 40px; color: var(--dark); }
        
        #categories .section-title { display: none; }
        .categories { padding: 10px 0 20px; }
        .category-grid { display: flex; gap: 30px; overflow-x: auto; padding: 10px; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; justify-content: flex-start; }
        .category-card { background-color: white; border-radius: 16px; width: 100px; height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: var(--shadow); transition: var(--transition); cursor: pointer; scroll-snap-align: center; flex-shrink: 0; border: 1px solid #eee; overflow: hidden; }
        .category-card:hover { transform: translateY(-5px); outline: 2px solid var(--primary); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); }
        .category-icon { font-size: 1.5rem; color: var(--primary); margin-bottom: 5px; }
        .category-card img { width: 50px; height: 50px; object-fit: cover; }
        .category-card h3 { font-size: 0.8rem; font-weight: 600; text-align: center; line-height: 1.2; padding: 0 5px; z-index: 2; }
        
        .products { padding: 40px 0; background-color: #f3f4f6; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; justify-items: center; }
        
        /* New Product Card Styles */
        .product-card { width: 100%; max-width: 240px; background: white; border-radius: 20px; box-shadow: 0 18px 30px -10px rgba(0, 90, 190, 0.2); transition: 0.2s ease-in-out; border: 1px solid rgba(0, 119, 255, 0.1); overflow: hidden; display: flex; flex-direction: column; cursor: pointer; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 24px 40px -12px #0066dd55; }
        .img-frame { position: relative; aspect-ratio: 6 / 8; background: #f0f7ff; display: flex; align-items: center; justify-content: center; overflow: hidden; border-bottom: 1px solid rgba(0, 0, 0, 0.05); }
        .product-img { width: 100%; height: 100%; object-fit: cover; display: block; transition: transform 0.5s ease; }
        .product-card:hover .product-img { transform: scale(1.05); }
        .hint { position: absolute; bottom: 12px; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(4px); padding: 4px 14px; border-radius: 40px; color: #003c8b; font-weight: 600; font-size: 0.75rem; border: 1px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .off-badge { position: absolute; top: 10px; right: 10px; background: #0066f0; color: white; font-weight: 700; font-size: 0.85rem; padding: 4px 12px; border-radius: 40px 40px 40px 10px; box-shadow: 0 8px 14px -8px #0055dd; border: 1px solid rgba(255, 255, 255, 0.35); z-index: 3; line-height: 1.2; }
        .out-of-stock-banner { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0, 0, 0, 0.6); color: white; font-weight: 700; font-size: 1rem; padding: 8px 0; text-align: center; z-index: 4; text-transform: uppercase; letter-spacing: 1px; backdrop-filter: blur(2px); }
        .card-info { padding: 0.8rem 1rem 1rem 1rem; background: white; flex-grow: 1; display: flex; flex-direction: column; }
        .product-title { font-size: 1.1rem; font-weight: 700; color: #0a2540; margin-bottom: 0.3rem; line-height: 1.2; letter-spacing: -0.01em; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .price-group { display: flex; align-items: baseline; gap: 0.5rem; margin-bottom: 0.3rem; }
        .new-price { font-size: 1.35rem; font-weight: 800; color: #1e5fd9; line-height: 1; }
        .old-price { font-size: 0.85rem; color: #6c819e; text-decoration: line-through; font-weight: 500; }
        .rating-section { display: flex; align-items: center; gap: 0.4rem; margin: 0.2rem 0 0.7rem 0; }
        .star-set { display: flex; align-items: center; gap: 1px; }
        .material-symbols-outlined.star { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 20; font-size: 1rem; color: #1973e8; }
        .material-symbols-outlined.star-empty { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 20; font-size: 1rem; color: #c1d9fc; }
        .rater-count { background: #ebf3fe; color: #1e519a; font-size: 0.75rem; font-weight: 600; padding: 3px 8px; border-radius: 60px; border: 1px solid #c5ddff; }
        .btn-view { background: #1f6ff0; border: none; color: white; width: 100%; padding: 0.6rem 0; font-size: 0.9rem; font-weight: 600; border-radius: 50px; cursor: pointer; transition: 0.15s; box-shadow: 0 6px 16px -6px #1f6ff0cc; border: 1px solid #5495ff; display: flex; align-items: center; justify-content: center; gap: 4px; margin-top: auto; }
        .btn-view:hover { background: #0d5bdf; box-shadow: 0 10px 22px -8px #0d5bdf; }

        /* Filter Dropdown */
        .filter-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px; position: relative; }
        .filter-controls .section-title { margin-bottom: 0; text-align: left; }
        .filter-dropdown-container { position: relative; }
        .filter-toggle-btn { display: flex; align-items: center; gap: 8px; font-weight: 600; background: white; padding: 8px 20px; border-radius: 8px; border: 1px solid #ddd; cursor: pointer; color: var(--dark); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .filter-toggle-btn:hover { background: #f9fafb; border-color: var(--primary); color: var(--primary); }
        .filter-options-dropdown { position: absolute; right: 0; top: 110%; background: white; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 220px; z-index: 10; display: none; flex-direction: column; overflow: hidden; border: 1px solid #eee; }
        .filter-options-dropdown.active { display: flex; animation: fadeIn 0.2s ease; }
        .filter-options-dropdown button { text-align: left; padding: 12px 20px; background: transparent; border: none; border-bottom: 1px solid #eee; cursor: pointer; transition: var(--transition); font-family: 'Poppins', sans-serif; font-size: 0.9rem; color: var(--dark); }
        .filter-options-dropdown button:last-child { border-bottom: none; }
        .filter-options-dropdown button:hover { background-color: #f3f4f6; color: var(--primary); }
        .filter-options-dropdown button.active { background-color: #eef2ff; color: var(--primary); font-weight: 600; }

        /* Empty State */
        .empty-state { grid-column: 1 / -1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 50px 20px; text-align: center; color: var(--gray); background: white; border-radius: 12px; box-shadow: var(--shadow); width: 100%; }
        .empty-state i { font-size: 3rem; margin-bottom: 15px; color: #cbd5e1; }
        .empty-state h3 { font-size: 1.2rem; color: var(--dark); margin-bottom: 5px; }

        .offers { padding: 60px 0; background-color: white; }
        .offer-banner { background: linear-gradient(120deg, var(--primary), #8b5cf6); color: white; border-radius: 20px; padding: 50px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; position: relative; overflow: hidden; box-shadow: 0 20px 40px rgba(37, 99, 235, 0.2); }
        .offer-banner::before, .offer-banner::after { content: ''; position: absolute; width: 200px; height: 200px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; }
        .offer-banner::before { top: -50px; left: -50px; }
        .offer-banner::after { bottom: -50px; right: -50px; }
        .offer-text h2 { font-size: 2.5rem; margin-bottom: 15px; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .timer { display: flex; gap: 15px; text-align: center; z-index: 2; }
        .time-unit { background-color: rgba(255, 255, 255, 0.25); backdrop-filter: blur(5px); padding: 15px; border-radius: 12px; min-width: 80px; border: 1px solid rgba(255, 255, 255, 0.3); }
        .time-value { font-size: 2.2rem; font-weight: 700; line-height: 1; margin-bottom: 5px; }
        
        .product-details-container { padding: 40px 0; background-color: white; min-height: 80vh; padding-bottom: 120px; }
        .back-btn { display: inline-flex; align-items: center; gap: 8px; margin-bottom: 20px; color: var(--gray); text-decoration: none; cursor: pointer; font-weight: 500; }
        .back-btn:hover { color: var(--primary); }
        .details-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 50px; }
        .details-gallery { display: flex; flex-direction: column; gap: 15px; }
        .main-image { width: 100%; height: 400px; background-color: #f3f4f6; border-radius: 10px; overflow: hidden; border: 1px solid #e5e7eb; cursor: zoom-in; }
        .main-image img { width: 100%; height: 100%; object-fit: contain; }
        .thumbnail-list { display: flex; gap: 10px; overflow-x: auto; }
        .thumbnail { width: 80px; height: 80px; border-radius: 6px; cursor: pointer; opacity: 0.6; transition: var(--transition); border: 2px solid transparent; object-fit: cover; }
        .thumbnail.active, .thumbnail:hover { opacity: 1; border-color: var(--primary); }
        .details-info h1 { font-size: 2.2rem; margin-bottom: 10px; line-height: 1.2; }
        .details-meta { display: flex; gap: 20px; margin-bottom: 20px; font-size: 0.9rem; color: var(--gray); }
        
        /* Updated Product Details Price Styling */
        .details-info .price { display: flex; align-items: baseline; gap: 15px; margin-bottom: 20px; }
        .details-info .current-price { font-size: 2.2rem; font-weight: 800; color: #1e5fd9; }
        .details-info .original-price { font-size: 1.2rem; font-weight: 500; color: #6c819e; text-decoration: line-through; }

        .details-description { margin-bottom: 30px; font-size: 1.1rem; color: #4b5563; }
        .details-actions { display: none; }
        .sticky-actions-bar { position: fixed; bottom: 0; left: 0; width: 100%; background-color: white; box-shadow: 0 -4px 10px rgba(0,0,0,0.1); padding: 15px 20px; z-index: 999; display: flex; gap: 15px; justify-content: center; }
        .sticky-actions-bar .btn { flex: 1; max-width: 300px; }
        .btn-lg { padding: 12px 30px; font-size: 1.1rem; }
        
        /* Sold Out container */
        .sold-out-container { display: none; background: #f9fafb; border: 2px dashed #d1d5db; color: #6b7280; font-size: 1.8rem; font-weight: 700; text-align: center; padding: 20px; border-radius: 12px; width: 100%; max-width: 600px; margin: 20px auto 0; text-transform: uppercase; letter-spacing: 2px; }
        .sticky-actions-bar.sold-out-mode { background: transparent; box-shadow: none; pointer-events: none; }
        .sticky-actions-bar.sold-out-mode .sold-out-container { display: block; background: rgba(249, 250, 251, 0.95); box-shadow: 0 -4px 15px rgba(0,0,0,0.05); pointer-events: auto; }

        /* Advanced Variant Options Styles */
        .variant-selector { margin-bottom: 20px; }
        .variant-selector h4 { font-weight: 600; margin-bottom: 12px; color: var(--dark); font-size: 1.1rem; }
        .variant-options { display: flex; gap: 12px; flex-wrap: wrap; }
        
        .variant-option { padding: 10px 15px; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.2s ease; display: inline-flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; background-color: #fff; color: var(--dark); min-width: 80px; position: relative; overflow: hidden; }
        .variant-option:hover:not(.out-of-stock) { border-color: #93c5fd; transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .variant-option.selected { border-color: var(--primary); background-color: #eff6ff; color: var(--primary); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15); }
        .variant-option.out-of-stock { opacity: 0.55; cursor: not-allowed; background-color: #f3f4f6; filter: grayscale(100%); }
        .variant-option.out-of-stock::after { content: 'Stock Out'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); background: rgba(0,0,0,0.7); color: white; font-size: 0.75rem; padding: 4px 8px; white-space: nowrap; border-radius: 4px; font-weight: bold; z-index: 5;}
        
        .variant-option .variant-img { width: 50px; height: 50px; border-radius: 6px; object-fit: cover; margin-bottom: 4px; border: 1px solid #eee; }
        .variant-option .var-name { font-weight: 600; font-size: 0.95rem; line-height: 1.1; }
        .variant-option .var-price { font-size: 0.85rem; color: var(--primary); font-weight: 700; margin-top: 2px; }
        .variant-option .var-stock { font-size: 0.7rem; color: var(--gray); font-weight: 500; }
        .variant-option .var-discount { position: absolute; top: 0; right: 0; background: #ef4444; color: white; font-size: 0.65rem; font-weight: bold; padding: 2px 6px; border-bottom-left-radius: 8px; z-index: 2; box-shadow: -2px 2px 4px rgba(0,0,0,0.1);}
        
        /* Updated Overlay Backgrounds */
        .options-panel-overlay, .custom-alert-overlay, .welcome-overlay, .order-details-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1002; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .welcome-overlay { z-index: 3000; display: none; align-items: center; justify-content: center; }
        .order-details-overlay { z-index: 2500; display: none; align-items: flex-end; justify-content: center; }
        .custom-alert-overlay { z-index: 2000; display: flex; align-items: center; justify-content: center; }
        
        .options-panel-overlay.active, .custom-alert-overlay.active { opacity: 1; pointer-events: auto; }
        .welcome-overlay.active { display: flex; opacity: 1; pointer-events: auto; }
        .order-details-overlay.active { display: flex; opacity: 1; pointer-events: auto; animation: fadeIn 0.3s ease; }

        .options-panel { position: fixed; bottom: 0; left: 0; width: 100%; background-color: white; z-index: 1003; padding: 20px; border-top-left-radius: 16px; border-top-right-radius: 16px; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); transform: translateY(100%); transition: transform 0.3s ease; }
        .options-panel.active { transform: translateY(0); }
        .options-panel-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; gap: 15px; }
        .options-panel-product-info { display: flex; align-items: center; gap: 15px; flex-grow: 1; }
        .options-panel-product-info img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; }
        .options-panel-product-info h4 { font-size: 1.1rem; margin: 0; line-height: 1.2; }
        .options-panel-product-info .current-price { font-size: 1.2rem; }
        .options-panel-close { font-size: 1.5rem; cursor: pointer; background: none; border: none; color: var(--gray); align-self: flex-start; }
        .options-panel-body .quantity-selector { display: flex; align-items: center; justify-content: space-between; margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee; }
        .options-panel-actions .btn { width: 100%; padding: 12px; }
        
        .checkout { padding: 60px 0; }
        .checkout-form { background-color: white; border-radius: 8px; padding: 30px; box-shadow: var(--shadow); max-width: 800px; margin: 0 auto; }
        .form-group { margin-bottom: 20px; }
        .form-group.password-group { position: relative; }
        .password-toggle-icon { position: absolute; top: 68%; right: 15px; transform: translateY(-50%); cursor: pointer; color: var(--gray); }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-control { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Poppins', sans-serif; }
        
        /* Updated Address Selection Styles */
        .address-box { display: flex; gap: 15px; padding: 15px; border: 1px solid #eee; background: white; border-radius: 8px; margin-bottom: 10px; position: relative; cursor: pointer; transition: all 0.2s; }
        .address-box:hover { border-color: var(--primary); }
        .address-box.selected { border-color: var(--primary); background: #eff6ff; }
        .address-box-icon { color: var(--primary); font-size: 24px; padding-top: 2px; }
        .address-box-details { flex: 1; }
        .address-box-details h5 { margin: 0 0 5px 0; font-size: 1rem; color: #333; display: flex; align-items: center; gap: 10px; }
        .address-box-details .phone { color: #666; font-size: 0.9rem; font-weight: normal; }
        .address-box-details p { margin: 0; font-size: 0.85rem; color: #555; line-height: 1.4; }
        .address-badges { margin-top: 8px; display: flex; gap: 8px; }
        .badge-title { border: 1px solid #333; padding: 2px 8px; font-size: 0.7rem; font-weight: 600; border-radius: 4px; color: #333; }
        .badge-default { color: #dc2626; border: 1px solid #dc2626; padding: 2px 8px; font-size: 0.7rem; font-weight: 600; border-radius: 4px; background: #fef2f2; }
        .btn-edit-addr { position: absolute; right: 15px; top: 15px; color: #f97316; cursor: pointer; font-size: 0.85rem; background: none; border: none; font-weight: 600; padding: 5px; }
        .btn-edit-addr:hover { color: #ea580c; text-decoration: underline; }
        .add-address-btn { width: 100%; padding: 15px; margin-bottom: 20px; border: 2px dashed #0ea5e9; color: #0ea5e9; background: transparent; font-weight: 600; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .add-address-btn:hover { background: #f0f9ff; }
        
        .payment-methods { display: flex; flex-direction: column; gap: 12px; margin: 20px 0; }
        .payment-method { display: flex; flex-direction: row; align-items: center; justify-content: flex-start; padding: 15px 20px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: var(--transition); gap: 15px; background-color: #fff; text-align: left; position: relative; }
        .payment-method img { max-width: 40px; max-height: 40px; object-fit: contain; }
        .payment-method i { font-size: 24px; color: var(--primary); width: 40px; text-align: center; }
        .payment-method p { margin: 0; font-weight: 500; flex-grow: 1; font-size: 1rem; color: var(--dark); }
        .payment-method::after { content: '\f105'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: #ccc; font-size: 1.2rem; }
        .payment-method:hover { border-color: var(--primary); }
        .payment-method.active { border-color: var(--primary); background-color: #eff6ff; }
        .payment-method.active::after { color: var(--primary); }

        .auth-container { max-width: 450px; margin: 60px auto; background: white; padding: 40px; border-radius: 8px; box-shadow: var(--shadow); }
        .auth-title { text-align: center; margin-bottom: 30px; color: var(--primary); }
        .social-login { margin-top: 25px; padding-top: 25px; border-top: 1px solid #eee; }
        .google-btn { width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; background-color: white; border: 1px solid #ddd; color: #555; padding: 10px; border-radius: 4px; cursor: pointer; transition: var(--transition); font-weight: 500; }
        .google-btn:hover { background-color: #f8f9fa; border-color: #ccc; }
        .google-btn img { width: 20px; height: 20px; }
        .auth-switch { text-align: center; margin-top: 20px; font-size: 0.9rem; }
        .auth-switch a { color: var(--primary); text-decoration: none; font-weight: 500; }
        
        .cart-overlay { position: fixed; top: 0; right: 0; bottom: 0; width: 100%; max-width: 400px; background-color: white; box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1); transform: translateX(100%); transition: transform 0.3s ease; z-index: 1001; display: flex; flex-direction: column; }
        .cart-overlay.active { transform: translateX(0); }
        .cart-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #e5e7eb; }
        .close-cart { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        .cart-items { flex: 1; overflow-y: auto; padding: 20px; }
        .cart-item { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid #f3f4f6; gap: 10px; }
        .cart-item-details-link { display: flex; align-items: center; flex-grow: 1; text-decoration: none; color: inherit; cursor: pointer; }
        .cart-item-img { width: 80px; height: 80px; background-color: #e5e7eb; border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 15px; overflow: hidden; }
        .cart-item-img img { width: 100%; height: 100%; object-fit: cover; }
        .cart-item-info { flex: 1; padding-left: 10px;}
        .cart-item-info h4 { font-size: 1rem; margin-bottom: 5px; }
        .cart-item-price { color: var(--primary); font-weight: 600; margin-bottom: 5px; }
        .cart-item-actions { display: flex; align-items: center; gap: 10px; }
        .cart-item-qty { width: 50px; text-align: center; padding: 5px; border: 1px solid #ddd; }
        .remove-item { background: none; border: none; color: #ef4444; cursor: pointer; }
        .cart-footer { padding: 20px; border-top: 1px solid #e5e7eb; }
        .cart-total { display: flex; justify-content: space-between; font-size: 1.3rem; font-weight: 700; margin-bottom: 20px; }
        
        footer { background-color: var(--dark); color: white; padding: 60px 0 30px; }
        .footer-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 40px; margin-bottom: 40px; }
        .footer-logo { display: flex; align-items: center; max-width: 180px; cursor: pointer; margin-bottom: 20px; }
        .footer-logo img { max-height: 50px; width: auto; object-fit: contain; filter: brightness(0) invert(1); }
        .footer-about p { margin-bottom: 20px; opacity: 0.8; }
        .footer-links h3, .footer-contact h3 { font-size: 1.2rem; margin-bottom: 20px; }
        .footer-links ul { list-style: none; }
        .footer-links li { margin-bottom: 10px; }
        .footer-links a { color: white; text-decoration: none; opacity: 0.8; transition: var(--transition); }
        .footer-links a:hover { opacity: 1; color: var(--primary); }
        .footer-contact p { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; opacity: 0.8; }
        .social-icons { display: flex; gap: 15px; margin-top: 20px; }
        .social-icon { width: 40px; height: 40px; background-color: rgba(255, 255, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; text-decoration: none; transition: var(--transition); }
        .social-icon:hover { background-color: var(--primary); transform: translateY(-3px); }
        .copyright { text-align: center; padding-top: 30px; border-top: 1px solid rgba(255, 255, 255, 0.1); opacity: 0.7; }
        
        /* Updated Search Page UI */
        .search-page-container { background: #f3f4f6; min-height: 100vh; padding: 20px; }
        .search-header-ui { display: flex; align-items: center; background: white; padding: 10px 15px; border-radius: 8px; box-shadow: var(--shadow); margin-bottom: 20px; gap: 15px; }
        .search-back-icon { font-size: 1.2rem; color: var(--dark); cursor: pointer; padding: 5px; }
        .search-page-form { flex: 1; display: flex; position: relative; }
        .search-page-input { width: 100%; border: none; padding: 10px 40px 10px 10px; font-size: 1rem; font-family: 'Poppins', sans-serif; background: transparent; outline: none; }
        .search-page-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: var(--primary); color: white; border: none; border-radius: 4px; padding: 6px 15px; cursor: pointer; font-size: 0.9rem; font-weight: 600; }
        .search-clear-btn { position: absolute; right: 95px; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 1.2rem; color: #999; cursor: pointer; display: none; }
        
        .search-section { background: white; padding: 20px; border-radius: 8px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .search-section-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .search-section-title { font-size: 1rem; font-weight: 600; color: var(--dark); }
        .search-clear-history { font-size: 0.85rem; color: var(--gray); cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .search-clear-history:hover { color: #ef4444; }
        .search-tags-container { display: flex; flex-wrap: wrap; gap: 10px; }
        .search-tag { background-color: #f3f4f6; color: var(--dark); padding: 6px 15px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; transition: var(--transition); border: 1px solid #e5e7eb; }
        .search-tag:hover { background-color: var(--primary); color: white; border-color: var(--primary); }
        
        #search-suggestions-list { width: 100%; background: white; border-radius: 8px; box-shadow: var(--shadow); margin-top: -10px; margin-bottom: 20px; overflow: hidden; max-height: 300px; overflow-y: auto; display: none; }
        .suggestion-item { padding: 12px 20px; cursor: pointer; transition: var(--transition); border-bottom: 1px solid #f3f4f6; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: #f3f4f6; color: var(--primary); }
        
        .search-results-container { padding: 40px 0; min-height: 80vh; background: #f3f4f6; }
        
        .lightbox { display: none; position: fixed; z-index: 1002; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
        .lightbox-content { margin: auto; display: block; max-width: 90vw; max-height: 90vh; object-fit: contain; transition: transform 0.3s ease; cursor: zoom-in; image-rendering: -webkit-optimize-contrast; image-rendering: crisp-edges; }
        .lightbox-content.zoomed { transform: scale(1.5); cursor: zoom-out; }
        .close-lightbox { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; transition: 0.3s; cursor: pointer; }
        .quantity-selector { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .qty-btn, .cart-item-actions .qty-btn { width: 30px; height: 30px; border: 1px solid #ddd; background-color: #f8f9fa; cursor: pointer; font-size: 1.2rem; font-weight: bold; color: var(--dark); border-radius: 4px; transition: var(--transition); }
        .qty-btn:hover, .cart-item-actions .qty-btn:hover { background-color: #e9ecef; border-color: #ccc; }
        .qty-input, .cart-item-qty { width: 50px; height: 30px; text-align: center; border: 1px solid #ddd; border-radius: 4px; font-family: 'Poppins', sans-serif; -moz-appearance: textfield; }
        .qty-input::-webkit-outer-spin-button, .qty-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .delivery-info { background-color: #eef2ff; border-left: 4px solid var(--primary); padding: 10px 15px; margin: 15px 0; border-radius: 4px; font-size: 0.9rem; color: var(--dark); }
        .delivery-info .delivery-charge { font-weight: 600; color: var(--primary); }
        .cart-item-selector { display: flex; align-items: center; justify-content: center; }
        .cart-item-checkbox { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary); }
        
        .profile-icon { display: none !important; }
        body.user-logged-in .auth-buttons, body.user-logged-in .mobile-auth { display: none; }
        
        #profile-page .container { padding-top: 10px; padding-bottom: 10px; }
        .profile-container { display: flex; gap: 30px; }
        .sidebar { width: 250px; flex-shrink: 0; }
        .profile-card { background-color: white; border-radius: 10px; padding: 25px; text-align: center; box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05); margin-bottom: 20px; }
        .profile-picture { width: 100px; height: 100px; border-radius: 50%; background-color: #eef2ff; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; color: var(--primary); font-size: 40px; border: 3px solid var(--primary); overflow: hidden;}
        .profile-name { font-size: 22px; font-weight: 600; margin-bottom: 5px; }
        .profile-email { color: var(--gray); font-size: 14px; margin-bottom: 15px; }
        .nav-menu { background-color: white; border-radius: 10px; overflow: hidden; box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05); }
        .nav-item { display: flex; align-items: center; padding: 18px 20px; color: var(--dark); text-decoration: none; border-left: 4px solid transparent; transition: all 0.3s ease; cursor: pointer; }
        .nav-item:hover { background-color: var(--light); color: var(--primary); }
        .nav-item.active { background-color: #eef2ff; color: var(--primary); border-left-color: var(--primary); }
        .nav-item i { margin-right: 12px; font-size: 18px; width: 24px; }
        .main-content { flex-grow: 1; }
        .content-section { background-color: white; border-radius: 10px; padding: 30px; margin-bottom: 25px; box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05); display: none; }
        .content-section.active { display: block; animation: fadeIn 0.5s; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #ddd; }
        .section-header .section-title { font-size: 22px; font-weight: 600; color: var(--primary); margin-bottom: 0; text-align: left; }
        .form-row { display: flex; gap: 20px; }
        .form-row .form-group { flex: 1; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--dark); }
        .main-content .form-control { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; transition: border 0.3s ease; }
        .main-content .form-control:focus { outline: none; border-color: var(--primary); }
        .locations-list { margin-top: 20px; }
        .skeleton-card { background-color: white; border-radius: 20px; overflow: hidden; box-shadow: var(--shadow); width: 100%; max-width: 240px; }
        .skeleton-img, .skeleton-line { background-color: #e2e8f0; background: linear-gradient(90deg, #e2e8f0 25%, #f8fafc 50%, #e2e8f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        .skeleton-img { aspect-ratio: 6/8; }
        .skeleton-info { padding: 20px; }
        .skeleton-line { height: 16px; border-radius: 4px; margin-bottom: 10px; }
        .skeleton-line.short { width: 60%; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        .suggested-products-section { padding: 60px 0; background-color: #f9fafb; }
        .suggested-products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; justify-items: center; }
        
        /* Glassy Dark Custom Alert Box */
        .custom-alert-box { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); padding: 30px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); text-align: center; max-width: 400px; width: 90%; transform: scale(0.9); transition: transform 0.3s ease; color: white; }
        .custom-alert-overlay.active .custom-alert-box { transform: scale(1); }
        .custom-alert-box h3 { margin-bottom: 15px; color: white; }
        .custom-alert-box p { margin-bottom: 25px; color: #cbd5e1; }
        .custom-alert-actions { display: flex; justify-content: center; gap: 15px; }
        .custom-alert-actions .btn-outline { color: white; border-color: rgba(255,255,255,0.4); }
        .custom-alert-actions .btn-outline:hover { background: rgba(255,255,255,0.1); border-color: white; color: white; }
        
        .welcome-box { width: 100vw; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; transform: scale(1); background: transparent !important; box-shadow: none !important; padding: 0 !important; }

        .order-details-modal { background: #f5f5f5; width: 100%; max-width: 500px; height: 90vh; border-radius: 12px 12px 0 0; display: flex; flex-direction: column; overflow-y: auto; position: relative; font-family: 'Poppins', sans-serif; animation: slideUp 0.4s ease; }
        @media(min-width: 576px) { .order-details-modal { height: auto; max-height: 90vh; border-radius: 12px; margin: 20px; animation: fadeIn 0.3s ease; } .order-details-overlay { align-items: center; } }
        .od-header { padding: 15px 20px; background: white; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
        .od-header h3 { font-size: 1.1rem; margin: 0; font-weight: 600; }
        .od-header button { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray); transition: color 0.2s; }
        .od-header button:hover { color: #ef4444; }
        .od-section { background: white; padding: 15px 20px; border-bottom: 8px solid #f5f5f5; }
        .od-section:last-of-type { border-bottom: none; }
        .od-item { display: flex; gap: 15px; margin-bottom: 15px; }
        .od-item:last-child { margin-bottom: 0; }
        .od-item img { width: 70px; height: 70px; object-fit: cover; border-radius: 6px; border: 1px solid #eee; }
        .od-item-info { flex: 1; }
        .od-item-info h4 { font-size: 0.9rem; margin: 0 0 5px 0; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3; font-weight: 500; }
        .od-item-variant { font-size: 0.75rem; color: #666; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-bottom: 5px; }
        .od-item-price-row { display: flex; justify-content: space-between; align-items: center; }
        .od-item-price { font-weight: 600; font-size: 0.9rem; }
        .od-item-qty { font-size: 0.85rem; color: #666; font-weight: 500; }
        .od-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; color: #333; }
        .od-row:last-child { margin-bottom: 0; }
        .od-row span:first-child { color: #666; }
        .od-total { border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px; font-weight: 700; font-size: 1rem; }
        .od-total span:first-child { color: #333; }
        .od-meta-section { font-size: 0.85rem; }
        .od-meta-section .od-row { margin-bottom: 12px; }
        .od-actions { padding: 15px 20px; background: white; position: sticky; bottom: 0; border-top: 1px solid #eee; }

        /* Updated Promo Popup */
        .promo-popup { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(200%); background-color: white; border: none; border-radius: 12px; display: flex; flex-direction: row !important; align-items: stretch; width: 400px; max-width: 95vw; z-index: 1500; transition: transform 0.5s cubic-bezier(0.165, 0.84, 0.44, 1); padding: 0; box-shadow: 0 10px 25px rgba(0,0,0,0.2); overflow: visible; }
        .promo-popup.visible { transform: translateX(-50%) translateY(0); }
        .promo-popup-img { width: 130px; height: auto; object-fit: cover; border-right: 1px solid #eee; flex-shrink: 0; border-radius: 12px 0 0 12px; }
        .promo-popup-content { display: flex; flex-direction: column; justify-content: center; padding: 15px; flex-grow: 1; position: relative; }
        .promo-popup-content h4 { font-size: 1.1rem; margin: 0 0 5px 0; max-width: 100%; white-space: normal; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; font-weight: 700; color: #000; line-height: 1.3; }
        .promo-popup-content .price { display: flex; align-items: baseline; gap: 8px; margin: 0 0 10px 0; }
        .promo-popup-content .current-price { font-size: 1.25rem; font-weight: 800; color: #000; }
        .promo-popup-content .original-price { display: inline-block; font-size: 0.85rem; color: #dc2626 !important; text-decoration: line-through; }
        .promo-popup-content .btn { background-color: #38bdf8; border: none; border-radius: 30px; font-weight: 700; font-size: 1.1rem; padding: 8px; width: 100%; color: white; transition: background 0.3s; cursor: pointer; }
        .promo-popup-content .btn:hover { background-color: #0ea5e9; }
        .promo-popup-discount { position: absolute; top: 0; right: 0; background-color: #dc2626; color: white; padding: 8px 15px; border-bottom-left-radius: 20px; border-top-right-radius: 12px; font-weight: 800; font-size: 1rem; text-align: center; line-height: 1.1; z-index: 2; }
        .promo-popup-close { position: absolute; top: -10px; right: -10px; left: auto; background: white; color: #333; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; border: none; cursor: pointer; z-index: 10; margin: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }

        @media (max-width: 992px) { .details-wrapper { grid-template-columns: 1fr; } .offer-banner { flex-direction: column; text-align: center; gap: 30px; } .profile-container { flex-direction: column; } .sidebar { width: 100%; } .form-row { flex-direction: column; gap: 0; } }
        @media (max-width: 768px) { 
            .header-actions .auth-buttons, .search-container { display: none; } 
            .body.user-logged-in .header-actions .auth-buttons { display: none; } 
            .header-actions { gap: 15px; } 
            .hero { aspect-ratio: 3 / 2; } 
            .hero h1 { font-size: 2.2rem; } 
            .filter-controls { flex-direction: column; align-items: stretch; } 
            .filter-dropdown-container { align-self: flex-start; }
            .filter-options-dropdown { left: 0; right: auto; width: 200px; }
        }
        @media (max-width: 576px) { 
            .product-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); } 
            
            /* 3 items per row specifically for Search Results */
            #searchResultsGrid.product-grid { grid-template-columns: repeat(3, 1fr); gap: 6px; }
            #searchResultsGrid .product-card { border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
            #searchResultsGrid .card-info { padding: 0.4rem; }
            #searchResultsGrid .product-title { font-size: 0.65rem; margin-bottom: 0.2rem; -webkit-line-clamp: 2; line-height: 1.2; }
            #searchResultsGrid .new-price { font-size: 0.75rem; }
            #searchResultsGrid .old-price { font-size: 0.6rem; }
            #searchResultsGrid .rating-section { display: none; }
            #searchResultsGrid .btn-view { font-size: 0.6rem; padding: 0.3rem 0; gap: 2px; }
            #searchResultsGrid .off-badge { font-size: 0.6rem; padding: 2px 4px; top: 5px; right: 5px; }
            
            .timer { flex-wrap: wrap; justify-content: center; } 
            .category-card { width: 80px; height: 80px; border-radius: 12px; } 
            .category-icon { font-size: 1.2rem; } 
            .category-card h3 { font-size: 0.7rem; } 
            .suggested-products-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); } 
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <a href="#home" class="logo" onclick="navigateTo('home')">
                    <img id="headerLogo" src="" alt="Logo">
                </a>
                
                <div class="header-actions">
                    <div class="header-search-icon" onclick="navigateTo('search')">
                        <i class="fas fa-search fa-lg"></i>
                    </div>
                    
                    <div class="cart-icon" id="cartIcon">
                        <i class="fas fa-shopping-cart fa-lg"></i>
                        <span class="cart-count">0</span>
                    </div>
                    
                    <div class="auth-buttons" id="authButtons">
                        <button class="btn btn-outline" onclick="navigateTo('login')">Login</button>
                        <button class="btn btn-primary" onclick="navigateTo('register')">Register</button>
                    </div>

                    <div class="menu-toggle" id="menuToggle">
                        <span class="menu-bar"></span>
                        <span class="menu-bar"></span>
                        <span class="menu-bar"></span>
                    </div>
                </div>
            </div>
            
            <div class="progress-bar" id="progressBar"></div>

            <div class="mobile-menu" id="mobileMenu">
                <div id="menuProfileSection" style="display: none; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; text-align: center;">
                    <div class="profile-picture" style="width: 60px; height: 60px; margin: 0 auto 10px; font-size: 24px; border-radius: 50%; background-color: #eef2ff; color: var(--primary); display: flex; align-items: center; justify-content: center; border: 2px solid var(--primary); overflow: hidden;">
                        <i class="fa-solid fa-face-grin"></i>
                    </div>
                    <h4 id="menuProfileName" style="margin-bottom: 5px;">User Name</h4>
                    <button class="btn btn-outline" onclick="navigateTo('profile'); toggleMenu()" style="width: 100%; font-size: 0.9rem; padding: 8px;">My Profile</button>
                </div>

                <ul class="mobile-nav-links">
                    <li><a href="#home" onclick="navigateTo('home'); toggleMenu()">Home</a></li>
                    <li><a href="#search" onclick="navigateTo('search'); toggleMenu()">Search</a></li>
                    <li><a href="#home" onclick="navigateTo('home'); toggleMenu(); document.getElementById('shop').scrollIntoView()">Shop</a></li>
                    <li><a href="#home" onclick="navigateTo('home'); toggleMenu(); document.getElementById('categories').scrollIntoView()">Categories</a></li>
                    <li><a href="#home" onclick="navigateTo('home'); toggleMenu(); document.getElementById('offers').scrollIntoView()">Offers</a></li>
                    <li><a href="#home" onclick="navigateTo('home'); toggleMenu(); document.getElementById('contact').scrollIntoView()">About</a></li>
                    <li><a href="#home" onclick="navigateTo('home'); toggleMenu(); document.getElementById('contact').scrollIntoView()">Contact</a></li>
                </ul>
                
                <div class="mobile-auth" id="mobileAuth">
                    <button class="btn btn-outline" onclick="navigateTo('login'); toggleMenu()">Login</button>
                    <button class="btn btn-primary" onclick="navigateTo('register'); toggleMenu()">Register</button>
                </div>
            </div>
        </div>
    </header>

    <main>
        <!-- HOME PAGE SECTION -->
        <div id="home-page" class="page-section">
            <section class="hero" id="home">
                <div class="hero-bg" id="heroBg"></div>
                <div class="container">
                    <div class="hero-content">
                        <h1 id="heroTitle"></h1>
                        <p id="heroDesc"></p>
                        <button class="btn btn-secondary btn-shop">Start Shoping</button>
                    </div>
                </div>
            </section>

            <section class="categories" id="categories">
                <div class="container">
                    <h2 class="section-title">Shop by Category</h2>
                    <div class="category-grid" id="categoryGrid"></div>
                </div>
            </section>

            <section class="products" id="shop">
                <div class="container">
                    <div class="filter-controls">
                        <h2 class="section-title" id="shopTitle">Featured Products</h2>
                        <div class="filter-dropdown-container">
                            <button class="filter-toggle-btn" onclick="toggleFilterDropdown('homeFilterOptions')">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                            <div class="filter-options-dropdown" id="homeFilterOptions">
                                <button data-filter="default" class="active">Default</button>
                                <button data-filter="price-asc">Price: Low to high</button>
                                <button data-filter="price-desc">Price: High to low</button>
                                <button data-filter="top-selling">Top Selling</button>
                                <button data-filter="most-discount">Most Discount</button>
                            </div>
                        </div>
                    </div>
                    <div class="product-grid" id="productGrid"></div>
                </div>
            </section>

            <section class="offers" id="offers">
                <div class="container">
                    <h2 class="section-title">Special Offers</h2>
                    <div class="offer-banner">
                        <div class="offer-text">
                            <h2 id="offerTitle"></h2>
                            <p id="offerSubtitle"></p>
                            <p id="offerDesc"></p>
                        </div>
                        <div class="timer">
                            <div class="time-unit">
                                <div class="time-value" id="days">00</div>
                                <div>Days</div>
                            </div>
                            <div class="time-unit">
                                <div class="time-value" id="hours">00</div>
                                <div>Hours</div>
                            </div>
                            <div class="time-unit">
                                <div class="time-value" id="minutes">00</div>
                                <div>Minutes</div>
                            </div>
                            <div class="time-unit">
                                <div class="time-value" id="seconds">00</div>
                                <div>Seconds</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- PRODUCT DETAILS PAGE SECTION -->
        <div id="product-details-page" class="page-section">
            <div class="container product-details-container">
                <div class="back-btn" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i> Back
                </div>
                
                <div class="details-wrapper">
                    <div class="details-gallery">
                        <div class="main-image">
                            <img id="detailMainImg" src="" alt="Product">
                        </div>
                        <div class="thumbnail-list" id="detailThumbnails"></div>
                    </div>
                    
                    <div class="details-info">
                        <h1 id="detailName">Product Name</h1>
                        <div class="rating" id="detailRating"></div>
                        <div class="price">
                            <span class="current-price" id="detailPrice">0.00</span>
                            <span class="original-price" id="detailOldPrice">0.00</span>
                        </div>
                        
                        <div class="delivery-info">
                            <p><i class="fas fa-truck"></i> <strong>Delivery Charge:</strong> <span class="delivery-charge" id="deliveryInsideTk"></span> inside Dhaka, <span class="delivery-charge" id="deliveryOutsideTk"></span> outside Dhaka.</p>
                        </div>
                        <div id="detailPaymentGateways" style="display: flex; gap: 10px; margin: 15px 0; align-items: center; flex-wrap: wrap;"></div>

                        <div id="detailVariantSelectors"></div>
                        
                        <div class="quantity-selector">
                            <label>Quantity:</label>
                            <button class="qty-btn" id="detailDecQty">-</button>
                            <input type="number" class="qty-input" id="detailQty" value="1" min="1">
                            <button class="qty-btn" id="detailIncQty">+</button>
                            <span id="detailStockStatus" style="margin-left: 10px; font-size: 0.9rem; color: var(--gray);"></span>
                        </div>
                        
                        <div class="details-description">
                            <p id="detailDesc">Description goes here...</p>
                        </div>

                        <div class="details-actions">
                            <button class="btn btn-outline btn-lg" id="detailAddToCartOriginal">Add to Cart</button>
                            <button class="btn btn-primary btn-lg" id="detailBuyNowOriginal">Buy Now</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <section class="suggested-products-section">
                <div class="container">
                    <h2 class="section-title">You Might Also Like</h2>
                    <div class="suggested-products-grid" id="suggestedProductsGrid"></div>
                </div>
            </section>

            <div class="sticky-actions-bar" id="stickyActionsBar">
                 <button class="btn btn-outline btn-lg" id="detailAddToCartSticky">Add to Cart</button>
                 <button class="btn btn-primary btn-lg" id="detailBuyNowSticky">Buy Now</button>
                 <!-- Sold out display block -->
                 <div class="sold-out-container" id="soldOutDisplay">Sold Out</div>
            </div>
        </div>
        
        <!-- SEARCH PAGE SECTION -->
        <div id="search-page" class="page-section">
            <div class="search-page-container container">
                <div class="search-header-ui">
                    <i class="fas fa-arrow-left search-back-icon" onclick="goBack()"></i>
                    <form class="search-page-form" id="searchPageForm">
                        <input type="text" class="search-page-input" id="searchPageInput" placeholder="What are you looking for?" required autocomplete="off">
                        <button type="button" class="search-clear-btn" id="searchClearBtn">&times;</button>
                        <button type="submit" class="search-page-btn">Search</button>
                    </form>
                </div>
                
                <div id="search-suggestions-list"></div>

                <div class="search-section" id="searchHistorySection" style="display: none;">
                    <div class="search-section-head">
                        <span class="search-section-title">Search History</span>
                        <span class="search-clear-history" id="clearHistoryBtn">Clear All <i class="fas fa-trash"></i></span>
                    </div>
                    <div class="search-tags-container" id="searchHistoryTags"></div>
                </div>
            </div>
        </div>
        
        <!-- SEARCH RESULTS PAGE SECTION -->
        <div id="search-results-page" class="page-section">
            <div class="container search-results-container">
                <div class="back-btn" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i> Back to Search
                </div>
                <div class="filter-controls">
                    <h2 class="section-title" id="searchResultsTitle" style="font-size: 1.5rem;">Search Results</h2>
                    <div class="filter-dropdown-container">
                        <button class="filter-toggle-btn" onclick="toggleFilterDropdown('searchFilterOptions')">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                        <div class="filter-options-dropdown" id="searchFilterOptions">
                            <button data-filter="default" class="active">Default</button>
                            <button data-filter="price-asc">Price: Low to high</button>
                            <button data-filter="price-desc">Price: High to low</button>
                            <button data-filter="top-selling">Top Selling</button>
                            <button data-filter="most-discount">Most Discount</button>
                        </div>
                    </div>
                </div>
                <div class="product-grid" id="searchResultsGrid"></div>
            </div>
        </div>

        <!-- CHECKOUT PAGE SECTION -->
        <div id="checkout-page" class="page-section">
            <section class="checkout" id="checkout">
                <div class="container">
                    <div class="back-btn" onclick="goBack()">
                        <i class="fas fa-arrow-left"></i> Back
                    </div>
                    <h2 class="section-title">Checkout</h2>
                    <div class="checkout-form">
                        <h3>Shipping Information</h3>
                        <form id="checkoutForm">
                            <div class="address-management" id="checkoutAddressManagement">
                                <div id="checkoutSavedAddressesList"></div>
                                <button type="button" class="add-address-btn" id="checkoutAddAddressBtn">+ Add new address</button>
                            </div>

                            <div id="shippingInfoForm" style="display: none;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="coAddressTitle">Location Title (e.g. Home, Office)</label>
                                        <input type="text" id="coAddressTitle" class="form-control" placeholder="Home">
                                    </div>
                                    <div class="form-group">
                                        <label for="coName">Full Name</label>
                                        <input type="text" id="coName" class="form-control" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="coPhone">Mobile Number</label>
                                        <input type="tel" id="coPhone" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="coEmail">Email Address</label>
                                        <input type="email" id="coEmail" class="form-control" readonly style="background-color: #f3f4f6;">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="coRegion">Region</label>
                                        <select id="coRegion" class="form-control" required>
                                            <option value="">Select Region...</option>
                                            <option value="Inside Dhaka">Inside Dhaka</option>
                                            <option value="Outside Dhaka">Outside Dhaka</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="coPostCode">Post Code</label>
                                        <input type="number" id="coPostCode" class="form-control" min="1000" max="9999" placeholder="E.g., 1205" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="coAddress">Full Address</label>
                                    <textarea id="coAddress" class="form-control" rows="3" required placeholder="E.g., House No, Road, Area, Thana"></textarea>
                                </div>
                                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                                    <button type="button" class="btn btn-outline" id="coCancelAddressBtn" style="flex: 1;">Cancel</button>
                                    <button type="button" class="btn btn-primary" id="coSaveAddressBtn" style="flex: 1;">Save Address</button>
                                </div>
                            </div>
                            
                            <h3>Payment Method</h3>
                            <div class="payment-methods" id="checkoutPaymentMethods">
                                <!-- Dynamic Payment Methods Injected via JS -->
                            </div>
                            
                            <button type="submit" class="btn btn-primary btn-block" style="width: 100%; padding: 15px;">Place Order</button>
                        </form>
                    </div>
                </div>
            </section>
        </div>

        <!-- LOGIN PAGE SECTION -->
        <div id="login-page" class="page-section">
            <div class="container">
                <div class="auth-container">
                    <h2 class="auth-title">Login</h2>
                    <form id="loginForm">
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" class="form-control" placeholder="Enter your email" required>
                        </div>
                        <div class="form-group password-group">
                            <label>Password</label>
                            <input type="password" class="form-control" placeholder="Enter your password" required>
                            <i class="fas fa-eye password-toggle-icon"></i>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                    </form>
                    
                    <div class="social-login">
                        <button class="google-btn">
                            <img src="https://cdn.iconscout.com/icon/free/png-256/free-google-160-189824.png" alt="Google">
                            Sign in with Google
                        </button>
                    </div>

                    <div class="auth-switch">
                        <p>Don't have an account? <a href="#register" onclick="navigateTo('register')">Register</a></p>
                        <p style="margin-top: 10px;"><a href="#home" onclick="navigateTo('home')">Back to Home</a></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- REGISTER PAGE SECTION -->
        <div id="register-page" class="page-section">
            <div class="container">
                <div class="auth-container">
                    <h2 class="auth-title">Create Account</h2>
                    <form id="registerForm">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="registerName" class="form-control" placeholder="Enter full name" required>
                        </div>
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="registerEmail" class="form-control" placeholder="Enter email" required>
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" id="registerPhone" class="form-control" placeholder="Enter phone number" required>
                        </div>
                        <div class="form-group password-group">
                            <label>Password</label>
                            <input type="password" class="form-control" placeholder="Create password" required>
                             <i class="fas fa-eye password-toggle-icon"></i>
                        </div>
                        <div class="form-group password-group">
                            <label>Confirm Password</label>
                            <input type="password" class="form-control" placeholder="Confirm password" required>
                             <i class="fas fa-eye password-toggle-icon"></i>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">Register</button>
                    </form>
                    
                    <div class="social-login">
                        <button class="google-btn">
                            <img src="https://cdn.iconscout.com/icon/free/png-256/free-google-160-189824.png" alt="Google">
                            Sign in with Google
                        </button>
                    </div>

                    <div class="auth-switch">
                        <p>Already have an account? <a href="#login" onclick="navigateTo('login')">Login</a></p>
                        <p style="margin-top: 10px;"><a href="#home" onclick="navigateTo('home')">Back to Home</a></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- PROFILE PAGE SECTION -->
        <div id="profile-page" class="page-section">
            <div class="container">
                <div class="profile-container">
                    <!-- Sidebar -->
                    <div class="sidebar">
                        <div class="profile-card">
                            <div class="profile-picture">
                                <i class="fa-solid fa-face-grin"></i>
                            </div>
                            <h2 class="profile-name" id="profileNameDisplay">User Name</h2>
                            <p class="profile-email" id="profileEmailDisplay">user@email.com</p>
                        </div>
                        
                        <div class="nav-menu" id="profileNav">
                            <a href="#" class="nav-item active" onclick="event.preventDefault(); showProfileSection('setup')">
                                <i class="fas fa-user-cog"></i>
                                Profile Setup
                            </a>
                            <a href="#" class="nav-item" onclick="event.preventDefault(); showProfileSection('location')">
                                <i class="fas fa-map-marker-alt"></i>
                                Location Setup
                            </a>
                            <a href="#" class="nav-item" onclick="event.preventDefault(); showProfileSection('tracking')">
                                <i class="fas fa-box"></i>
                                Order History
                            </a>
                            <a href="#" class="nav-item" onclick="event.preventDefault(); logout()">
                                <i class="fas fa-sign-out-alt"></i>
                                Logout
                            </a>
                        </div>
                    </div>
                    
                    <!-- Main Content -->
                    <div class="main-content">
                        <!-- Profile Setup Section -->
                        <section id="profile-section-setup" class="content-section active">
                            <div class="section-header">
                                <h2 class="section-title">Profile Information</h2>
                            </div>
                            <form id="profileSetupForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="profileName" class="form-label">Full Name</label>
                                        <input type="text" id="profileName" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label for="profilePhone" class="form-label">Phone Number</label>
                                        <input type="tel" id="profilePhone" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="profileEmail" class="form-label">Email Address</label>
                                    <input type="email" id="profileEmail" class="form-control" disabled>
                                </div>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </form>
                        </section>
                        <!-- Location Setup Section (Updated) -->
                        <section id="profile-section-location" class="content-section">
                            <div class="section-header">
                                <h2 class="section-title">Manage Your Addresses</h2>
                            </div>
                            
                            <div id="addressListContainer">
                                <button id="showAddAddressFormBtn" class="add-address-btn">+ Add address</button>
                                <div id="savedAddressesUI" class="locations-list"></div>
                            </div>

                            <form id="newAddressForm" style="display: none; background: #f9fafb; padding: 20px; border-radius: 8px; border: 1px solid #eee;">
                                <h4 style="margin-bottom: 20px;" id="addressFormTitle">Add New Address</h4>
                                <input type="hidden" id="editAddressId" value="">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="addrTitle">Location Title (e.g. Home, Office)</label>
                                        <input type="text" id="addrTitle" class="form-control" placeholder="Home">
                                    </div>
                                    <div class="form-group">
                                        <label for="addrName">Full Name</label>
                                        <input type="text" id="addrName" class="form-control" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="addrPhone">Mobile Number</label>
                                        <input type="tel" id="addrPhone" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="addrEmail">Email Address</label>
                                        <input type="email" id="addrEmail" class="form-control" readonly style="background-color: #e5e7eb;">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="addrRegion">Region</label>
                                        <select id="addrRegion" class="form-control" required>
                                            <option value="">Select Region...</option>
                                            <option value="Inside Dhaka">Inside Dhaka</option>
                                            <option value="Outside Dhaka">Outside Dhaka</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="addrPostCode">Post Code</label>
                                        <input type="number" id="addrPostCode" class="form-control" min="1000" max="9999" placeholder="E.g., 1205" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="addrFull">Full Address</label>
                                    <textarea id="addrFull" class="form-control" rows="3" required placeholder="E.g., House No, Road, Area, Thana"></textarea>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button type="button" class="btn btn-outline" id="cancelAddressBtn">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Save Address</button>
                                </div>
                            </form>
                        </section>
                        <!-- Order History Section -->
                        <section id="profile-section-tracking" class="content-section">
                            <div class="section-header">
                                <h2 class="section-title">Order History</h2>
                            </div>
                            <div id="userOrdersList">
                                <div style="text-align: center; padding: 40px; color: var(--gray);">
                                    <i class="fas fa-receipt fa-3x"></i>
                                    <p style="margin-top: 15px;">Loading orders...</p>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </div>

    </main>
    
    <!-- Footer -->
    <footer id="contact">
        <div class="container">
            <div class="footer-content">
                <div class="footer-about">
                    <a href="#home" class="footer-logo" onclick="navigateTo('home')">
                        <img id="footerLogo" src="" alt="Logo">
                    </a>
                    <p id="footerAboutText"></p>
                    <div class="social-icons" id="footerSocials"></div>
                </div>
                
                <div class="footer-links">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="#home" onclick="navigateTo('home')">Home</a></li>
                        <li><a href="#shop" onclick="navigateTo('home')">Shop</a></li>
                        <li><a href="#offers" onclick="navigateTo('home')">Offers</a></li>
                        <li><a href="#contact" onclick="navigateTo('home')">Contact</a></li>
                    </ul>
                </div>
                
                <div class="footer-contact">
                    <h3>Contact Info</h3>
                    <p><i class="fas fa-map-marker-alt"></i> <span id="footerAddress"></span></p>
                    <p><i class="fas fa-phone"></i> <span id="footerPhone"></span></p>
                    <p><i class="fas fa-envelope"></i> <span id="footerEmail"></span></p>
                </div>
            </div>
            <div class="copyright">
                <p id="footerCopyright"></p>
            </div>
        </div>
    </footer>

    <!-- Cart Sidebar -->
    <div class="cart-overlay" id="cartOverlay">
        <div class="cart-header">
            <h2>Your Cart</h2>
            <button class="close-cart" id="closeCart">&times;</button>
        </div>
        <div class="cart-items" id="cartItems">
            <p class="empty-cart-message" id="emptyCartMessage">Your cart is empty</p>
        </div>
        <div class="cart-footer">
            <div class="cart-total">
                <span>Total:</span>
                <span id="cartTotalPrice">0.00</span>
            </div>
            <button class="btn btn-primary btn-block" id="checkoutBtn" style="width: 100%;">Proceed to Checkout</button>
        </div>
    </div>
    
    <div id="lightbox" class="lightbox">
      <span class="close-lightbox" id="closeLightbox">&times;</span>
      <img class="lightbox-content" id="lightboxImg">
    </div>

    <!-- Options panel is hidden as Variants will be displayed in main detail section -->
    <div class="options-panel-overlay" id="optionsPanelOverlay" style="display:none;"></div>
    
    <div class="custom-alert-overlay" id="customAlert">
        <div class="custom-alert-box">
            <h3 id="customAlertTitle">Alert</h3>
            <p id="customAlertMessage">Message goes here.</p>
            <div class="custom-alert-actions">
                <button class="btn btn-outline" id="customAlertCancel">Cancel</button>
                <button class="btn btn-primary" id="customAlertOk">OK</button>
            </div>
        </div>
    </div>

    <div class="welcome-overlay" id="welcomeOverlay">
        <div class="welcome-box">
            <div style="position: relative; text-align: center; max-width: 90vw;">
                <img id="welcomeLogo" src="" alt="Promo" style="max-width: 100%; max-height: 70vh; border-radius: 12px; object-fit: contain;">
                <button class="btn btn-primary" id="welcomeActionBtn" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); border-radius: 30px; padding: 10px 40px; font-weight: bold; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3); white-space: nowrap;">Shop Now</button>
            </div>
            <button class="ad-close-btn" id="closeWelcomeOverlay" style="position: static; margin-top: 20px; background: transparent; border: 2px solid white; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; padding: 0; color: white;">
                <i class="fas fa-times" style="font-size: 22px;"></i>
            </button>
            <div id="adCountdown" style="color: white; margin-top: 10px; font-size: 14px; text-align: center;">Auto close in 5s</div>
        </div>
    </div>

    <div class="promo-popup" id="promoPopup">
        <div class="promo-popup-discount" id="promoPopupDiscount">20%<br>OFF</div>
        <button class="promo-popup-close" id="promoPopupClose">&times;</button>
        <img src="" alt="Promo Product" class="promo-popup-img" id="promoPopupImg">
        <div class="promo-popup-content">
            <h4 id="promoPopupName">Product Title (20 character Max)</h4>
            <div class="price">
                <span class="current-price" id="promoPopupPrice">0.00 </span>
                <span class="original-price" id="promoPopupOldPrice">0.00 </span>
            </div>
            <button class="btn" id="promoPopupAction">Buy Now</button>
        </div>
    </div>

    <div class="order-details-overlay" id="orderDetailsOverlay">
        <div class="order-details-modal">
            <div class="od-header">
                <h3>Order Details</h3>
                <button id="closeOrderDetails">&times;</button>
            </div>
            <div class="od-section" id="odBody" style="border-bottom: 8px solid #f5f5f5;"></div>
            <div class="od-section" style="border-bottom: 8px solid #f5f5f5;">
                <h4 style="margin-bottom: 15px; font-size: 1rem;">Order Summary</h4>
                <div class="od-row"><span>Subtotal</span><span id="odSubtotal"></span></div>
                <div class="od-row"><span>Shipping Fee</span><span id="odShipping"></span></div>
                <div class="od-row"><span>COD Handling Fee</span><span id="odCOD"></span></div>
                <div class="od-total od-row"><span style="color:#333;">Total</span><span id="odTotal"></span></div>
            </div>
            <div class="od-section" style="border-bottom: 8px solid #f5f5f5;">
                <h4 style="margin-bottom: 10px; font-size: 1rem;">Paid by</h4>
                <div class="od-row"><span id="odPaidMethodName">Cash on Delivery</span><span id="odPaidAmount"></span></div>
            </div>
            <div class="od-section od-meta-section">
                <div class="od-row"><span>Order No.</span><span><span id="odOrderNo" style="color:#333;font-weight:600;"></span> <a href="#" id="odCopy" style="color:var(--primary);text-decoration:none;margin-left:5px;font-weight:600;">Copy</a></span></div>
                <div class="od-row"><span>Placed on</span><span id="odDate" style="color:#333;"></span></div>
                <div class="od-row"><span>Paid by</span><span id="odPaymentMethod" style="color:#333;"></span></div>
            </div>
            <div class="od-actions">
                <button class="btn btn-primary" id="odContinueShopping" style="width: 100%;">Continue Shopping</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD5p-7Cgep9aGf6omMXDH8LOTy0C76jJaQ",
            authDomain: "e-commerce-shop-24.firebaseapp.com",
            projectId: "e-commerce-shop-24",
            storageBucket: "e-commerce-shop-24.firebasestorage.app",
            messagingSenderId: "1000897291264",
            appId: "1:1000897291264:web:4f1e78554c3e69d310a4e5",
            measurementId: "G-MCFXRFDFT5"
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        let products = [];
        let heroSlidesData = [];
        let cart =[];
        let currentProduct = null;
        let imageSliderInterval = null;
        let selectedVariant = null;
        let actionToConfirm = null; 
        let isLoggedIn = false;
        let isAuthResolved = false;
        let currentUser = null;
        let savedAddresses = [];
        let currentlyDisplayedProducts =[];
        let lastSearchTerm = '';
        let paymentGateways =[];
        let randomPopups = []; // Variable to store random popups from admin
        let searchHistory = JSON.parse(localStorage.getItem('searchHistory')) || [];

        const productGrid = document.getElementById('productGrid');
        const cartIcon = document.getElementById('cartIcon');
        const cartOverlay = document.getElementById('cartOverlay');
        const closeCart = document.getElementById('closeCart');
        const cartItems = document.getElementById('cartItems');
        const emptyCartMessage = document.getElementById('emptyCartMessage');
        const cartTotalPrice = document.getElementById('cartTotalPrice');
        const cartCount = document.querySelector('.cart-count');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const checkoutForm = document.getElementById('checkoutForm');
        const menuToggle = document.getElementById('menuToggle');
        const mobileMenu = document.getElementById('mobileMenu');
        const shopNowBtn = document.querySelector('.btn-shop');
        const heroBg = document.getElementById('heroBg');

        const detailMainImg = document.getElementById('detailMainImg');
        const detailThumbnails = document.getElementById('detailThumbnails');
        const detailName = document.getElementById('detailName');
        const detailPrice = document.getElementById('detailPrice');
        const detailOldPrice = document.getElementById('detailOldPrice');
        const detailDesc = document.getElementById('detailDesc');
        const detailRating = document.getElementById('detailRating');
        const detailVariantSelectors = document.getElementById('detailVariantSelectors');
        const detailQty = document.getElementById('detailQty');
        const detailIncQty = document.getElementById('detailIncQty');
        const detailDecQty = document.getElementById('detailDecQty');
        const detailAddToCartSticky = document.getElementById('detailAddToCartSticky');
        const detailBuyNowSticky = document.getElementById('detailBuyNowSticky');
        const soldOutDisplay = document.getElementById('soldOutDisplay');
        const stickyActionsBar = document.getElementById('stickyActionsBar');
        
        const allPages = document.querySelectorAll('.page-section');
        const searchResultsGrid = document.getElementById('searchResultsGrid');
        const searchResultsTitle = document.getElementById('searchResultsTitle');
        const searchPageForm = document.getElementById('searchPageForm');
        const searchPageInput = document.getElementById('searchPageInput');
        const searchSuggestionsList = document.getElementById('search-suggestions-list');
        const searchHistoryTags = document.getElementById('searchHistoryTags');
        const searchHistorySection = document.getElementById('searchHistorySection');
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightboxImg');
        const closeLightbox = document.getElementById('closeLightbox');
        const progressBar = document.getElementById('progressBar');
        const customAlert = document.getElementById('customAlert');
        const welcomeOverlay = document.getElementById('welcomeOverlay');
        const promoPopup = document.getElementById('promoPopup');

        async function loadInitialData() {
            try {
                const settingsSnap = await db.collection('settings').doc('general').get();
                if(settingsSnap.exists) {
                    const data = settingsSnap.data();
                    document.getElementById('pageTitle').textContent = data.siteName || 'Online Shop';
                    document.getElementById('headerLogo').src = data.logoUrl || '';
                    document.getElementById('footerLogo').src = data.logoUrl || '';
                    document.getElementById('heroTitle').textContent = data.heroTitle || '';
                    document.getElementById('heroDesc').textContent = data.heroDesc || '';
                    document.getElementById('offerTitle').textContent = data.offerTitle || '';
                    document.getElementById('offerSubtitle').textContent = data.offerSubtitle || '';
                    document.getElementById('offerDesc').textContent = data.offerDesc || '';
                    document.getElementById('deliveryInsideTk').textContent = `${data.deliveryInside || 0}`;
                    document.getElementById('deliveryOutsideTk').textContent = `${data.deliveryOutside || 0}`;
                    document.getElementById('footerAboutText').textContent = data.footerAbout || '';
                    document.getElementById('footerAddress').textContent = data.footerAddress || '';
                    document.getElementById('footerPhone').textContent = data.footerPhone || '';
                    document.getElementById('footerEmail').textContent = data.footerEmail || '';
                    document.getElementById('footerCopyright').innerHTML = data.footerCopyright || '';
                }

                // Load all Popups and sort by type
                const popupsSnap = await db.collection('popups').get();
                let openingPopup = null;
                randomPopups = [];
                popupsSnap.forEach(doc => {
                    const p = doc.data();
                    if(p.section === 'opening') openingPopup = p;
                    else if(p.section === 'random-product') randomPopups.push(p);
                });

                if(openingPopup) {
                    const welcomeLogo = document.getElementById('welcomeLogo');
                    welcomeLogo.src = openingPopup.bannerLogo || '';
                    
                    if(openingPopup.actionButton) {
                        const actionBtn = document.getElementById('welcomeActionBtn');
                        actionBtn.style.display = 'block';
                        actionBtn.textContent = openingPopup.actionButtonName || 'Shop Now';
                        actionBtn.onclick = () => { 
                            if(openingPopup.actionButtonLink) window.location.href = openingPopup.actionButtonLink; 
                            document.getElementById('welcomeOverlay').classList.remove('active');
                        };
                    }
                } else {
                    document.getElementById('welcomeOverlay').style.display = 'none';
                }

                const catSnap = await db.collection('categories').get();
                const categoryGrid = document.getElementById('categoryGrid');
                categoryGrid.innerHTML = '';
                catSnap.forEach(doc => {
                    const cat = doc.data();
                    let iconHtml = '';
                    if (cat.mediaType === 'image' && cat.imageUrl) {
                         iconHtml = `<img src="${cat.imageUrl}" alt="${cat.name}">`;
                    } else {
                         iconHtml = `<div class="category-icon"><i class="${cat.iconClass || 'fas fa-box'}"></i></div>`;
                    }
                    
                    categoryGrid.innerHTML += `
                        <div class="category-card" data-category="${cat.slug}" title="Shop for ${cat.name}">
                            ${iconHtml}
                            <h3>${cat.name}</h3>
                        </div>
                    `;
                });

                const socialSnap = await db.collection('socials').get();
                const socialGrid = document.getElementById('footerSocials');
                socialGrid.innerHTML = '';
                socialSnap.forEach(doc => {
                    const social = doc.data();
                    socialGrid.innerHTML += `<a href="${social.url}" class="social-icon" target="_blank"><i class="${social.iconClass}"></i></a>`;
                });

                const slidesSnap = await db.collection('heroSlides').orderBy('order').get();
                heroSlidesData =[];
                slidesSnap.forEach(doc => { heroSlidesData.push(doc.data()); });

                const gatewaysSnap = await db.collection('paymentGateways').get();
                paymentGateways =[];
                gatewaysSnap.forEach(doc => {
                    paymentGateways.push({ id: doc.id, ...doc.data() });
                });

                const prodSnap = await db.collection('products').get();
                products =[];
                prodSnap.forEach(doc => {
                    const data = doc.data();
                    if(data.status !== 'Inactive') {
                        products.push({ id: doc.id, ...data });
                    }
                });
                currentlyDisplayedProducts = [...products];
                
                renderSearchHistory();
            } catch(e) {
                console.error("Error loading data from Firebase: ", e);
            }
        }

        function init() {
            renderSkeletons(4, productGrid);
            setTimeout(() => {
                applyFilterAndRender(products, 'default', productGrid);
            }, 1500);
            
            setupEventListeners();
            startOfferTimer();
            updateCartCount();
            initHeroSlider();

            window.addEventListener('hashchange', handleRouteChange);
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    currentUser = { 
                        name: userDoc.exists ? userDoc.data().name : (user.displayName || 'User'), 
                        email: user.email, 
                        phone: userDoc.exists ? userDoc.data().phone : '' 
                    };
                    
                    if(userDoc.exists && userDoc.data().addresses) {
                        savedAddresses = userDoc.data().addresses;
                    } else {
                        savedAddresses = [];
                    }

                    let profilePicHtml = '<i class="fa-solid fa-face-grin"></i>';
                    if (user.photoURL) {
                        profilePicHtml = `<img src="${user.photoURL}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;" alt="Profile Picture">`;
                    }
                    const menuPic = document.querySelector('#menuProfileSection .profile-picture');
                    const profileCardPic = document.querySelector('.profile-card .profile-picture');
                    if (menuPic) menuPic.innerHTML = profilePicHtml;
                    if (profileCardPic) profileCardPic.innerHTML = profilePicHtml;

                    isLoggedIn = true;
                } else {
                    isLoggedIn = false;
                    currentUser = null;
                    savedAddresses = [];
                }
                updateAuthStateUI();

                if (!isAuthResolved) {
                    isAuthResolved = true;
                    handleRouteChange(true);
                } else {
                    const path = window.location.hash.substring(1) || 'home';
                    const pageId = path.split('?')[0];
                    if (!isLoggedIn && (pageId === 'profile' || pageId === 'checkout')) {
                        navigateTo('login');
                    } else if (isLoggedIn && (pageId === 'login' || pageId === 'register')) {
                        navigateTo('profile');
                    } else if (pageId === 'profile') {
                        populateProfileData(); 
                    }
                }
            });
        }

        function simulatePageLoad(pageLoadFunction) {
            progressBar.style.opacity = '1';
            progressBar.style.width = '0%';
            setTimeout(() => { progressBar.style.width = '90%'; }, 10);
            setTimeout(() => {
                if (pageLoadFunction) pageLoadFunction();
                progressBar.style.width = '100%';
                setTimeout(() => {
                    progressBar.style.opacity = '0';
                    setTimeout(() => { progressBar.style.width = '0%'; }, 300);
                }, 400);
            }, 500); 
        }

        function handleRouteChange(isInitialLoad = false) {
            if (!isAuthResolved) return;
            
            const path = window.location.hash.substring(1) || 'home';
            const[pageId, queryString] = path.split('?');
            const params = new URLSearchParams(queryString);

            const displayPageAndData = () => {
                let finalPageId = pageId;
                if (!isLoggedIn && (finalPageId === 'profile' || finalPageId === 'checkout')) {
                    finalPageId = 'login';
                }

                allPages.forEach(p => p.classList.remove('active'));
                const targetPage = document.getElementById(`${finalPageId}-page`);

                if (targetPage) {
                    targetPage.classList.add('active');
                } else {
                    document.getElementById('home-page').classList.add('active');
                }
                window.scrollTo(0, 0);

                if (imageSliderInterval) {
                    clearInterval(imageSliderInterval);
                    imageSliderInterval = null;
                }

                document.querySelectorAll('.filter-options-dropdown').forEach(d => d.classList.remove('active'));

                if (finalPageId === 'product-details' && params.has('id')) {
                    const productId = params.get('id');
                    if (productId) { openProductPage(productId); }
                } else if (finalPageId === 'profile') {
                    populateProfileData();
                } else if (finalPageId === 'checkout') {
                    populateCheckoutAddresses();
                    renderPaymentMethods();
                } else if (finalPageId === 'search') {
                    renderSearchHistory();
                    searchPageInput.focus();
                }
            };
            
            if (isInitialLoad === true) {
                displayPageAndData();
            } else {
                simulatePageLoad(displayPageAndData);
            }
        }
        
        function navigateTo(path) {
            const currentPath = window.location.hash.substring(1) || 'home';
            if (currentPath.split('?')[0] === path.split('?')[0]) {
                 handleRouteChange(); return;
            }
            window.location.hash = path;
        }

        function goBack() { history.back(); }
        
        function toggleFilterDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            dropdown.classList.toggle('active');
        }

        function showCustomAlert(title, message, onOkCallback = null) {
            document.getElementById('customAlertTitle').textContent = title;
            document.getElementById('customAlertMessage').textContent = message;
            
            const okBtn = document.getElementById('customAlertOk');
            const cancelBtn = document.getElementById('customAlertCancel');
            
            cancelBtn.style.display = 'none';
            okBtn.textContent = 'OK';

            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);

            newOkBtn.addEventListener('click', () => {
                customAlert.classList.remove('active');
                if (onOkCallback) onOkCallback();
            });

            customAlert.classList.add('active');
        }

        function requireLogin(callback) {
            if (!isLoggedIn) {
                const title = "Login Required";
                const message = "You need to be logged in to perform this action.";
                const okBtn = document.getElementById('customAlertOk');
                const cancelBtn = document.getElementById('customAlertCancel');
                document.getElementById('customAlertTitle').textContent = title;
                document.getElementById('customAlertMessage').textContent = message;
                cancelBtn.style.display = 'inline-flex';
                okBtn.textContent = "Go to Login";
                const newOkBtn = okBtn.cloneNode(true);
                okBtn.parentNode.replaceChild(newOkBtn, okBtn);
                const newCancelBtn = cancelBtn.cloneNode(true);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

                newOkBtn.addEventListener('click', () => {
                    customAlert.classList.remove('active');
                    navigateTo('login');
                });
                newCancelBtn.addEventListener('click', () => {
                    customAlert.classList.remove('active');
                });
                customAlert.classList.add('active');
                return false;
            }
            if (callback) callback();
            return true;
        }

        function renderSkeletons(count, targetGrid) {
            targetGrid.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const skeletonCard = document.createElement('div');
                skeletonCard.className = 'skeleton-card';
                skeletonCard.innerHTML = `
                    <div class="skeleton-img"></div>
                    <div class="skeleton-info">
                        <div class="skeleton-line"></div>
                        <div class="skeleton-line short"></div>
                        <div class="skeleton-line" style="width: 80%;"></div>
                    </div>
                `;
                targetGrid.appendChild(skeletonCard);
            }
        }

        function showProfileSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(`profile-section-${sectionId}`).classList.add('active');
            document.querySelectorAll('#profileNav .nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`#profileNav .nav-item[onclick*="'${sectionId}'"]`).classList.add('active');
        }

        function updateAuthStateUI() {
            if (isLoggedIn) {
                document.body.classList.add('user-logged-in');
                document.getElementById('menuProfileSection').style.display = 'block';
                document.getElementById('menuProfileName').textContent = currentUser?.name || 'User';
            } else {
                document.body.classList.remove('user-logged-in');
                document.getElementById('menuProfileSection').style.display = 'none';
            }
        }

        async function logout() {
            try {
                await auth.signOut();
                isLoggedIn = false;
                currentUser = null;
                updateAuthStateUI();
                navigateTo('home');
                showNotification("You have been logged out.");
            } catch(e) {
                console.error("Logout Error:", e);
            }
        }

        function populateProfileData() {
            if (currentUser) {
                document.getElementById('profileNameDisplay').textContent = currentUser.name;
                document.getElementById('profileEmailDisplay').textContent = currentUser.email;
                document.getElementById('profileName').value = currentUser.name;
                document.getElementById('profileEmail').value = currentUser.email;
                document.getElementById('profilePhone').value = currentUser.phone;
                fetchUserOrders();
                renderSavedAddressesList();
            }
        }
        
        async function fetchUserOrders() {
            if (!isLoggedIn || !currentUser) return;
            const ordersContainer = document.getElementById('userOrdersList');
            ordersContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--gray);"><i class="fas fa-spinner fa-spin fa-3x"></i><p style="margin-top: 15px;">Loading your orders...</p></div>';
            
            try {
                const snap = await db.collection('orders').where('userId', '==', auth.currentUser.uid).get();
                if (snap.empty) {
                    ordersContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--gray);">
                            <i class="fas fa-receipt fa-3x"></i>
                            <p style="margin-top: 15px;">You have no active orders.</p>
                        </div>`;
                    return;
                }
                
                let ordersHtml = '';
                snap.forEach(doc => {
                    const order = doc.data();
                    let itemsHtml = '';
                    if (order.cartItems && order.cartItems.length > 0) {
                        order.cartItems.forEach(item => {
                            let vStr = '';
                            if (item.color && item.color !== 'N/A') vStr += item.color;
                            if (item.size && item.size !== 'N/A') vStr += (vStr ? ', ' : '') + item.size;
                            if (vStr) vStr = ` <span style="font-size:0.8rem; color:var(--gray)">(${vStr})</span>`;
                            
                            itemsHtml += `
                                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:10px;">
                                    <img src="${item.image}" style="width:50px; height:50px; object-fit:cover; border-radius:4px;">
                                    <div style="flex:1;">
                                        <div style="font-weight:500; font-size:0.95rem;">${item.name}${vStr}</div>
                                        <div style="font-size:0.85rem; color:var(--gray);">Qty: ${item.qty} | ${item.price}</div>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    
                    ordersHtml += `
                        <div style="border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: left; background: #fff;">
                            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px;">
                                <div>
                                    <span style="font-weight:600;">Order #${order.id.substring(0,8)}</span><br>
                                    <span style="font-size:0.85rem; color:var(--gray);">${order.date}</span>
                                </div>
                                <div style="text-align: right;">
                                    <span style="display:inline-block; padding:3px 10px; border-radius:12px; font-size:0.8rem; font-weight:600; background:#eef2ff; color:var(--primary);">${order.status || 'Pending'}</span>
                                </div>
                            </div>
                            ${itemsHtml}
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                                <div style="font-weight:600; color:var(--primary);">Total: ${order.amount}</div>
                                <button class="btn btn-outline" style="padding: 5px 15px; font-size: 0.85rem;" onclick="showOrderTracking('${order.id}', '${order.status || 'Pending'}')">Track Order</button>
                            </div>
                        </div>
                    `;
                });
                ordersContainer.innerHTML = ordersHtml;
            } catch (e) {
                console.error("Error fetching orders:", e);
                ordersContainer.innerHTML = '<p>Error loading orders.</p>';
            }
        }

        function showOrderTracking(orderId, status) {
            showCustomAlert('Tracking Info', `Order #${orderId.substring(0,8)} is currently: ${status}. We will notify you upon further updates.`);
        }
        
        function toggleMenu() {
            menuToggle.classList.toggle('active');
            mobileMenu.classList.toggle('active');
        }

        function initHeroSlider() {
            let currentSlideIndex = 0;
            heroBg.innerHTML = '';
            heroSlidesData.forEach((slide, index) => {
                const slideEl = document.createElement('div');
                slideEl.className = `hero-slide ${index === 0 ? 'active' : ''}`;
                if (slide.type === 'image') {
                    const img = document.createElement('img');
                    img.src = slide.src;
                    slideEl.appendChild(img);
                } else if (slide.type === 'iframe') {
                    const iframe = document.createElement('iframe');
                    iframe.src = slide.src;
                    iframe.allow = "autoplay; encrypted-media";
                    slideEl.appendChild(iframe);
                }
                heroBg.appendChild(slideEl);
            });
            const slides = document.querySelectorAll('.hero-slide');
            if(slides.length <= 1) return;
            function showNextSlide() {
                slides[currentSlideIndex].classList.remove('active');
                currentSlideIndex = (currentSlideIndex + 1) % slides.length;
                slides[currentSlideIndex].classList.add('active');
                const delay = heroSlidesData[currentSlideIndex].type === 'iframe' ? 15000 : 3000;
                setTimeout(showNextSlide, delay);
            }
            setTimeout(showNextSlide, 3000);
        }
        
        function renderProducts(productsToRender, targetGrid) {
            targetGrid.innerHTML = '';
            if (productsToRender.length === 0) {
                targetGrid.innerHTML = `<div class="empty-state"><i class="fas fa-box-open"></i><h3>No Products Found</h3><p>Try searching for something else or adjusting filters.</p></div>`;
                return;
            }
            productsToRender.forEach(product => {
                const totalStock = product.variants && product.variants.length > 0 
                                   ? product.variants.reduce((sum, v) => sum + v.stock, 0)
                                   : (product.stock || 0);

                const isOutOfStock = product.status === 'Out of Stock' || totalStock <= 0;
                
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.dataset.id = product.id;
                
                const price = product.variants && product.variants.length > 0 ? product.variants[0].price : (product.price || 0);
                const originalPrice = product.originalPrice ? product.originalPrice : 0;
                const discountPercentage = originalPrice > price ? Math.round(((originalPrice - price) / originalPrice) * 100) : 0;
                
                const discountBadge = discountPercentage > 0 ? `<div class="off-badge">-${discountPercentage}%</div>` : '';
                const watermark = isOutOfStock ? `<div class="out-of-stock-banner">OUT OF STOCK</div>` : '';
                const displayImg = (product.images && product.images.length > 0) ? product.images[0] : 'https://via.placeholder.com/200';

                productCard.innerHTML = `
                    <div class="img-frame">
                        <img src="${displayImg}" alt="${product.name}" class="product-img">
                        ${discountBadge}
                        ${watermark}
                    </div>
                    <div class="card-info">
                        <h3 class="product-title">${product.name}</h3>
                        <div class="price-group">
                            <span class="new-price">${price.toFixed(0)}</span>
                            ${originalPrice > price ? `<span class="old-price">${originalPrice.toFixed(0)}</span>` : ''}
                        </div>
                        <div class="rating-section">
                            <div class="star-set">
                                ${getStarRatingHTML(product.rating || 5)}
                            </div>
                            <span class="rater-count">(${product.rating || 5})</span>
                        </div>
                        <button class="btn-view">View more &rarr;</button>
                    </div>`;
                
                productCard.addEventListener('click', () => {
                     navigateTo(`product-details?id=${product.id}`);
                });

                targetGrid.appendChild(productCard);
            });
        }

        function renderSuggestedProducts(currentProd) {
            const grid = document.getElementById('suggestedProductsGrid');
            grid.innerHTML = '';
            
            const currentNameWords = currentProd.name.toLowerCase().split(' ');

            const suggested = products.filter(p => {
                if (p.id == currentProd.id) return false;
                const nameMatch = currentNameWords.some(word => word.length > 3 && p.name.toLowerCase().includes(word));
                const keywordMatch = p.keywords && currentProd.keywords && p.keywords.some(k => currentProd.keywords.includes(k));
                const categoryMatch = p.category && currentProd.category && p.category === currentProd.category;
                return nameMatch || keywordMatch || categoryMatch;
            }).slice(0, 4); 

            if (suggested.length === 0) {
                document.querySelector('.suggested-products-section').style.display = 'none';
                return;
            }
            document.querySelector('.suggested-products-section').style.display = 'block';
            
            suggested.forEach(product => {
                const totalStock = product.variants && product.variants.length > 0 
                                   ? product.variants.reduce((sum, v) => sum + v.stock, 0)
                                   : (product.stock || 0);

                const isOutOfStock = product.status === 'Out of Stock' || totalStock <= 0;
                const card = document.createElement('div');
                card.className = 'product-card';
                card.dataset.id = product.id;
                
                const price = product.variants && product.variants.length > 0 ? product.variants[0].price : (product.price || 0);
                const originalPrice = product.originalPrice ? product.originalPrice : 0;
                const discountPercentage = originalPrice > price ? Math.round(((originalPrice - price) / originalPrice) * 100) : 0;
                
                const discountBadge = discountPercentage > 0 ? `<div class="off-badge">-${discountPercentage}%</div>` : '';
                const watermark = isOutOfStock ? `<div class="out-of-stock-banner">OUT OF STOCK</div>` : '';
                const displayImg = (product.images && product.images.length > 0) ? product.images[0] : 'https://via.placeholder.com/200';

                card.innerHTML = `
                    <div class="img-frame">
                        <img src="${displayImg}" alt="${product.name}" class="product-img">
                        ${discountBadge}
                        ${watermark}
                    </div>
                    <div class="card-info">
                        <h3 class="product-title">${product.name}</h3>
                        <div class="price-group">
                            <span class="new-price">${price.toFixed(0)}</span>
                            ${originalPrice > price ? `<span class="old-price">${originalPrice.toFixed(0)}</span>` : ''}
                        </div>
                        <div class="rating-section">
                            <div class="star-set">
                                ${getStarRatingHTML(product.rating || 5)}
                            </div>
                            <span class="rater-count">(${product.rating || 5})</span>
                        </div>
                        <button class="btn-view">View more &rarr;</button>
                    </div>`;

                card.addEventListener('click', () => {
                    navigateTo(`product-details?id=${product.id}`);
                });
                grid.appendChild(card);
            });
        }

        function getStarRatingHTML(rating) {
            let stars = '';
            const fullStars = Math.floor(rating);
            for (let i = 0; i < fullStars; i++) stars += '<span class="material-symbols-outlined star">star</span>';
            const emptyStars = 5 - Math.ceil(rating);
            for (let i = 0; i < emptyStars; i++) stars += '<span class="material-symbols-outlined star-empty">star</span>';
            return stars;
        }

        function getStarRating(rating) { 
            let stars = '';
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;
            for (let i = 0; i < fullStars; i++) stars += '<i class="fas fa-star"></i>';
            if (halfStar) stars += '<i class="fas fa-star-half-alt"></i>';
            const emptyStars = 5 - Math.ceil(rating);
            for (let i = 0; i < emptyStars; i++) stars += '<i class="far fa-star"></i>';
            return stars;
        }

        function openProductPage(productId) {
            currentProduct = products.find(p => p.id == productId);
            if (!currentProduct) {
                navigateTo('home');
                return;
            }
            selectedVariant = null;
            
            detailName.textContent = currentProduct.name;
            const price = currentProduct.variants && currentProduct.variants.length > 0 ? currentProduct.variants[0].price : (currentProduct.price || 0);
            detailPrice.textContent = `${price.toFixed(2)}`;
            detailOldPrice.textContent = currentProduct.originalPrice > price ? `${currentProduct.originalPrice.toFixed(2)}` : '';
            detailDesc.textContent = currentProduct.description;
            detailRating.innerHTML = `${getStarRating(currentProduct.rating || 5)} <span>(${currentProduct.rating || 5})</span>`;
            detailQty.value = 1;
            
            const totalStock = currentProduct.variants && currentProduct.variants.length > 0 
                               ? currentProduct.variants.reduce((sum, v) => sum + v.stock, 0)
                               : (currentProduct.stock || 0);

            detailQty.max = totalStock || 1;
            document.getElementById('detailStockStatus').textContent = `(Total Stock: ${totalStock})`;
            
            const isOutOfStock = currentProduct.status === 'Out of Stock' || totalStock <= 0;
            
            if(isOutOfStock) {
                document.getElementById('detailAddToCartSticky').style.display = 'none';
                document.getElementById('detailBuyNowSticky').style.display = 'none';
                soldOutDisplay.style.display = 'block';
                stickyActionsBar.classList.add('sold-out-mode');
            } else {
                document.getElementById('detailAddToCartSticky').style.display = 'block';
                document.getElementById('detailBuyNowSticky').style.display = 'block';
                soldOutDisplay.style.display = 'none';
                stickyActionsBar.classList.remove('sold-out-mode');
            }
            
            const gatewaysContainer = document.getElementById('detailPaymentGateways');
            gatewaysContainer.innerHTML = '';
            if (currentProduct.allowedGateways && currentProduct.allowedGateways.length > 0) {
                let gatewayHtml = '<span style="font-size: 0.9rem; color: var(--dark); font-weight: 600; margin-right: 5px;">Payment Options:</span>';
                currentProduct.allowedGateways.forEach(gwId => {
                    if (gwId === 'COD') {
                        gatewayHtml += `<div title="Cash on Delivery" style="height: 28px; padding: 0 10px; border: 1px solid #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; font-size: 11px; font-weight: 700; color: var(--primary);">COD</div>`;
                    } else {
                        const gw = paymentGateways.find(g => g.id === gwId);
                        if (gw && gw.logo) {
                            gatewayHtml += `<img src="${gw.logo}" alt="${gw.name}" title="${gw.name}" style="height: 28px; width: auto; object-fit: contain; border: 1px solid #ddd; border-radius: 4px; padding: 2px; background: white;">`;
                        }
                    }
                });
                gatewaysContainer.innerHTML = gatewayHtml;
            }
            
            detailMainImg.src = currentProduct.images[0];
            detailThumbnails.innerHTML = '';
            
            currentProduct.images.forEach((imgSrc, index) => {
                const thumb = document.createElement('img');
                thumb.src = imgSrc;
                thumb.className = `thumbnail ${index === 0 ? 'active' : ''}`;
                thumb.onclick = () => {
                    if (imageSliderInterval) clearInterval(imageSliderInterval);
                    detailMainImg.src = imgSrc;
                    document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
                    thumb.classList.add('active');
                };
                detailThumbnails.appendChild(thumb);
            });
            
            // Render the updated variant selectors
            renderVariantSelectors(currentProduct, detailVariantSelectors);
            renderSuggestedProducts(currentProduct);
            
            let currentImageIndex = 0;
            const thumbnails = detailThumbnails.querySelectorAll('.thumbnail');
            if (imageSliderInterval) clearInterval(imageSliderInterval);
            if(currentProduct.images.length > 1) {
                imageSliderInterval = setInterval(() => {
                    currentImageIndex = (currentImageIndex + 1) % currentProduct.images.length;
                    detailMainImg.src = currentProduct.images[currentImageIndex];
                    thumbnails.forEach(t => t.classList.remove('active'));
                    if(thumbnails[currentImageIndex]) thumbnails[currentImageIndex].classList.add('active');
                }, 3000);
            }
        }
        
        let currentSelections = { color: null, size: null };

        function renderVariantSelectors(product, container) {
            container.innerHTML = '';
            if (!product.variants || product.variants.length === 0) return;

            // Render Colors / Main Variants
            let colorHTML = '<div class="variant-selector" id="colorSelectorBlock"><h4>Choose Variant:</h4><div class="variant-options">';
            product.variants.forEach((v, index) => {
                const isOutOfStock = v.stock <= 0;
                const discountHTML = v.discount > 0 ? `<div class="var-discount">-${v.discount}%</div>` : '';
                const imgHTML = v.image ? `<img src="${v.image}" class="variant-img" alt="${v.color}">` : '';
                const priceHTML = `<div class="var-price">${v.price}</div>`;
                const stockHTML = `<div class="var-stock">Stock: ${v.stock}</div>`;
                
                colorHTML += `
                    <div class="variant-option color-option ${isOutOfStock ? 'out-of-stock' : ''}" data-index="${index}">
                        ${discountHTML}
                        ${imgHTML}
                        <span class="var-name">${v.color}</span>
                        ${priceHTML}
                        ${stockHTML}
                    </div>
                `;
            });
            colorHTML += '</div></div>';
            
            // Size Selection container
            let sizeHTML = '<div class="variant-selector" id="sizeSelectorBlock" style="display:none;"><h4>Select Size:</h4><div class="variant-options" id="sizeOptionsContainer"></div></div>';
            
            container.innerHTML = colorHTML + sizeHTML;
            attachVariantListeners(container, product);
            
            // Auto select the first available color variant
            const firstAvailable = container.querySelector('.color-option:not(.out-of-stock)');
            if(firstAvailable) firstAvailable.click();
        }

        function attachVariantListeners(container, product) {
            const colorOptions = container.querySelectorAll('.color-option:not(.out-of-stock)');
            colorOptions.forEach(opt => {
                opt.addEventListener('click', function() {
                    colorOptions.forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    const variantIndex = this.dataset.index;
                    const selectedVar = product.variants[variantIndex];
                    
                    selectedVariant = selectedVar;
                    currentSelections.color = selectedVar.color;
                    currentSelections.size = null; 
                    
                    // Update Product Details Info
                    document.getElementById('detailPrice').textContent = `${selectedVar.price.toFixed(2)}`;
                    document.getElementById('detailOldPrice').textContent = (selectedVar.originalPrice && selectedVar.originalPrice > selectedVar.price) ? `${selectedVar.originalPrice.toFixed(2)}` : '';
                    if (selectedVar.image) {
                        document.getElementById('detailMainImg').src = selectedVar.image;
                        if(imageSliderInterval) clearInterval(imageSliderInterval);
                    }
                    
                    // Handle Sizes
                    const sizeBlock = container.querySelector('#sizeSelectorBlock');
                    const sizeContainer = container.querySelector('#sizeOptionsContainer');
                    
                    if (selectedVar.sizes && selectedVar.sizes.length > 0) {
                        sizeBlock.style.display = 'block';
                        let sizeHTML = '';
                        selectedVar.sizes.forEach((s) => {
                            const isSizeOut = s.stock <= 0;
                            sizeHTML += `
                                <div class="variant-option size-option ${isSizeOut ? 'out-of-stock' : ''}" data-size="${s.size}" data-stock="${s.stock}">
                                    <span class="var-name">${s.size}</span>
                                    <div class="var-stock">Stock: ${s.stock}</div>
                                </div>
                            `;
                        });
                        sizeContainer.innerHTML = sizeHTML;
                        
                        const sizeOptions = sizeContainer.querySelectorAll('.size-option:not(.out-of-stock)');
                        sizeOptions.forEach(sOpt => {
                            sOpt.addEventListener('click', function() {
                                sizeOptions.forEach(so => so.classList.remove('selected'));
                                this.classList.add('selected');
                                currentSelections.size = this.dataset.size;
                                
                                const sStock = parseInt(this.dataset.stock);
                                document.getElementById('detailStockStatus').textContent = `(Stock: ${sStock})`;
                                document.getElementById('detailQty').max = sStock;
                                if(parseInt(document.getElementById('detailQty').value) > sStock) {
                                    document.getElementById('detailQty').value = sStock || 1;
                                }
                                
                                // Merge Size data into selectedVariant for cart
                                selectedVariant = { ...selectedVar, size: currentSelections.size, stock: sStock };
                            });
                        });
                        
                        // Select first available size
                        const firstSize = sizeContainer.querySelector('.size-option:not(.out-of-stock)');
                        if(firstSize) {
                            firstSize.click();
                        } else {
                            document.getElementById('detailStockStatus').textContent = `(Stock: 0)`;
                            selectedVariant = null; 
                        }
                    } else {
                        sizeBlock.style.display = 'none';
                        document.getElementById('detailStockStatus').textContent = `(Stock: ${selectedVar.stock})`;
                        document.getElementById('detailQty').max = selectedVar.stock;
                        if(parseInt(document.getElementById('detailQty').value) > selectedVar.stock) {
                            document.getElementById('detailQty').value = selectedVar.stock || 1;
                        }
                    }
                });
            });
        }

        function addToCart(productId, quantity, variant) {
            const product = products.find(p => p.id == productId);
            if (!product) return;
            
            const variantId = variant ? (variant.color + (variant.size ? '-' + variant.size : '')) : 'no-variant';
            const cartId = `${productId}-${variantId}`;
            
            const existingItem = cart.find(item => item.cartId === cartId);
            
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                const itemPrice = variant ? variant.price : (product.price || 0);
                let itemName = product.name;
                if(variant) {
                   let varParts = [];
                   if(variant.color && variant.color !== 'N/A') varParts.push(variant.color);
                   if(variant.size && variant.size !== 'N/A') varParts.push(variant.size);
                   if(varParts.length > 0) itemName = `${product.name} (${varParts.join(', ')})`;
                }

                cart.push({ 
                    id: product.id,
                    pid: product.pid,
                    cartId: cartId,
                    name: itemName, 
                    price: itemPrice, 
                    image: (variant && variant.image) ? variant.image : product.images[0], 
                    quantity: quantity,
                    variant: variant,
                    selected: true,
                    color: variant ? variant.color : 'N/A',
                    size: variant ? variant.size : 'N/A'
                });
            }
            
            updateCartCount();
            renderCartItems();
            showNotification(`${product.name} added to cart!`);
        }

        function removeFromCart(cartId) {
            cart = cart.filter(item => item.cartId !== cartId);
            updateCartCount();
            renderCartItems();
        }

        function updateCartItemQuantity(cartId, quantity) {
            const item = cart.find(item => item.cartId === cartId);
            if (quantity < 1) {
                removeFromCart(cartId);
                return;
            }
            if (item) {
                item.quantity = quantity;
                updateCartCount();
                renderCartItems();
            }
        }

        function renderCartItems() {
            cartItems.innerHTML = '';
            if (cart.length === 0) {
                cartItems.innerHTML = `<div class="empty-state" style="padding:20px; box-shadow:none;"><i class="fas fa-shopping-cart"></i><p>Your cart is empty.</p></div>`;
                cartTotalPrice.textContent = '0.00';
                checkoutBtn.disabled = true;
                return;
            }
            
            emptyCartMessage.style.display = 'none';
            checkoutBtn.disabled = false;
            let total = 0;
            
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                if (item.selected) {
                    total += itemTotal;
                }

                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.dataset.id = item.id;
                cartItem.dataset.cartId = item.cartId;

                cartItem.innerHTML = `
                    <div class="cart-item-selector">
                        <input type="checkbox" class="cart-item-checkbox" ${item.selected ? 'checked' : ''}>
                    </div>
                    <div class="cart-item-details-link">
                        <div class="cart-item-img"><img src="${item.image}" alt="${item.name}"></div>
                        <div class="cart-item-info">
                            <h4>${item.name}</h4>
                            <div class="cart-item-price">${item.price.toFixed(2)}</div>
                        </div>
                    </div>
                    <div class="cart-item-actions">
                        <button class="qty-btn decrease-item">-</button>
                        <input type="number" class="cart-item-qty" value="${item.quantity}" min="1">
                        <button class="qty-btn increase-item">+</button>
                        <button class="remove-item"><i class="fas fa-trash"></i></button>
                    </div>`;
                cartItems.appendChild(cartItem);
            });
            
            cartTotalPrice.textContent = `${total.toFixed(2)}`;
            attachCartItemListeners();
        }

        function attachCartItemListeners() {
            document.querySelectorAll('.cart-item-details-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    const id = this.closest('.cart-item').dataset.id;
                    navigateTo(`product-details?id=${id}`);
                    cartOverlay.classList.remove('active');
                });
            });
            document.querySelectorAll('.decrease-item').forEach(btn => btn.addEventListener('click', function() {
                const cartId = this.closest('.cart-item').dataset.cartId;
                const item = cart.find(i => i.cartId === cartId);
                if(item) updateCartItemQuantity(cartId, item.quantity - 1);
            }));
            document.querySelectorAll('.increase-item').forEach(btn => btn.addEventListener('click', function() {
                const cartId = this.closest('.cart-item').dataset.cartId;
                const item = cart.find(i => i.cartId === cartId);
                if(item) updateCartItemQuantity(cartId, item.quantity + 1);
            }));
            document.querySelectorAll('.remove-item').forEach(btn => btn.addEventListener('click', function() {
                const cartId = this.closest('.cart-item').dataset.cartId;
                removeFromCart(cartId);
            }));
            document.querySelectorAll('.cart-item-checkbox').forEach(box => {
                box.addEventListener('change', function() {
                    const cartId = this.closest('.cart-item').dataset.cartId;
                    const item = cart.find(i => i.cartId === cartId);
                    if (item) {
                        item.selected = this.checked;
                        renderCartItems(); 
                    }
                });
            });
        }

        function updateCartCount() {
            const count = cart.length; 
            if (count > 0) {
                cartCount.textContent = count;
                cartCount.style.display = 'flex';
            } else {
                cartCount.style.display = 'none';
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed; bottom: 20px; left: 50%;
                transform: translateX(-50%);
                background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
                border: 1px solid rgba(255,255,255,0.1);
                color: white; font-weight: 500;
                padding: 12px 25px; border-radius: 25px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.4); z-index: 10000;
                animation: slideUp 0.5s ease;
            `;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => document.body.removeChild(notification), 500);
            }, 3000);
        }

        function addSearchHistory(term) {
            if(!term) return;
            searchHistory = searchHistory.filter(t => t !== term);
            searchHistory.unshift(term);
            if(searchHistory.length > 10) searchHistory.pop();
            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
            renderSearchHistory();
        }

        function renderSearchHistory() {
            searchHistoryTags.innerHTML = '';
            if(searchHistory.length === 0) {
                searchHistorySection.style.display = 'none';
            } else {
                searchHistorySection.style.display = 'block';
                searchHistory.forEach(term => {
                    const tag = document.createElement('div');
                    tag.className = 'search-tag';
                    tag.textContent = term;
                    tag.onclick = () => {
                        searchPageInput.value = term;
                        handleSearch(new Event('submit'), term);
                    };
                    searchHistoryTags.appendChild(tag);
                });
            }
        }

        document.getElementById('clearHistoryBtn').addEventListener('click', () => {
            searchHistory = [];
            localStorage.removeItem('searchHistory');
            renderSearchHistory();
        });
        
        function handleSearch(e, searchTermFromChip) {
            e.preventDefault();
            const term = (searchTermFromChip || searchPageInput.value).trim().toLowerCase();
            if (!term) return;
            
            lastSearchTerm = term;
            addSearchHistory(term);
            
            navigateTo('search-results');
            searchResultsTitle.textContent = `Searching for "${term}"...`;
            renderSkeletons(8, searchResultsGrid);
            
            setTimeout(() => {
                const filteredProducts = products.filter(p => {
                    const nameMatch = p.name.toLowerCase().includes(term);
                    let seoMatch = false;
                    if (p.seo_tag) {
                        let tags = [];
                        if (typeof p.seo_tag === 'string') {
                            tags = p.seo_tag.split(',').map(s=>s.trim().toLowerCase());
                        } else if (Array.isArray(p.seo_tag)) {
                            tags = p.seo_tag.map(s=>s.toLowerCase());
                        }
                        seoMatch = tags.some(t => t.includes(term));
                    }
                    const keywordMatch = p.keywords && p.keywords.some(k => k.toLowerCase().includes(term));
                    return nameMatch || seoMatch || keywordMatch;
                });
                
                searchResultsTitle.textContent = `Results for "${term}"`;
                currentlyDisplayedProducts = [...filteredProducts];
                applyFilterAndRender(currentlyDisplayedProducts, 'default', searchResultsGrid);
                searchSuggestionsList.style.display = 'none';
            }, 1000);
        }

        let editingAddressId = null;

        function renderSavedAddressesList() {
            const listContainer = document.getElementById('savedAddressesUI');
            listContainer.innerHTML = '';
            
            if (savedAddresses.length === 0) {
                listContainer.innerHTML = '<p style="color: var(--gray); text-align: center; padding: 20px;">No saved addresses found. Please add a new address.</p>';
            } else {
                savedAddresses.forEach((addr, index) => {
                    const isDefault = addr.isDefault || index === 0;
                    const html = `
                        <div class="address-box">
                            <div class="address-box-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="address-box-details">
                                <h5>${addr.name} <span class="phone">${addr.phone}</span></h5>
                                <p>${addr.address}</p>
                                <p>${addr.region} - ${addr.postcode}</p>
                                <div class="address-badges">
                                    ${addr.title ? `<span class="badge-title">${addr.title.toUpperCase()}</span>` : ''}
                                    ${isDefault ? `<span class="badge-default">Default shipping address</span>` : ''}
                                </div>
                            </div>
                            <button class="btn-edit-addr" onclick="openAddressForm(${index})">Edit</button>
                        </div>
                    `;
                    listContainer.innerHTML += html;
                });
            }
        }

        function populateCheckoutAddresses() {
            const listContainer = document.getElementById('checkoutSavedAddressesList');
            const addressManager = document.getElementById('checkoutAddressManagement');
            const newForm = document.getElementById('shippingInfoForm');
            
            listContainer.innerHTML = '';
            
            if (savedAddresses.length === 0) {
                addressManager.style.display = 'none';
                newForm.style.display = 'block';
                document.getElementById('coEmail').value = currentUser?.email || '';
            } else {
                addressManager.style.display = 'block';
                newForm.style.display = 'none';
                
                savedAddresses.forEach((addr, index) => {
                    const isDefault = addr.isDefault || index === 0;
                    const div = document.createElement('div');
                    div.className = `address-box ${isDefault ? 'selected' : ''}`;
                    div.onclick = (e) => {
                        if(e.target.classList.contains('btn-edit-addr')) return;
                        document.querySelectorAll('#checkoutSavedAddressesList .address-box').forEach(b => b.classList.remove('selected'));
                        div.classList.add('selected');
                    };

                    div.innerHTML = `
                        <div class="address-box-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="address-box-details">
                            <h5>${addr.name} <span class="phone">${addr.phone}</span></h5>
                            <p>${addr.address}</p>
                            <p>${addr.region} - ${addr.postcode}</p>
                            <div class="address-badges">
                                ${addr.title ? `<span class="badge-title">${addr.title.toUpperCase()}</span>` : ''}
                                ${isDefault ? `<span class="badge-default">Default shipping address</span>` : ''}
                            </div>
                        </div>
                        <button type="button" class="btn-edit-addr" onclick="openCheckoutAddressForm(${index})">Edit</button>
                    `;
                    listContainer.appendChild(div);
                });
            }
        }

        function openAddressForm(index = null) {
            document.getElementById('addressListContainer').style.display = 'none';
            document.getElementById('newAddressForm').style.display = 'block';
            
            if (index !== null && index >= 0) {
                const addr = savedAddresses[index];
                document.getElementById('addressFormTitle').textContent = 'Edit Address';
                document.getElementById('editAddressId').value = index;
                document.getElementById('addrTitle').value = addr.title || '';
                document.getElementById('addrName').value = addr.name || '';
                document.getElementById('addrPhone').value = addr.phone || '';
                document.getElementById('addrEmail').value = addr.email || currentUser?.email || '';
                document.getElementById('addrRegion').value = addr.region || '';
                document.getElementById('addrPostCode').value = addr.postcode || '';
                document.getElementById('addrFull').value = addr.address || '';
            } else {
                document.getElementById('addressFormTitle').textContent = 'Add New Address';
                document.getElementById('newAddressForm').reset();
                document.getElementById('editAddressId').value = '';
                document.getElementById('addrEmail').value = currentUser?.email || '';
                if(currentUser) {
                    document.getElementById('addrName').value = currentUser.name;
                    document.getElementById('addrPhone').value = currentUser.phone;
                }
            }
        }

        function openCheckoutAddressForm(index = null) {
            document.getElementById('checkoutAddressManagement').style.display = 'none';
            document.getElementById('shippingInfoForm').style.display = 'block';
            
            if (index !== null && index >= 0) {
                editingAddressId = index;
                const addr = savedAddresses[index];
                document.getElementById('coAddressTitle').value = addr.title || '';
                document.getElementById('coName').value = addr.name || '';
                document.getElementById('coPhone').value = addr.phone || '';
                document.getElementById('coEmail').value = addr.email || currentUser?.email || '';
                document.getElementById('coRegion').value = addr.region || '';
                document.getElementById('coPostCode').value = addr.postcode || '';
                document.getElementById('coAddress').value = addr.address || '';
            } else {
                editingAddressId = null;
                document.getElementById('coAddressTitle').value = '';
                document.getElementById('coName').value = currentUser?.name || '';
                document.getElementById('coPhone').value = currentUser?.phone || '';
                document.getElementById('coEmail').value = currentUser?.email || '';
                document.getElementById('coRegion').value = '';
                document.getElementById('coPostCode').value = '';
                document.getElementById('coAddress').value = '';
            }
        }

        async function saveAddressesToFirebase() {
            if(!auth.currentUser) return;
            try {
                if(savedAddresses.length > 0) {
                    let hasDefault = savedAddresses.some(a => a.isDefault);
                    if(!hasDefault) savedAddresses[0].isDefault = true;
                }
                await db.collection('users').doc(auth.currentUser.uid).update({ addresses: savedAddresses });
            } catch (error) {
                console.error("Error saving address:", error);
                showCustomAlert("Error", "Failed to save address to database.");
            }
        }
        
        function renderPaymentMethods() {
            const container = document.getElementById('checkoutPaymentMethods');
            container.innerHTML = '';
            
            const codDiv = document.createElement('div');
            codDiv.className = 'payment-method active';
            codDiv.dataset.method = 'Cash on Delivery';
            codDiv.innerHTML = `<i class="fas fa-money-bill-wave fa-2x"></i><p>Cash on Delivery</p>`;
            codDiv.onclick = () => selectPaymentMethod(codDiv);
            container.appendChild(codDiv);

            paymentGateways.forEach(gw => {
                const gwDiv = document.createElement('div');
                gwDiv.className = 'payment-method';
                gwDiv.dataset.method = gw.name;
                gwDiv.innerHTML = `<img src="${gw.logo}" alt="${gw.name}"><p>${gw.name}</p>`;
                gwDiv.onclick = () => selectPaymentMethod(gwDiv);
                container.appendChild(gwDiv);
            });
        }
        
        function selectPaymentMethod(element) {
            document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
            element.classList.add('active');
        }

        function applyFilterAndRender(productsList, filter, targetGrid) {
            let sortedProducts = [...productsList];
            const getPrice = p => (p.variants && p.variants.length > 0) ? p.variants[0].price : (p.price || 0);

            switch(filter) {
                case 'price-asc': sortedProducts.sort((a, b) => getPrice(a) - getPrice(b)); break;
                case 'price-desc': sortedProducts.sort((a, b) => getPrice(b) - getPrice(a)); break;
                case 'top-selling': sortedProducts.sort((a, b) => (b.sales || 0) - (a.sales || 0)); break;
                case 'most-discount': sortedProducts.sort((a, b) => (b.discount || 0) - (a.discount || 0)); break;
                case 'default': default: break;
            }
            renderProducts(sortedProducts, targetGrid);
        }

        function showPromoPopup() {
            if(randomPopups.length === 0) return;
            const popupData = randomPopups[Math.floor(Math.random() * randomPopups.length)];
            
            if (popupData.type === 'product' && popupData.productId) {
                const prod = products.find(p => p.id === popupData.productId);
                if (prod) {
                    const price = prod.variants && prod.variants.length > 0 ? prod.variants[0].price : (prod.price || 0);
                    document.getElementById('promoPopupImg').src = popupData.bannerLogo || prod.images[0];
                    document.getElementById('promoPopupName').textContent = prod.name.length > 20 ? prod.name.substring(0,20)+'...' : prod.name;
                    document.getElementById('promoPopupPrice').textContent = `${price.toFixed(0)} `;
                    
                    const origPrice = prod.originalPrice || 0;
                    if (origPrice > price) {
                        document.getElementById('promoPopupOldPrice').textContent = `${origPrice.toFixed(0)} `;
                        document.getElementById('promoPopupOldPrice').style.display = 'inline-block';
                        document.getElementById('promoPopupDiscount').innerHTML = `${Math.round(((origPrice-price)/origPrice)*100)}%<br>OFF`;
                        document.getElementById('promoPopupDiscount').style.display = 'block';
                    } else {
                        document.getElementById('promoPopupOldPrice').style.display = 'none';
                        document.getElementById('promoPopupDiscount').style.display = 'none';
                    }
                    
                    document.getElementById('promoPopupAction').textContent = popupData.actionButtonName || 'Shop Now';
                    document.getElementById('promoPopupAction').style.display = 'block';
                    document.getElementById('promoPopupAction').onclick = () => {
                        navigateTo(`product-details?id=${prod.id}`);
                        hidePromoPopup();
                    };
                }
            } else {
                document.getElementById('promoPopupImg').src = popupData.bannerLogo || '';
                document.getElementById('promoPopupName').textContent = popupData.name || '';
                
                if (popupData.price && popupData.price > 0) {
                    document.getElementById('promoPopupPrice').textContent = `${popupData.price} `;
                    document.getElementById('promoPopupPrice').style.display = 'inline-block';
                } else {
                    document.getElementById('promoPopupPrice').style.display = 'none';
                }
                
                if (popupData.discount && popupData.discount > 0) {
                    document.getElementById('promoPopupDiscount').innerHTML = `${popupData.discount}%<br>OFF`;
                    document.getElementById('promoPopupDiscount').style.display = 'block';
                } else {
                    document.getElementById('promoPopupDiscount').style.display = 'none';
                }
                document.getElementById('promoPopupOldPrice').style.display = 'none';
                
                if (popupData.actionButton) {
                    document.getElementById('promoPopupAction').textContent = popupData.actionButtonName || 'Click Here';
                    document.getElementById('promoPopupAction').style.display = 'block';
                    document.getElementById('promoPopupAction').onclick = () => {
                        if (popupData.actionButtonLink) window.location.href = popupData.actionButtonLink;
                        hidePromoPopup();
                    };
                } else {
                    document.getElementById('promoPopupAction').style.display = 'none';
                }
            }
            
            promoPopup.classList.add('visible');
        }

        function hidePromoPopup() {
            promoPopup.classList.remove('visible');
        }
        
        function showPromoPopupWithCheck() {
            const isAnyOverlayActive = document.querySelector('.cart-overlay.active, .options-panel-overlay.active, .custom-alert-overlay.active, .welcome-overlay.active, .order-details-overlay.active, .lightbox[style*="display: flex"]');
            if (!isAnyOverlayActive) {
                showPromoPopup();
            }
        }

        function setupEventListeners() {
            let adTimer;
            let timeLeft = 5;

            function closeAdBanner() {
                welcomeOverlay.classList.remove('active');
                clearInterval(adTimer);
                setTimeout(showPromoPopup, 8000);
                setInterval(showPromoPopupWithCheck, 120000);
            }

            document.getElementById('closeWelcomeOverlay').addEventListener('click', closeAdBanner);
            
            if (document.getElementById('welcomeOverlay').style.display !== 'none') {
                 timeLeft = 5;
                 document.getElementById('adCountdown').textContent = `Auto close in ${timeLeft}s`;
                 welcomeOverlay.classList.add('active'); 
                 adTimer = setInterval(() => {
                    timeLeft--;
                    document.getElementById('adCountdown').textContent = `Auto close in ${timeLeft}s`;
                    if (timeLeft <= 0) {
                        closeAdBanner();
                    }
                }, 1000);
            } else {
                 setTimeout(showPromoPopup, 8000);
                 setInterval(showPromoPopupWithCheck, 120000);
            }
            
            document.getElementById('promoPopupClose').addEventListener('click', hidePromoPopup);
            cartIcon.addEventListener('click', () => cartOverlay.classList.add('active'));
            closeCart.addEventListener('click', () => cartOverlay.classList.remove('active'));
            
            detailDecQty.addEventListener('click', () => { if (detailQty.value > 1) detailQty.value--; });
            detailIncQty.addEventListener('click', () => { 
                const maxStock = parseInt(detailQty.max) || Infinity;
                if (parseInt(detailQty.value) < maxStock) {
                    detailQty.value++; 
                } else {
                    showCustomAlert('Stock Limit', 'Cannot select more than available stock.');
                }
            });
            
            detailQty.addEventListener('change', () => {
                const maxStock = parseInt(detailQty.max) || 1;
                let val = parseInt(detailQty.value);
                if(isNaN(val) || val < 1) val = 1;
                if(val > maxStock) {
                    val = maxStock;
                    showCustomAlert('Stock Limit', 'Cannot select more than available stock.');
                }
                detailQty.value = val;
            });
            
            const handleAddToCart = () => {
                if (currentProduct.variants && currentProduct.variants.length > 0 && !selectedVariant) {
                    showCustomAlert('Selection Required', 'Please select a variant (Color/Size).');
                    document.getElementById('detailVariantSelectors').scrollIntoView({behavior: 'smooth', block: 'center'});
                    return;
                }
                addToCart(currentProduct.id, parseInt(detailQty.value), selectedVariant);
            };

            const handleBuyNow = () => {
                if (currentProduct.variants && currentProduct.variants.length > 0 && !selectedVariant) {
                    showCustomAlert('Selection Required', 'Please select a variant (Color/Size).');
                    document.getElementById('detailVariantSelectors').scrollIntoView({behavior: 'smooth', block: 'center'});
                    return;
                }
                addToCart(currentProduct.id, parseInt(detailQty.value), selectedVariant);
                cartOverlay.classList.remove('active');
                navigateTo('checkout');
            };

            detailAddToCartSticky.addEventListener('click', () => requireLogin(handleAddToCart));
            detailBuyNowSticky.addEventListener('click', () => requireLogin(handleBuyNow));
            
            checkoutBtn.addEventListener('click', () => {
                requireLogin(() => {
                     const selectedItems = cart.filter(item => item.selected);
                    if (selectedItems.length === 0) {
                        showCustomAlert('No Item Selected', 'Please select an item to checkout.');
                        return;
                    }
                    cartOverlay.classList.remove('active');
                    navigateTo('checkout');
                });
            });
            
            checkoutForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                let orderAddress = {};
                const isCreatingNewAddress = document.getElementById('shippingInfoForm').style.display !== 'none';

                if (isCreatingNewAddress) {
                    const postCode = document.getElementById('coPostCode').value;
                    if(postCode < 1000 || postCode > 9999) {
                        showCustomAlert('Invalid Post Code', 'Post code must be between 1000 and 9999.');
                        return;
                    }
                    orderAddress = {
                        title: document.getElementById('coAddressTitle').value,
                        name: document.getElementById('coName').value,
                        phone: document.getElementById('coPhone').value,
                        email: document.getElementById('coEmail').value,
                        region: document.getElementById('coRegion').value,
                        postcode: postCode,
                        address: document.getElementById('coAddress').value,
                        isDefault: savedAddresses.length === 0
                    };
                    
                    if(editingAddressId !== null) {
                        savedAddresses[editingAddressId] = orderAddress;
                    } else {
                        savedAddresses.push(orderAddress);
                    }
                    await saveAddressesToFirebase();
                } else {
                    const selectedBox = document.querySelector('#checkoutSavedAddressesList .address-box.selected');
                    if(selectedBox) {
                        const index = Array.from(selectedBox.parentNode.children).indexOf(selectedBox);
                        orderAddress = savedAddresses[index];
                    } else {
                        showCustomAlert('No Address', 'Please select a shipping address.');
                        return;
                    }
                }

                const selectedItems = cart.filter(item => item.selected);
                if (selectedItems.length === 0) { 
                    showCustomAlert('Cart Empty', 'Your cart is empty or no item is selected.'); 
                    return; 
                }
                
                const orderNo = Math.floor(Math.random() * 1000000000000) + 1000000000000;
                const dateObj = new Date();
                const date = dateObj.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) + ' ' + dateObj.toLocaleTimeString('en-GB', { hour12: false });
                
                const activePayment = document.querySelector('.payment-method.active');
                const paymentMethodText = activePayment ? activePayment.dataset.method : 'Cash on Delivery';
                
                let subtotal = 0;
                let itemsHtml = '';
                
                selectedItems.forEach(item => {
                    subtotal += item.price * item.quantity;
                    const variantText = (item.color!=='N/A' ? item.color : '') + (item.size!=='N/A' ? `, ${item.size}` : '');
                    itemsHtml += `
                        <div class="od-item">
                            <img src="${item.image}" alt="">
                            <div class="od-item-info">
                                <h4>${item.name}</h4>
                                ${variantText ? `<div class="od-item-variant">${variantText}</div>` : ''}
                                <div class="od-item-price-row">
                                    <span class="od-item-price"> ${item.price.toFixed(0)}</span>
                                    <span class="od-item-qty">Qty: ${item.quantity}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                const deliveryInside = parseFloat(document.getElementById('deliveryInsideTk').textContent.replace('','')) || 60;
                const deliveryOutside = parseFloat(document.getElementById('deliveryOutsideTk').textContent.replace('','')) || 120;
                const shippingFee = (orderAddress.region === 'Outside Dhaka') ? deliveryOutside : deliveryInside; 
                const total = subtotal + shippingFee;

                if(isLoggedIn && currentUser) {
                     const orderData = {
                         id: orderNo.toString(),
                         customer: orderAddress.name,
                         phone: orderAddress.phone,
                         address: `${orderAddress.address}, ${orderAddress.region} - ${orderAddress.postcode}`,
                         amount: total,
                         date: date,
                         status: 'Pending',
                         payment: paymentMethodText,
                         cartItems: selectedItems.map(i => ({
                             pid: i.pid || i.id,
                             name: i.name,
                             price: i.price,
                             qty: i.quantity,
                             color: i.color,
                             size: i.size,
                             image: i.image
                         })),
                         userId: auth.currentUser.uid
                     };
                     db.collection('orders').doc(orderNo.toString()).set(orderData);
                }
                
                document.getElementById('odBody').innerHTML = itemsHtml;
                document.getElementById('odSubtotal').textContent = ` ${subtotal.toFixed(0)}`;
                document.getElementById('odShipping').textContent = ` ${shippingFee}`;
                document.getElementById('odCOD').textContent = ` 0`;
                document.getElementById('odTotal').textContent = ` ${total.toFixed(0)}`;
                document.getElementById('odPaidAmount').textContent = ` ${total.toFixed(0)}`;
                document.getElementById('odPaidMethodName').textContent = paymentMethodText;
                document.getElementById('odOrderNo').textContent = orderNo;
                document.getElementById('odDate').textContent = date;
                document.getElementById('odPaymentMethod').textContent = paymentMethodText;
                
                document.getElementById('orderDetailsOverlay').classList.add('active');
                
                cart = cart.filter(item => !item.selected);
                updateCartCount();
                renderCartItems();
                document.getElementById('shippingInfoForm').style.display = 'none';
                populateCheckoutAddresses();
            });

            document.getElementById('closeOrderDetails').addEventListener('click', () => {
                document.getElementById('orderDetailsOverlay').classList.remove('active');
                navigateTo('home');
            });
            document.getElementById('odContinueShopping').addEventListener('click', () => {
                document.getElementById('orderDetailsOverlay').classList.remove('active');
                navigateTo('home');
            });
            document.getElementById('odCopy').addEventListener('click', (e) => {
                e.preventDefault();
                navigator.clipboard.writeText(document.getElementById('odOrderNo').textContent);
                const orig = e.target.textContent;
                e.target.textContent = 'Copied!';
                setTimeout(() => e.target.textContent = orig, 2000);
            });

            document.getElementById('loginForm')?.addEventListener('submit', async (e) => { 
                e.preventDefault(); 
                const email = e.target.querySelector('input[type=email]').value;
                const password = e.target.querySelector('input[type=password]').value;
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    showCustomAlert('Login Successful', 'Welcome back!', () => navigateTo('profile')); 
                } catch(error) {
                    showCustomAlert('Login Failed', error.message);
                }
            });

            document.getElementById('registerForm')?.addEventListener('submit', async (e) => { 
                e.preventDefault(); 
                const name = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const phone = document.getElementById('registerPhone').value;
                const passwords = e.target.querySelectorAll('input[type=password]');
                const password = passwords[0].value;
                const confirmPassword = passwords[1].value;

                if (password !== confirmPassword) {
                    showCustomAlert('Error', 'Passwords do not match');
                    return;
                }
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await userCredential.user.updateProfile({ displayName: name });
                    await db.collection('users').doc(userCredential.user.uid).set({ name, email, phone });
                    showCustomAlert('Registration Successful', 'Your account has been created successfully.', () => navigateTo('profile')); 
                } catch(error) {
                    showCustomAlert('Registration Failed', error.message);
                }
            });

            document.querySelectorAll('.google-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const provider = new firebase.auth.GoogleAuthProvider();
                    try {
                        const result = await auth.signInWithPopup(provider);
                        const userDoc = await db.collection('users').doc(result.user.uid).get();
                        if (!userDoc.exists) {
                            await db.collection('users').doc(result.user.uid).set({
                                name: result.user.displayName,
                                email: result.user.email,
                                phone: ''
                            });
                        }
                        showCustomAlert('Login Successful', 'Welcome!', () => navigateTo('profile'));
                    } catch(error) {
                        showCustomAlert('Login Failed', error.message);
                    }
                });
            });
            
            document.getElementById('profileSetupForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                if(!auth.currentUser) return;
                const newName = document.getElementById('profileName').value;
                const newPhone = document.getElementById('profilePhone').value;
                try {
                    await auth.currentUser.updateProfile({ displayName: newName });
                    await db.collection('users').doc(auth.currentUser.uid).update({ name: newName, phone: newPhone });
                    currentUser.name = newName;
                    currentUser.phone = newPhone;
                    populateProfileData();
                    showNotification("Profile updated successfully!");
                } catch(error) {
                    showCustomAlert('Error', error.message);
                }
            });

            document.getElementById('showAddAddressFormBtn').addEventListener('click', () => {
                openAddressForm(null);
            });
            
            document.getElementById('cancelAddressBtn').addEventListener('click', () => {
                document.getElementById('newAddressForm').style.display = 'none';
                document.getElementById('addressListContainer').style.display = 'block';
            });
            
            document.getElementById('newAddressForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const postCode = document.getElementById('addrPostCode').value;
                if(postCode < 1000 || postCode > 9999) {
                    showCustomAlert('Invalid Post Code', 'Post code must be between 1000 and 9999.');
                    return;
                }

                const addr = {
                    title: document.getElementById('addrTitle').value,
                    name: document.getElementById('addrName').value,
                    phone: document.getElementById('addrPhone').value,
                    email: document.getElementById('addrEmail').value,
                    region: document.getElementById('addrRegion').value,
                    postcode: postCode,
                    address: document.getElementById('addrFull').value,
                    isDefault: savedAddresses.length === 0
                };

                const editId = document.getElementById('editAddressId').value;
                if (editId !== '') {
                    savedAddresses[editId] = addr;
                } else {
                    savedAddresses.push(addr);
                }
                
                await saveAddressesToFirebase();
                document.getElementById('newAddressForm').style.display = 'none';
                document.getElementById('addressListContainer').style.display = 'block';
                renderSavedAddressesList();
                showNotification("Address saved successfully!");
            });

            document.getElementById('checkoutAddAddressBtn').addEventListener('click', () => {
                openCheckoutAddressForm(null);
            });

            document.getElementById('coCancelAddressBtn').addEventListener('click', () => {
                if(savedAddresses.length > 0) {
                    document.getElementById('shippingInfoForm').style.display = 'none';
                    document.getElementById('checkoutAddressManagement').style.display = 'block';
                    populateCheckoutAddresses();
                } else {
                    showCustomAlert('Required', 'You must add a shipping address to checkout.');
                }
            });
            
            document.getElementById('coSaveAddressBtn').addEventListener('click', async () => {
                const form = document.getElementById('checkoutForm');
                if(!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                const postCode = document.getElementById('coPostCode').value;
                if(postCode < 1000 || postCode > 9999) {
                    showCustomAlert('Invalid Post Code', 'Post code must be between 1000 and 9999.');
                    return;
                }

                const addr = {
                    title: document.getElementById('coAddressTitle').value,
                    name: document.getElementById('coName').value,
                    phone: document.getElementById('coPhone').value,
                    email: document.getElementById('coEmail').value,
                    region: document.getElementById('coRegion').value,
                    postcode: postCode,
                    address: document.getElementById('coAddress').value,
                    isDefault: savedAddresses.length === 0
                };

                if (editingAddressId !== null) {
                    savedAddresses[editingAddressId] = addr;
                } else {
                    savedAddresses.push(addr);
                }
                
                await saveAddressesToFirebase();
                document.getElementById('shippingInfoForm').style.display = 'none';
                document.getElementById('checkoutAddressManagement').style.display = 'block';
                populateCheckoutAddresses();
                showNotification("Address saved for checkout!");
            });

            ['homeFilterOptions', 'searchFilterOptions'].forEach(id => {
                 document.getElementById(id).addEventListener('click', e => {
                    if (e.target.tagName === 'BUTTON') {
                        const filter = e.target.dataset.filter;
                        document.querySelectorAll(`#${id} button`).forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                        const grid = id === 'homeFilterOptions' ? productGrid : searchResultsGrid;
                        const productSource = id === 'homeFilterOptions' ? products : currentlyDisplayedProducts;
                        applyFilterAndRender(productSource, filter, grid);
                        document.getElementById(id).classList.remove('active'); 
                    }
                });
            });
            
            document.addEventListener('click', (e) => {
                if(!e.target.closest('.filter-dropdown-container')) {
                    document.querySelectorAll('.filter-options-dropdown').forEach(d => d.classList.remove('active'));
                }
            });

            document.querySelectorAll('.category-card').forEach(card => {
                card.addEventListener('click', () => {
                    const category = card.dataset.category;
                    navigateTo('home');
                    setTimeout(() => { 
                        const shopSection = document.getElementById('shop');
                        shopSection.scrollIntoView({ behavior: 'smooth' });
                        document.getElementById('shopTitle').textContent = `Products in: ${category.charAt(0).toUpperCase() + category.slice(1)}`;
                        currentlyDisplayedProducts = products.filter(p => p.category === category);
                        applyFilterAndRender(currentlyDisplayedProducts, 'default', productGrid);
                    }, 600);
                });
            });

            menuToggle.addEventListener('click', () => { menuToggle.classList.toggle('active'); mobileMenu.classList.toggle('active'); });
            cartOverlay.addEventListener('click', (e) => { if (e.target === cartOverlay) cartOverlay.classList.remove('active'); });
            shopNowBtn.addEventListener('click', () => { document.getElementById('shop').scrollIntoView({ behavior: 'smooth' }); });

            document.addEventListener('click', (e) => {
                if (mobileMenu.classList.contains('active') && !mobileMenu.contains(e.target) && !menuToggle.contains(e.target)) {
                    mobileMenu.classList.remove('active');
                    menuToggle.classList.remove('active');
                }
            });
            
            searchPageForm.addEventListener('submit', handleSearch);
            
            const searchClearBtn = document.getElementById('searchClearBtn');
            searchPageInput.addEventListener('input', () => {
                const term = searchPageInput.value.toLowerCase();
                if(term.length > 0) { searchClearBtn.style.display = 'block'; } else { searchClearBtn.style.display = 'none'; }
                searchSuggestionsList.innerHTML = '';
                if(term.length < 2) {
                    searchSuggestionsList.style.display = 'none';
                    return;
                }

                const matchedProducts = new Set();
                
                products.forEach(p => {
                    const nameMatch = p.name.toLowerCase().includes(term);
                    let seoMatch = false;
                    if (p.seo_tag) {
                        let tags = [];
                        if (typeof p.seo_tag === 'string') {
                            tags = p.seo_tag.split(',').map(s=>s.trim().toLowerCase());
                        } else if (Array.isArray(p.seo_tag)) {
                            tags = p.seo_tag.map(s=>s.toLowerCase());
                        }
                        seoMatch = tags.some(t => t.includes(term));
                    }
                    const keywordMatch = p.keywords && p.keywords.some(k => k.toLowerCase().includes(term));
                    
                    if(nameMatch || seoMatch || keywordMatch) {
                        matchedProducts.add(p);
                    }
                });

                if (matchedProducts.size > 0) {
                    searchSuggestionsList.style.display = 'block';
                    matchedProducts.forEach(p => {
                        const item = document.createElement('div');
                        item.className = 'suggestion-item';
                        item.textContent = p.name;
                        item.onclick = () => { navigateTo(`product-details?id=${p.id}`); searchPageInput.value = ''; searchSuggestionsList.innerHTML = ''; searchSuggestionsList.style.display = 'none';};
                        searchSuggestionsList.appendChild(item);
                    });
                } else {
                    searchSuggestionsList.style.display = 'none';
                }
            });
            
            searchClearBtn.addEventListener('click', () => {
                searchPageInput.value = '';
                searchClearBtn.style.display = 'none';
                searchSuggestionsList.innerHTML = '';
                searchSuggestionsList.style.display = 'none';
                searchPageInput.focus();
            });

            searchPageInput.addEventListener('blur', () => {
                setTimeout(() => { searchSuggestionsList.style.display = 'none'; }, 200);
            });
            
            searchPageInput.addEventListener('focus', () => {
                if(searchSuggestionsList.children.length > 0) searchSuggestionsList.style.display = 'block';
            });

            detailMainImg.addEventListener('click', () => {
                lightbox.style.display = 'flex';
                lightboxImg.src = detailMainImg.src;
            });

            function closeAndResetLightbox() {
                lightbox.style.display = 'none';
                lightboxImg.classList.remove('zoomed');
            }

            closeLightbox.addEventListener('click', closeAndResetLightbox);
            lightbox.addEventListener('click', (e) => { if(e.target === lightbox) { closeAndResetLightbox(); } });
            lightboxImg.addEventListener('click', (e) => { e.stopPropagation(); lightboxImg.classList.toggle('zoomed'); });

            document.querySelectorAll('.password-toggle-icon').forEach(icon => {
                icon.addEventListener('click', function() {
                    const input = this.previousElementSibling;
                    const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                    input.setAttribute('type', type);
                    this.classList.toggle('fa-eye');
                    this.classList.toggle('fa-eye-slash');
                });
            });
        }

        function startOfferTimer() {
            const endDate = new Date();
            endDate.setDate(endDate.getDate() + 3);
            const timerInterval = setInterval(updateTimer, 1000);
            function updateTimer() {
                const distance = endDate - new Date().getTime();
                if (distance < 0) { clearInterval(timerInterval); return; };
                const d = Math.floor(distance / (1000*60*60*24)).toString().padStart(2,'0');
                const h = Math.floor((distance % (1000*60*60*24))/(1000*60*60)).toString().padStart(2,'0');
                const m = Math.floor((distance % (1000*60*60))/(1000*60)).toString().padStart(2,'0');
                const s = Math.floor((distance % (1000*60))/1000).toString().padStart(2,'0');
                document.getElementById('days').textContent = d;
                document.getElementById('hours').textContent = h;
                document.getElementById('minutes').textContent = m;
                document.getElementById('seconds').textContent = s;
            }
            updateTimer();
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadInitialData();
            init();
        });
    </script>
</body>
</html>
