<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK Compat Version -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

    <style>
        :root {
            --primary-color: #3b82f6; 
            --primary-hover: #2563eb;
            --secondary-color: #6366f1;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --light-color: #ffffff;
            --dark-color: #0f172a;
            --gray-color: #64748b;
            --light-gray: #f8fafc;
            --border-color: #e2e8f0;
            --sidebar-width: 260px;
            --topbar-height: 70px;
            --transition-speed: 0.3s;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            --sidebar-shadow: 2px 0 15px rgba(0, 0, 0, 0.03);
            --border-radius: 12px;
            --font-main: 'Inter', sans-serif;
            --font-head: 'Poppins', sans-serif;
        }

        .dark-mode {
            --primary-color: #60a5fa;
            --primary-hover: #93c5fd;
            --secondary-color: #818cf8;
            --light-color: #1e293b;
            --dark-color: #f8fafc;
            --gray-color: #94a3b8;
            --light-gray: #0f172a; 
            --border-color: #334155;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --sidebar-shadow: 2px 0 15px rgba(0, 0, 0, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-main);
        }

        body {
            background-color: var(--light-gray);
            color: var(--dark-color);
            transition: background-color var(--transition-speed), color var(--transition-speed);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--light-gray); }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark-mode ::-webkit-scrollbar-thumb { background: #475569; }

        h1, h2, h3, h4, h5, h6 { font-family: var(--font-head); }
        a { text-decoration: none; color: inherit; }
        ul { list-style: none; }
        button { cursor: pointer; border: none; outline: none; font-family: var(--font-main); transition: all 0.2s ease;}

        .container { display: flex; min-height: 100vh; }

        /* Login Screen */
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); padding: 20px; }
        .login-card { background-color: var(--light-color); padding: 40px; border-radius: 16px; width: 100%; max-width: 420px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); text-align: left; }
        .login-logo { text-align: center; margin-bottom: 30px; }
        .login-logo h1 { color: var(--primary-color); font-size: 26px; font-weight: 700; }
        
        /* Forms & Inputs */
        .form-group { margin-bottom: 20px; position: relative; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px; color: var(--gray-color); }
        .form-control { width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; transition: all var(--transition-speed); background-color: transparent; color: var(--dark-color); }
        .form-control:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); outline: none; }
        
        .status-select { min-width: 130px; padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-color); background-color: var(--light-color); color: var(--dark-color); font-size: 13px; cursor: pointer; }
        .password-toggle { position: absolute; right: 15px; top: 40px; color: var(--gray-color); cursor: pointer; z-index: 10; font-size: 16px;}
        .bypass-login { display: block; text-align: right; margin-top: -10px; margin-bottom: 20px; font-size: 13px; color: var(--primary-color); font-weight: 500; }
        
        /* Buttons */
        .btn { display: inline-block; width: 100%; padding: 12px 15px; border-radius: 8px; font-size: 15px; font-weight: 600; text-align: center; color: #fff; border: 1px solid transparent; }
        .btn-primary { background-color: var(--primary-color); }
        .btn-primary:hover { background-color: var(--primary-hover); transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3); }
        .btn-secondary { background-color: var(--gray-color); margin-top: 10px; }
        
        .btn-add { background-color: var(--primary-color); color: white; padding: 10px 18px; border-radius: 8px; font-weight: 500; font-size: 14px; width: auto; display: inline-block; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2); }
        .btn-add:hover { background-color: var(--primary-hover); transform: translateY(-1px); }
        .btn-refresh { background-color: var(--success-color); color: white; padding: 10px 18px; border-radius: 8px; font-weight: 500; font-size: 14px; display: inline-flex; align-items: center; gap: 6px; margin-right: 10px; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2); }
        .btn-refresh:hover { opacity: 0.9; transform: translateY(-1px); }
        
        /* Sidebar */
        .sidebar { width: var(--sidebar-width); background-color: var(--light-color); box-shadow: var(--sidebar-shadow); position: fixed; top: 0; left: 0; height: 100vh; z-index: 1001; transition: transform var(--transition-speed); display: flex; flex-direction: column; border-right: 1px solid var(--border-color); }
        .sidebar-header { padding: 24px 20px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
        .sidebar-header h2 { color: var(--primary-color); font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .close-sidebar { display: none; background: none; color: var(--gray-color); font-size: 20px; padding: 5px; }
        
        .sidebar-menu { padding: 20px 0; flex-grow: 1; overflow-y: auto; }
        .menu-item { padding: 12px 24px; display: flex; align-items: center; color: var(--gray-color); transition: all 0.2s; border-left: 3px solid transparent; font-size: 15px; font-weight: 500; }
        .menu-item:hover, .menu-item.active { background-color: rgba(59, 130, 246, 0.08); color: var(--primary-color); border-left-color: var(--primary-color); }
        .menu-item i { margin-right: 12px; font-size: 18px; width: 24px; text-align: center; }
        
        .menu-header { padding: 20px 24px 8px; font-size: 11px; font-weight: 700; text-transform: uppercase; color: #94a3b8; letter-spacing: 1px; border-top: 1px solid var(--border-color); margin-top: 10px; }
        .sidebar-menu > li:first-child.menu-header { border-top: none; margin-top: 0; padding-top: 5px; }

        /* Main Content & Topbar */
        .main-content { flex: 1; margin-left: var(--sidebar-width); display: flex; flex-direction: column; width: calc(100% - var(--sidebar-width)); }
        .topbar { height: var(--topbar-height); background-color: rgba(255,255,255,0.8); backdrop-filter: blur(10px); padding: 0 30px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 1000; }
        .dark-mode .topbar { background-color: rgba(30,41,59,0.8); }
        
        .topbar-left { display: flex; align-items: center; }
        .toggle-sidebar { background: none; color: var(--dark-color); font-size: 20px; margin-right: 20px; display: none; padding: 5px; }
        .page-title { font-size: 20px; font-weight: 600; color: var(--dark-color); }
        
        .topbar-right { display: flex; align-items: center; gap: 20px; }
        .theme-toggle { background: var(--light-gray); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--gray-color); border: 1px solid var(--border-color); }
        .theme-toggle:hover { color: var(--primary-color); border-color: var(--primary-color); }
        .admin-avatar { width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3); }

        .content { padding: 30px; overflow-x: auto; }
        
        /* Dashboard Stats */
        .stats-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 24px; margin-bottom: 30px; }
        .stat-card { background-color: var(--light-color); border-radius: 16px; padding: 24px; box-shadow: var(--card-shadow); border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; left: 0; top: 0; height: 100%; width: 4px; border-radius: 4px 0 0 4px; }
        .stat-card:nth-child(1)::before { background-color: var(--primary-color); }
        .stat-card:nth-child(2)::before { background-color: var(--warning-color); }
        .stat-card:nth-child(3)::before { background-color: var(--success-color); }
        .stat-card:nth-child(4)::before { background-color: var(--secondary-color); }
        
        .stat-card-info p { font-size: 13px; color: var(--gray-color); font-weight: 500; margin-bottom: 5px; }
        .stat-card-info h3 { font-size: 28px; font-weight: 700; color: var(--dark-color); line-height: 1; }
        .stat-card-icon { width: 54px; height: 54px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; color: white; }
        .icon-products { background-color: var(--primary-color); box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); }
        .icon-orders { background-color: var(--warning-color); box-shadow: 0 4px 10px rgba(245, 158, 11, 0.3); }
        .icon-customers { background-color: var(--success-color); box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); }
        .icon-revenue { background-color: var(--secondary-color); box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3); }
        
        /* Tables */
        .table-container { 
            background-color: var(--light-color); 
            border-radius: 16px; 
            box-shadow: var(--card-shadow); 
            border: 1px solid var(--border-color); 
            overflow-x: auto; 
            max-height: 75vh; 
            width: 100%; 
            position: relative;
            margin-top: 20px; /* FIX 1: Spacing below sticky header */
        }
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 800px; text-align: left; }
        thead th { position: sticky; top: 0; z-index: 20; padding: 16px 20px; font-weight: 600; font-size: 13px; color: var(--gray-color); text-transform: uppercase; letter-spacing: 0.5px; background-color: var(--light-gray); border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        td { padding: 16px 20px; border-bottom: 1px solid var(--border-color); font-size: 14px; white-space: nowrap; vertical-align: middle; color: var(--dark-color); }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:hover td { background-color: rgba(59, 130, 246, 0.02); }

        /* Badges & Actions */
        .status { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; letter-spacing: 0.3px; }
        .status-active, .status-delivered { background-color: rgba(16, 185, 129, 0.1); color: var(--success-color); border: 1px solid rgba(16, 185, 129, 0.2); }
        .status-pending { background-color: rgba(245, 158, 11, 0.1); color: var(--warning-color); border: 1px solid rgba(245, 158, 11, 0.2); }
        .status-cancelled, .status-out { background-color: rgba(239, 68, 68, 0.1); color: var(--danger-color); border: 1px solid rgba(239, 68, 68, 0.2); }
        
        .action-buttons { display: flex; gap: 8px; }
        .btn-action { padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 500; color: white; transition: 0.2s; display: inline-flex; align-items: center; gap: 4px; }
        .btn-action:hover { opacity: 0.85; transform: scale(1.05); }
        .btn-edit { background-color: var(--primary-color); }
        .btn-delete { background-color: var(--danger-color); }
        .btn-view { background-color: var(--secondary-color); }
        
        /* Modals */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        .modal.show { display: flex; animation: fadeIn 0.2s ease-out; }
        .modal-content { background-color: var(--light-color); margin: auto; padding: 32px; border-radius: 20px; width: 90%; max-width: 800px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); max-height: 90vh; overflow-y: auto; position: relative; border: 1px solid var(--border-color); }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .close-modal-btn { position: absolute; right: 24px; top: 24px; background: var(--light-gray); border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; color: var(--gray-color); transition: 0.2s; }
        .close-modal-btn:hover { background: var(--danger-color); color: white; }
        
        .detail-row { display: flex; border-bottom: 1px dashed var(--border-color); padding: 12px 0; font-size: 14px; }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { font-weight: 600; width: 140px; color: var(--gray-color); }
        .detail-value { flex: 1; color: var(--dark-color); }
        
        .form-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-full { margin-bottom: 20px; }
        .form-section { background-color: var(--light-color); border-radius: 16px; padding: 30px; border: 1px solid var(--border-color); margin-bottom: 30px; }
        textarea.form-control { min-height: 120px; resize: vertical; }
        
        /* Dynamic Lists */
        .dynamic-list-wrapper { border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 20px; background: var(--light-gray); }
        .dynamic-list-header { display: flex; gap: 10px; font-size: 13px; font-weight: 600; color: var(--gray-color); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
        .dynamic-list { display: flex; flex-direction: column; gap: 12px; }
        .dynamic-item { display: flex; gap: 12px; align-items: center; }
        .btn-icon-add, .btn-icon-remove { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; color: white; flex-shrink: 0; transition: 0.2s; }
        .btn-icon-add { background-color: var(--success-color); box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3); }
        .btn-icon-remove { background-color: var(--danger-color); box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3); }
        .btn-icon-add:hover, .btn-icon-remove:hover { transform: translateY(-2px); }
        
        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 48px; height: 24px; margin-right: 12px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border-color); transition: .3s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(24px); }
        
        /* Tags (Updated for FIX 3) */
        .tag-container { 
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--light-color);
            cursor: text;
        }
        .tag { 
            background-color: rgba(59, 130, 246, 0.15); 
            color: var(--primary-color); 
            padding: 5px 10px; 
            border-radius: 6px; 
            display: inline-flex; 
            align-items: center; 
            gap: 6px; 
            font-size: 13px; 
            font-weight: 500; 
        }
        .tag i { font-size: 11px; cursor: pointer; color: var(--danger-color); opacity: 0.7; transition: 0.2s; }
        .tag i:hover { opacity: 1; }
        .tag-container input { 
            border: none; outline: none; background: transparent; 
            color: var(--dark-color); min-width: 120px; flex: 1; padding: 4px;
        }
        
        .hidden { display: none !important; }
        
        .page-content .table-header { position: sticky; top: var(--topbar-height); background-color: var(--light-gray); z-index: 101; padding: 20px 0; display: flex; justify-content: space-between; align-items: center; }
        .table-title { font-size: 18px; font-weight: 600; color: var(--dark-color); }
        
        /* Order Tabs */
        .order-tabs { display: flex; gap: 12px; margin-bottom: 20px; position: sticky; top: calc(var(--topbar-height) + 80px); z-index: 100; background-color: var(--light-gray); padding: 10px 0; }
        .tab-btn { padding: 10px 24px; border-radius: 30px; background: var(--light-color); border: 1px solid var(--border-color); color: var(--gray-color); font-weight: 500; font-size: 14px; transition: 0.3s; }
        .tab-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); }
        
        /* Notifications */
        .notification-dot { position: relative; }
        .notification-dot::after { content: ''; position: absolute; top: 12px; right: 12px; width: 10px; height: 10px; background-color: var(--danger-color); border-radius: 50%; border: 2px solid var(--light-color); box-shadow: 0 0 0 2px rgba(239,68,68,0.2); z-index: 10; }
        .toggle-sidebar.notification-dot::after { top: 0; right: 0; }
        .stat-card.notification-dot::after { top: 20px; right: 20px; width: 12px; height: 12px; }

        @media (max-width: 1024px) { .stats-cards { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { 
            .sidebar { transform: translateX(-100%); } 
            .sidebar.active { transform: translateX(0); } 
            .close-sidebar { display: block; } 
            .main-content { margin-left: 0; width: 100%; } 
            .toggle-sidebar { display: block; } 
            .topbar { padding: 0 20px; } 
            .form-row { grid-template-columns: 1fr; }
            .order-tabs { overflow-x: auto; white-space: nowrap; padding-bottom: 15px; }
        }
    </style>
</head>
<body>
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="login-logo">
                <h1 id="loginStoreName">Admin Access</h1>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="adminEmail">Email Address</label>
                    <input type="email" id="adminEmail" class="form-control" placeholder="admin@example.com" required>
                </div>
                <div class="form-group">
                    <label for="adminPassword">Password</label>
                    <input type="password" id="adminPassword" class="form-control" placeholder="••••••••" required>
                    <i class="fas fa-eye password-toggle" id="togglePassword"></i>
                </div>
                <button type="submit" class="btn btn-primary">Sign In to Dashboard</button>
            </form>
        </div>
    </div>

    <div id="dashboard" class="container hidden">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2 id="sidebarStoreName"><i class="fas fa-bolt" style="color:var(--warning-color)"></i> Admin</h2>
                <button class="close-sidebar"><i class="fas fa-times"></i></button>
            </div>
            <ul class="sidebar-menu">
                <li class="menu-header">Overview</li>
                <li><a href="#" class="menu-item active" data-page="dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                
                <li class="menu-header">Inventory</li>
                <li><a href="#" class="menu-item" data-page="products"><i class="fas fa-box"></i> Products</a></li>
                <li><a href="#" class="menu-item" data-page="categories"><i class="fas fa-layer-group"></i> Categories</a></li>
                
                <li class="menu-header">Business</li>
                <li><a href="#" class="menu-item" data-page="orders" id="menuOrdersLink"><i class="fas fa-shopping-bag"></i> Orders</a></li>
                <li><a href="#" class="menu-item" data-page="customers"><i class="fas fa-users"></i> Customers</a></li>
                
                <li class="menu-header">Promotions</li>
                <li><a href="#" class="menu-item" data-page="offers"><i class="fas fa-tags"></i> Offers</a></li>
                <li><a href="#" class="menu-item" data-page="popup"><i class="fas fa-bullhorn"></i> Pop Ups</a></li>
                
                <li class="menu-header">Preferences</li>
                <li><a href="#" class="menu-item" data-page="settings"><i class="fas fa-cog"></i> Settings</a></li>
                <li><a href="#" class="menu-item" data-page="payment"><i class="fas fa-credit-card"></i> Payment Gateways</a></li>
                <li><a href="#" id="logoutBtn" class="menu-item" style="color: var(--danger-color); margin-top: 10px;"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="toggle-sidebar" id="toggleSidebarBtn"><i class="fas fa-bars"></i></button>
                    <h1 class="page-title">Dashboard</h1>
                </div>
                <div class="topbar-right">
                    <button class="theme-toggle" id="themeToggle"><i class="fas fa-moon"></i></button>
                    <div class="admin-profile">
                        <div class="admin-avatar"><i class="fas fa-user"></i></div>
                    </div>
                </div>
            </header>

            <div class="content">
                <div id="dashboardPage" class="page-content">
                    <div class="stats-cards">
                        <div class="stat-card">
                            <div class="stat-card-info">
                                <p>Total Products</p>
                                <h3 id="totalProducts">0</h3>
                            </div>
                            <div class="stat-card-icon icon-products"><i class="fas fa-box"></i></div>
                        </div>
                        <div class="stat-card" id="cardOrders">
                            <div class="stat-card-info">
                                <p>Total Orders</p>
                                <h3 id="totalOrders">0</h3>
                            </div>
                            <div class="stat-card-icon icon-orders"><i class="fas fa-shopping-bag"></i></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-info">
                                <p>Total Customers</p>
                                <h3 id="totalCustomers">0</h3>
                            </div>
                            <div class="stat-card-icon icon-customers"><i class="fas fa-users"></i></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-info">
                                <p>Total Revenue</p>
                                <h3 id="totalRevenue">৳0</h3>
                            </div>
                            <div class="stat-card-icon icon-revenue"><i class="fas fa-wallet"></i></div>
                        </div>
                    </div>

                    <div class="table-container">
                        <div style="padding: 20px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                            <h3 class="table-title">Recent Orders</h3>
                            <a href="#" class="view-all-orders" style="color: var(--primary-color); font-weight: 600; font-size: 14px;">View All →</a>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="recentOrdersTable">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="productsPage" class="page-content hidden">
                    <div class="table-header">
                        <h3 class="table-title">Products Inventory</h3>
                        <div style="display: flex; gap: 15px;">
                            <input type="text" id="productSearchById" class="form-control" placeholder="Search by PID / Variant..." style="width: 250px;">
                            <button class="btn-add" id="addProductBtn"><i class="fas fa-plus"></i> Add Product</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Image & PID</th>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsTable"></tbody>
                        </table>
                    </div>
                </div>

                <div id="categoriesPage" class="page-content hidden">
                    <div class="table-header">
                        <h3 class="table-title">Categories</h3>
                        <button class="btn-add" id="addCategoryBtn"><i class="fas fa-plus"></i> Add </button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Icon / Image</th>
                                    <th>Name</th>
                                    <th>Products</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="categoriesTable"></tbody>
                        </table>
                    </div>
                </div>

                <div id="ordersPage" class="page-content hidden">
                    <div class="table-header">
                        <h3 class="table-title">Orders Management</h3>
                        <button class="btn-refresh" onclick="refreshOrders()"><i class="fas fa-sync-alt"></i></button>
                    </div>
                    
                    <div class="order-tabs">
                        <button class="tab-btn active" onclick="switchOrderTab('Pending', this)">Active Orders</button>
                        <button class="tab-btn" onclick="switchOrderTab('Delivered', this)">Completed</button>
                        <button class="tab-btn" onclick="switchOrderTab('Cancelled', this)">Cancelled</button>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Products Info</th>
                                    <th>Amount</th>
                                    <th>Payment Info</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTable"></tbody>
                        </table>
                    </div>
                </div>

                <div id="customersPage" class="page-content hidden">
                    <div class="table-header">
                        <h3 class="table-title">Customers Directory</h3>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Total Spent</th>
                                </tr>
                            </thead>
                            <tbody id="customersTable"></tbody>
                        </table>
                    </div>
                </div>

                <div id="offersPage" class="page-content hidden">
                    <div class="table-header">
                        <h3 class="table-title">Promotional Offers</h3>
                        <button class="btn-add" id="createOfferBtn"><i class="fas fa-plus"></i> Create Offer</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Offer Name</th>
                                    <th>Discount</th>
                                    <th>Applicable To</th>
                                    <th>Expiry Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="offersTable"></tbody>
                        </table>
                    </div>
                </div>

                <div id="popupPage" class="page-content hidden">
                    <div class="table-header">
                        <h3 class="table-title">Pop Up Announcements</h3>
                        <button class="btn-add" id="addPopUpBtn"><i class="fas fa-plus"></i> Add Pop Up</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Visual</th>
                                    <th>Name</th>
                                    <th>Section</th>
                                    <th>Action Button</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="popUpsTable"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="paymentPage" class="page-content hidden">
                    <div class="table-header">
                        <h3 class="table-title">Payment Gateways</h3>
                        <button class="btn-add" id="addGatewayBtn"><i class="fas fa-plus"></i></button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Logo</th>
                                    <th>Gateway Name</th>
                                    <th>Integration</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="gatewaysTable"></tbody>
                        </table>
                    </div>
                </div>

                <div id="settingsPage" class="page-content hidden">
                    <div class="form-section">
                        <h3 class="table-title" style="margin-bottom: 25px;">General Settings</h3>
                        <form id="generalSettingsForm">
                            <div class="form-row">
                                <div class="form-group"><label>Site/Store Name</label><input type="text" id="siteName" class="form-control" required></div>
                                <div class="form-group"><label>Site Logo URL</label><input type="text" id="logoUrl" class="form-control"></div>
                            </div>
                            
                            <h4 style="margin: 25px 0 15px; color: var(--primary-color); font-size: 15px;">Hero Section Elements</h4>
                            <div class="form-row">
                                <div class="form-group"><label>Hero Title</label><input type="text" id="heroTitle" class="form-control"></div>
                                <div class="form-group"><label>Hero Description</label><textarea id="heroDesc" class="form-control" rows="2"></textarea></div>
                            </div>
                            
                            <h4 style="margin: 25px 0 15px; color: var(--primary-color); font-size: 15px;">Logistics & Delivery</h4>
                            <div class="form-row">
                                <div class="form-group"><label>Delivery Inside City (৳)</label><input type="number" id="deliveryInside" class="form-control" required></div>
                                <div class="form-group"><label>Delivery Outside City (৳)</label><input type="number" id="deliveryOutside" class="form-control" required></div>
                            </div>

                            <h4 style="margin: 25px 0 15px; color: var(--primary-color); font-size: 15px;">Footer Information</h4>
                            <div class="form-row">
                                <div class="form-group"><label>Contact Number</label><input type="tel" id="footerPhone" class="form-control"></div>
                                <div class="form-group"><label>Email Address</label><input type="email" id="footerEmail" class="form-control"></div>
                            </div>
                            <div class="form-full"><div class="form-group"><label>Office Address</label><textarea id="footerAddress" class="form-control" rows="2"></textarea></div></div>
                            <div class="form-full"><div class="form-group"><label>About Us Text</label><textarea id="footerAbout" class="form-control" rows="2"></textarea></div></div>
                            <div class="form-full"><div class="form-group"><label>Copyright Text (HTML supported)</label><input type="text" id="footerCopyright" class="form-control"></div></div>

                            <button type="submit" class="btn btn-primary" style="width: auto; margin-top: 10px; padding: 12px 30px;">Save General Settings</button>
                        </form>
                    </div>

                    <div class="form-section">
                        <h3 class="table-title" style="margin-bottom: 25px;">Appearance & Socials</h3>
                        <form id="appearanceSettingsForm">
                            <div class="form-full dynamic-list-wrapper">
                                <label style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px; color: var(--dark-color); font-weight: 600;">
                                    Hero Banner Images/Iframes 
                                    <button type="button" class="btn-icon-add" onclick="addBannerField()"><i class="fas fa-plus"></i></button>
                                </label>
                                <div class="dynamic-list-header"><span style="flex:1;">Type</span><span style="flex:3;">URL Source</span><span style="width:32px; text-align:center;"></span></div>
                                <div id="bannerContainer" class="dynamic-list"></div>
                            </div>

                            <div class="form-full dynamic-list-wrapper">
                                <label style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px; color: var(--dark-color); font-weight: 600;">
                                    Social Links 
                                    <button type="button" class="btn-icon-add" onclick="addSocialField()"><i class="fas fa-plus"></i></button>
                                </label>
                                <div class="dynamic-list-header"><span style="flex:1;">Icon Class</span><span style="flex:2;">Link URL</span><span style="width:32px; text-align:center;"></span></div>
                                <div id="socialsContainer" class="dynamic-list"></div>
                            </div>

                            <button type="submit" class="btn btn-primary" style="width: auto; margin-top: 10px; padding: 12px 30px;">Save Slides & Socials</button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <button class="close-modal-btn" onclick="closeModal('productModal')"><i class="fas fa-times"></i></button>
            <h3 id="modalTitle" style="font-size: 22px; margin-bottom: 25px; color: var(--dark-color);">Add Product</h3>
            
            <form id="productForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="productName">Product Title</label>
                        <input type="text" id="productName" class="form-control" placeholder="Enter product title" required>
                    </div>
                    <div class="form-group">
                        <label for="productCategory">Category</label>
                        <select id="productCategory" class="form-control" required>
                            <option value="">Select Category</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-full dynamic-list-wrapper">
                    <label style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px; color: var(--dark-color); font-weight: 600;">
                        Product Images 
                        <button type="button" class="btn-icon-add" onclick="addMediaField()"><i class="fas fa-plus"></i></button>
                    </label>
                    <div class="dynamic-list-header"><span style="flex:1;">Image URL</span><span style="width:32px; text-align:center;"></span></div>
                    <div id="mediaContainer" class="dynamic-list"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="productOriginalPrice">Original Price (৳)</label>
                        <input type="number" id="productOriginalPrice" class="form-control" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="productPrice">Current Base Price (৳)</label>
                        <input type="number" id="productPrice" class="form-control" placeholder="0.00" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="productDiscount">Discount (%)</label>
                        <input type="number" id="productDiscount" class="form-control" placeholder="0" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label for="productStock">Stock Quantity</label>
                        <input type="number" id="productStock" class="form-control" placeholder="0" required>
                    </div>
                    <div class="form-group">
                        <label for="productSales">Total Sales (Fake/Real)</label>
                        <input type="number" id="productSales" class="form-control" placeholder="0">
                    </div>
                </div>
                
                <div class="form-full">
                    <div class="form-group">
                        <label for="productDescription">Product Details</label>
                        <textarea id="productDescription" class="form-control" rows="4" placeholder="Enter details..."></textarea>
                    </div>
                </div>
                
                <div class="form-full">
                    <div class="form-group">
                        <label>Product SEO Keywords</label>
                        <div class="tag-container" id="seoTagsContainer">
                            <input type="text" id="seoInput" placeholder="Type keyword and press comma (,)">
                        </div>
                    </div>
                </div>
                
                <div class="form-full">
                    <div style="display: flex; align-items: center; margin-bottom: 20px; background: var(--light-gray); padding: 15px; border-radius: 12px; border: 1px solid var(--border-color);">
                        <label class="switch">
                            <input type="checkbox" id="sizeColorToggle" onchange="toggleSizeColor()">
                            <span class="slider"></span>
                        </label>
                        <span style="font-weight: 600; color: var(--dark-color);">Enable Product Variants (Color/Size)</span>
                    </div>
                    <div id="sizeColorSection" class="hidden dynamic-list-wrapper">
                        <label style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px; color: var(--dark-color); font-weight: 600;">
                            Variants Options 
                            <button type="button" class="btn-icon-add" onclick="addSizeColorField()"><i class="fas fa-plus"></i></button>
                        </label>
                        <div class="dynamic-list-header">
                            <span style="flex:2;">Color, Size</span>
                            <span style="flex:1;">Price</span>
                            <span style="flex:2;">Image URL</span>
                            <span style="width:32px; text-align:center;"></span>
                        </div>
                        <div id="sizeColorContainer" class="dynamic-list"></div>
                    </div>
                </div>

                <div class="form-full">
                    <div class="form-group">
                        <label>Allowed Payment Gateways</label>
                        <div id="productGatewaysContainer" style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; padding: 15px; border: 1px solid var(--border-color); border-radius: 12px; background: var(--light-gray);">
                            <!-- Injected by JS -->
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="productStatus">Status</label>
                    <select id="productStatus" class="form-control" required>
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                        <option value="Out of Stock">Out of Stock</option>
                    </select>
                </div>
                
                <div class="form-row" style="margin-top: 30px;">
                    <button type="submit" class="btn btn-primary">Save Product</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('productModal')" style="margin-top: 0;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <button class="close-modal-btn" onclick="closeModal('categoryModal')"><i class="fas fa-times"></i></button>
            <h3 id="categoryModalTitle" style="font-size: 22px; margin-bottom: 25px;">Add New Category</h3>
            <form id="categoryForm">
                <div class="form-group">
                    <label for="categoryName">Category Name</label>
                    <input type="text" id="categoryName" class="form-control" placeholder="e.g. Covers" required>
                </div>
                
                <div class="form-group">
                    <label>Category Icon / Image</label>
                    <div style="display: flex; gap: 20px; margin-bottom: 10px; font-size: 14px; background: var(--light-gray); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                        <label style="cursor: pointer;"><input type="radio" name="catMediaType" value="icon" checked onchange="toggleCategoryMedia()"> FontAwesome Icon</label>
                        <label style="cursor: pointer;"><input type="radio" name="catMediaType" value="image" onchange="toggleCategoryMedia()"> Image URL</label>
                    </div>
                </div>
                
                <div class="form-group" id="catIconGroup">
                    <label for="categoryIcon">Category Icon Class</label>
                    <input type="text" id="categoryIcon" class="form-control" placeholder="e.g. fas fa-mobile-alt">
                </div>
                
                <div class="form-group hidden" id="catImageGroup">
                    <label for="categoryImage">Category Image URL</label>
                    <input type="url" id="categoryImage" class="form-control" placeholder="https://example.com/icon.png">
                </div>

                <div class="form-row" style="margin-top: 30px;">
                    <button type="submit" class="btn btn-primary">Save Category</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('categoryModal')" style="margin-top: 0;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="offerModal" class="modal">
        <div class="modal-content">
            <button class="close-modal-btn" onclick="closeModal('offerModal')"><i class="fas fa-times"></i></button>
            <h3 style="font-size: 22px; margin-bottom: 25px;">Create Promotional Offer</h3>
            <form id="offerForm">
                <div class="form-group"><label for="offerName">Offer Name</label><input type="text" id="offerName" class="form-control" required></div>
                
                <div class="form-section" style="padding: 20px; margin-top: 20px;">
                    <h4 style="margin: 0 0 15px; font-size: 15px; color: var(--primary-color);">Banner Contents</h4>
                    <div class="form-row" style="margin-bottom: 10px;">
                        <div class="form-group"><label for="offerTitle">Offer Title</label><input type="text" id="offerTitle" class="form-control"></div>
                        <div class="form-group"><label for="offerSubtitle">Offer Subtitle</label><input type="text" id="offerSubtitle" class="form-control"></div>
                    </div>
                    <div class="form-full"><div class="form-group"><label for="offerDesc">Offer Description</label><textarea id="offerDesc" class="form-control" rows="2"></textarea></div></div>
                </div>

                <div class="form-row">
                    <div class="form-group"><label for="offerDiscount">Discount (%)</label><input type="number" id="offerDiscount" class="form-control" required></div>
                    <div class="form-group">
                        <label for="offerCategory">Applicable To</label>
                        <select id="offerCategory" class="form-control"><option value="">All Categories</option></select>
                    </div>
                </div>
                <div class="form-group"><label for="offerExpiry">Expiry Date</label><input type="date" id="offerExpiry" class="form-control" required></div>
                
                <div class="form-row" style="margin-top: 30px;">
                    <button type="submit" class="btn btn-primary">Save Offer</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('offerModal')" style="margin-top: 0;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="popUpModal" class="modal">
        <div class="modal-content">
            <button class="close-modal-btn" onclick="closeModal('popUpModal')"><i class="fas fa-times"></i></button>
            <h3 id="popUpModalTitle" style="font-size: 22px; margin-bottom: 25px;">Configure Pop Up</h3>
            <form id="popUpForm">
                <div class="form-group">
                    <label for="popUpSection">Display Target</label>
                    <select id="popUpSection" class="form-control" required onchange="togglePopUpFields()">
                        <option value="opening">Opening Page (App Startup)</option>
                        <option value="random-product">Random Product Pages</option>
                    </select>
                </div>
                
                <div class="form-group hidden" id="popUpNameField">
                    <label for="popUpName">Pop Up Identifier Name</label>
                    <input type="text" id="popUpName" class="form-control" placeholder="Enter pop up internal name">
                </div>
                
                <div class="form-group">
                    <label for="popUpBannerLogo">Visual Media (Image URL)</label>
                    <input type="text" id="popUpBannerLogo" class="form-control" required>
                </div>
                
                <div class="form-full">
                    <div style="display: flex; align-items: center; margin: 20px 0; background: var(--light-gray); padding: 15px; border-radius: 12px; border: 1px solid var(--border-color);">
                        <label class="switch"><input type="checkbox" id="popUpActionButtonToggle" onchange="togglePopUpActionButton()"><span class="slider"></span></label>
                        <span style="font-weight: 600;">Enable Interactive Action Button</span>
                    </div>
                </div>
                
                <div id="popUpActionButtonFields" class="hidden form-section" style="padding: 20px;">
                    <div class="form-group"><label for="popUpActionButtonName">Button Text</label><input type="text" id="popUpActionButtonName" class="form-control"></div>
                    <div class="form-group"><label for="popUpActionButtonLink">Redirection URL</label><input type="text" id="popUpActionButtonLink" class="form-control"></div>
                </div>

                <div class="form-row" style="margin-top: 30px;">
                    <button type="submit" class="btn btn-primary">Save Config</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('popUpModal')" style="margin-top: 0;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="gatewayModal" class="modal">
        <div class="modal-content">
            <button class="close-modal-btn" onclick="closeModal('gatewayModal')"><i class="fas fa-times"></i></button>
            <h3 id="gatewayModalTitle" style="font-size: 22px; margin-bottom: 25px;">Payment Gateway Integration</h3>
            <form id="gatewayForm">
                <div class="form-group"><label for="gatewayLogo">Gateway Logo (URL)</label><input type="url" id="gatewayLogo" class="form-control" required></div>
                <div class="form-group"><label for="gatewayName">Service Name</label><input type="text" id="gatewayName" class="form-control" required></div>
                
                <div class="form-group">
                    <label>Implementation Method</label>
                    <div style="display: flex; gap: 20px; margin-bottom: 10px; font-size: 14px; background: var(--light-gray); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                        <label style="cursor:pointer;"><input type="radio" name="gatewayIntegrationType" value="link" checked onchange="toggleGatewayIntegration()"> Direct Page Link</label>
                        <label style="cursor:pointer;"><input type="radio" name="gatewayIntegrationType" value="plugin" onchange="toggleGatewayIntegration()"> Hosted Plugin URL</label>
                    </div>
                </div>
                
                <div class="form-group" id="gatewayLinkGroup">
                    <label for="gatewayLink">Local Page Link</label>
                    <input type="text" id="gatewayLink" class="form-control" placeholder="Enter here...">
                </div>
                
                <div class="form-group hidden" id="gatewayPluginGroup">
                    <label for="gatewayPlugin">External API/Plugin URL</label>
                    <input type="url" id="gatewayPlugin" class="form-control" placeholder="https://...">
                </div>
                
                <div class="form-row" style="margin-top: 30px;">
                    <button type="submit" class="btn btn-primary">✔</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('gatewayModal')" style="margin-top: 0;">✘</button>
                </div>
            </form>
        </div>
    </div>

    <div id="orderDetailsModal" class="modal">
        <div class="modal-content">
            <button class="close-modal-btn" onclick="closeModal('orderDetailsModal')"><i class="fas fa-times"></i></button>
            <h3 style="font-size: 22px; margin-bottom: 25px;">Invoice Details <span id="detailOrderId" style="color: var(--primary-color);"></span></h3>
            
            <div id="orderDetailsContent" style="background: var(--light-gray); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);"></div>
            
            <div style="margin-top: 30px; text-align: right;">
                <button class="btn btn-secondary" onclick="closeModal('orderDetailsModal')" style="width: auto; padding: 10px 30px;">Dismiss</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD5p-7Cgep9aGf6omMXDH8LOTy0C76jJaQ",
            authDomain: "e-commerce-shop-24.firebaseapp.com",
            projectId: "e-commerce-shop-24",
            storageBucket: "e-commerce-shop-24.firebasestorage.app",
            messagingSenderId: "1000897291264",
            appId: "1:1000897291264:web:4f1e78554c3e69d310a4e5",
            measurementId: "G-MCFXRFDFT5"
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Data Arrays & Variables
        let adminProducts = [];
        let adminCategories = [];
        let adminOrders = [];
        let adminCustomers = [];
        let adminOffers = [];
        let adminPopups = [];
        let adminGateways = [];
        let adminSeoKeywords = [];

        let isEditingProduct = false;
        let editingProductId = null;
        let isEditingCategory = false;
        let editingCategoryId = null;
        let isEditingPopUp = false;
        let editingPopUpId = null;
        let isEditingGateway = false;
        let editingGatewayId = null;
        let currentOrderFilter = 'Pending';
        
        let adminLastSeenOrderCount = parseInt(localStorage.getItem('adminLastSeenOrderCount')) || 0;

        const loginPage = document.getElementById('loginPage');
        const dashboard = document.getElementById('dashboard');
        const loginForm = document.getElementById('loginForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const sidebar = document.querySelector('.sidebar');
        const toggleSidebar = document.querySelector('.toggle-sidebar');
        const closeSidebarBtn = document.querySelector('.close-sidebar');
        const menuItems = document.querySelectorAll('.menu-item');
        const pageContents = document.querySelectorAll('.page-content');
        const togglePasswordBtn = document.getElementById('togglePassword');
        const passwordInput = document.getElementById('adminPassword');
        
        const seoInput = document.getElementById('seoInput');
        const seoTagsContainer = document.getElementById('seoTagsContainer');

        const productsTable = document.getElementById('productsTable');
        const categoriesTable = document.getElementById('categoriesTable');
        const ordersTable = document.getElementById('ordersTable');
        const customersTable = document.getElementById('customersTable');
        const offersTable = document.getElementById('offersTable');
        const popUpsTable = document.getElementById('popUpsTable');
        const gatewaysTable = document.getElementById('gatewaysTable');
        const recentOrdersTable = document.getElementById('recentOrdersTable');
        const productCategorySelect = document.getElementById('productCategory');
        const offerCategorySelect = document.getElementById('offerCategory');

        const productForm = document.getElementById('productForm');
        const categoryForm = document.getElementById('categoryForm');
        const offerForm = document.getElementById('offerForm');
        const popUpForm = document.getElementById('popUpForm');
        const gatewayForm = document.getElementById('gatewayForm');
        const generalSettingsForm = document.getElementById('generalSettingsForm');
        const appearanceSettingsForm = document.getElementById('appearanceSettingsForm');

        // Helper: Navigate Page System (History API) - Fix 3
        function navigateToPage(target, pushToHistory = true) {
            if (!target) return;
            
            menuItems.forEach(i => {
                if(i.getAttribute('data-page') === target) {
                    i.classList.add('active');
                    document.querySelector('.page-title').textContent = i.textContent.trim();
                } else {
                    i.classList.remove('active');
                }
            });
            
            pageContents.forEach(p => p.classList.add('hidden'));
            const targetEl = document.getElementById(`${target}Page`);
            if (targetEl) targetEl.classList.remove('hidden');
            
            if(window.innerWidth <= 768) sidebar.classList.remove('active');
            
            if (target === 'orders') {
                adminLastSeenOrderCount = adminOrders.length;
                localStorage.setItem('adminLastSeenOrderCount', adminLastSeenOrderCount);
                document.getElementById('menuOrdersLink').classList.remove('notification-dot');
                document.getElementById('toggleSidebarBtn').classList.remove('notification-dot');
                document.getElementById('cardOrders').classList.remove('notification-dot');
            }

            if(pushToHistory) {
                history.pushState({ page: target }, '', `#${target}`);
            }
            localStorage.setItem('adminCurrentPage', target);
        }

        // Setup History Popstate
        window.addEventListener('popstate', function(e) {
            if (e.state && e.state.page) {
                navigateToPage(e.state.page, false);
            } else {
                const hashPage = location.hash.replace('#', '') || 'dashboard';
                navigateToPage(hashPage, false);
            }
        });

        // Helper: Generate PID 
        function generatePID() {
            let max = 0;
            adminProducts.forEach(p => {
                if (p.pid && p.pid.toUpperCase().startsWith('PID-')) {
                    let num = parseInt(p.pid.substring(4));
                    if (!isNaN(num) && num > max) max = num;
                }
            });
            return 'PID-' + String(max + 1).padStart(2, '0');
        }

        // Auth Listener
        auth.onAuthStateChanged((user) => {
            if (user) {
                loginPage.classList.add('hidden');
                dashboard.classList.remove('hidden');
                loadAllFirebaseData();
                
                // History Management on load
                const initialPage = location.hash.replace('#', '') || localStorage.getItem('adminCurrentPage') || 'dashboard';
                navigateToPage(initialPage, false);
                history.replaceState({ page: initialPage }, '', `#${initialPage}`);
            } else {
                dashboard.classList.add('hidden');
                loginPage.classList.remove('hidden');
            }
        });

        window.togglePopUpFields = function() {
            const section = document.getElementById('popUpSection').value;
            const nameField = document.getElementById('popUpNameField');
            const nameInput = document.getElementById('popUpName');
            if (section === 'random-product') {
                nameField.classList.remove('hidden');
                nameInput.required = true;
            } else {
                nameField.classList.add('hidden');
                nameInput.required = false;
                nameInput.value = '';
            }
        };

        window.toggleCategoryMedia = function() {
            const val = document.querySelector('input[name="catMediaType"]:checked').value;
            if (val === 'icon') {
                document.getElementById('catIconGroup').classList.remove('hidden');
                document.getElementById('catImageGroup').classList.add('hidden');
                document.getElementById('categoryIcon').required = true;
                document.getElementById('categoryImage').required = false;
            } else {
                document.getElementById('catIconGroup').classList.add('hidden');
                document.getElementById('catImageGroup').classList.remove('hidden');
                document.getElementById('categoryIcon').required = false;
                document.getElementById('categoryImage').required = true;
            }
        };

        window.toggleGatewayIntegration = function() {
            const val = document.querySelector('input[name="gatewayIntegrationType"]:checked').value;
            if (val === 'link') {
                document.getElementById('gatewayLinkGroup').classList.remove('hidden');
                document.getElementById('gatewayPluginGroup').classList.add('hidden');
                document.getElementById('gatewayLink').required = true;
                document.getElementById('gatewayPlugin').required = false;
            } else {
                document.getElementById('gatewayLinkGroup').classList.add('hidden');
                document.getElementById('gatewayPluginGroup').classList.remove('hidden');
                document.getElementById('gatewayLink').required = false;
                document.getElementById('gatewayPlugin').required = true;
            }
        };

        function renderProductGateways(selectedGateways = null) {
            const container = document.getElementById('productGatewaysContainer');
            let html = '';
            
            let checkCOD = selectedGateways === null || selectedGateways.includes('COD') ? 'checked' : '';
            html += `<label style="display:flex; align-items:center; gap:8px; cursor:pointer;"><input type="checkbox" class="gateway-checkbox" value="COD" ${checkCOD}> Cash on Delivery (COD)</label>`;
            
            adminGateways.forEach(g => {
                let checkGW = selectedGateways === null || selectedGateways.includes(g.id) ? 'checked' : '';
                html += `<label style="display:flex; align-items:center; gap:8px; cursor:pointer;"><input type="checkbox" class="gateway-checkbox" value="${g.id}" ${checkGW}> ${g.name}</label>`;
            });
            container.innerHTML = html;
        }

        // Initialize UI Events
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('click', function(e) {
                if (window.innerWidth <= 768 && sidebar.classList.contains('active')) {
                    if (!sidebar.contains(e.target) && !document.getElementById('toggleSidebarBtn').contains(e.target)) {
                        sidebar.classList.remove('active');
                    }
                }
            });

            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('adminEmail').value;
                const password = document.getElementById('adminPassword').value;
                auth.signInWithEmailAndPassword(email, password).catch(err => alert('Login Failed: ' + err.message));
            });

            togglePasswordBtn.addEventListener('click', function() {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                this.classList.toggle('fa-eye');
                this.classList.toggle('fa-eye-slash');
            });

            logoutBtn.addEventListener('click', function(e) {
                e.preventDefault();
                auth.signOut();
            });

            toggleSidebar.addEventListener('click', () => sidebar.classList.add('active'));
            closeSidebarBtn.addEventListener('click', () => sidebar.classList.remove('active'));

            menuItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    navigateToPage(this.getAttribute('data-page'));
                });
            });

            document.getElementById('themeToggle').addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                const icon = document.getElementById('themeToggle').querySelector('i');
                icon.classList.toggle('fa-moon');
                icon.classList.toggle('fa-sun');
            });

            const searchInput = document.getElementById('productSearchById');
            if (searchInput) searchInput.addEventListener('input', populateProductsTable);

            // Modals Logic - Adding clear resets (Fix 1)
            document.getElementById('addProductBtn').addEventListener('click', () => {
                isEditingProduct = false;
                document.getElementById('modalTitle').textContent = 'Add New Product';
                document.querySelector('#productForm button[type="submit"]').textContent = 'Save Product';
                productForm.reset();
                resetSEO();
                
                // FIX 1: Cleared containers properly
                document.getElementById('sizeColorContainer').innerHTML = ''; 
                document.getElementById('mediaContainer').innerHTML = '';
                addMediaField();
                
                document.getElementById('sizeColorToggle').checked = false;
                toggleSizeColor();
                renderProductGateways(null);
                openModal('productModal');
            });

            document.getElementById('addCategoryBtn').addEventListener('click', () => {
                isEditingCategory = false;
                editingCategoryId = null;
                document.getElementById('categoryModalTitle').textContent = 'Add New Category';
                document.querySelector('#categoryForm button[type="submit"]').textContent = 'Save Category';
                categoryForm.reset();
                document.querySelector('input[name="catMediaType"][value="icon"]').checked = true;
                toggleCategoryMedia();
                openModal('categoryModal');
            });

            document.getElementById('createOfferBtn').addEventListener('click', () => {
                offerForm.reset();
                document.getElementById('offerExpiry').value = new Date().toISOString().split('T')[0];
                openModal('offerModal');
            });

            document.getElementById('addPopUpBtn').addEventListener('click', () => {
                isEditingPopUp = false;
                document.getElementById('popUpModalTitle').textContent = 'Configure Pop Up';
                document.querySelector('#popUpForm button[type="submit"]').textContent = 'Save Config';
                popUpForm.reset();
                document.getElementById('popUpSection').value = 'opening';
                togglePopUpFields();
                document.getElementById('popUpActionButtonFields').classList.add('hidden');
                openModal('popUpModal');
            });
            
            document.getElementById('addGatewayBtn').addEventListener('click', () => {
                isEditingGateway = false;
                editingGatewayId = null;
                document.getElementById('gatewayModalTitle').textContent = 'Payment Gateway Integration';
                document.querySelector('#gatewayForm button[type="submit"]').textContent = 'Save Gateway';
                gatewayForm.reset();
                document.querySelector('input[name="gatewayIntegrationType"][value="link"]').checked = true;
                toggleGatewayIntegration();
                openModal('gatewayModal');
            });

            document.querySelector('.view-all-orders').addEventListener('click', (e) => {
                e.preventDefault();
                navigateToPage('orders');
            });

            seoInput.addEventListener('keydown', handleSeoInput);

            productForm.addEventListener('submit', handleProductSubmit);
            categoryForm.addEventListener('submit', handleCategorySubmit);
            offerForm.addEventListener('submit', handleOfferSubmit);
            popUpForm.addEventListener('submit', handlePopUpSubmit);
            gatewayForm.addEventListener('submit', handleGatewaySubmit);
            generalSettingsForm.addEventListener('submit', saveGeneralSettings);
            appearanceSettingsForm.addEventListener('submit', saveSlidesAndSocials);
        });

        // Firebase Data Fetching
        async function loadAllFirebaseData() {
            loadSettings();
            loadCategories();
            loadProducts();
            loadOrders();
            loadCustomers();
            loadOffers();
            loadPopups();
            loadGateways();
        }

        async function loadSettings() {
            try {
                const doc = await db.collection('settings').doc('general').get();
                if(doc.exists) {
                    const data = doc.data();
                    document.getElementById('siteName').value = data.siteName || '';
                    document.getElementById('logoUrl').value = data.logoUrl || '';
                    document.getElementById('heroTitle').value = data.heroTitle || '';
                    document.getElementById('heroDesc').value = data.heroDesc || '';
                    document.getElementById('deliveryInside').value = data.deliveryInside || 0;
                    document.getElementById('deliveryOutside').value = data.deliveryOutside || 0;
                    document.getElementById('footerPhone').value = data.footerPhone || '';
                    document.getElementById('footerEmail').value = data.footerEmail || '';
                    document.getElementById('footerAddress').value = data.footerAddress || '';
                    document.getElementById('footerAbout').value = data.footerAbout || '';
                    document.getElementById('footerCopyright').value = data.footerCopyright || '';
                    
                    document.getElementById('loginStoreName').innerText = `${data.siteName || 'Store'} Admin`;
                    document.getElementById('sidebarStoreName').innerHTML = `<i class="fas fa-bolt" style="color:var(--warning-color)"></i> ${data.siteName || 'Admin'}`;
                }

                // Load Hero Slides
                const slidesSnap = await db.collection('heroSlides').orderBy('order').get();
                const bannerContainer = document.getElementById('bannerContainer');
                bannerContainer.innerHTML = '';
                slidesSnap.forEach(d => {
                    const s = d.data();
                    addBannerField(s.src, s.type, d.id);
                });

                // Load Socials
                const socialsSnap = await db.collection('socials').get();
                const socialsContainer = document.getElementById('socialsContainer');
                socialsContainer.innerHTML = '';
                socialsSnap.forEach(d => {
                    const s = d.data();
                    addSocialField(s.iconClass, s.url, d.id);
                });
            } catch(e) { console.error(e); }
        }

        function loadCategories() {
            db.collection('categories').onSnapshot(snap => {
                adminCategories = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                populateCategoriesTable();
                populateCategoryDropdowns();
            });
        }

        function loadProducts() {
            db.collection('products').onSnapshot(snap => {
                adminProducts = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                populateProductsTable();
                updateDashboardStats();
            });
        }

        function loadOrders() {
            db.collection('orders').onSnapshot(snap => {
                adminOrders = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                if (adminOrders.length > adminLastSeenOrderCount) {
                    document.getElementById('menuOrdersLink').classList.add('notification-dot');
                    document.getElementById('toggleSidebarBtn').classList.add('notification-dot');
                    document.getElementById('cardOrders').classList.add('notification-dot');
                }
                populateOrdersTable();
                populateRecentOrdersTable();
                updateDashboardStats();
            });
        }

        function loadCustomers() {
            db.collection('users').onSnapshot(snap => {
                adminCustomers = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                populateCustomersTable();
                updateDashboardStats();
            });
        }

        function loadOffers() {
            db.collection('offers').onSnapshot(snap => {
                adminOffers = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                populateOffersTable();
            });
        }

        function loadPopups() {
            db.collection('popups').onSnapshot(snap => {
                adminPopups = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                populatePopUpsTable();
            });
        }

        function loadGateways() {
            db.collection('paymentGateways').onSnapshot(snap => {
                adminGateways = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                populateGatewaysTable();
            });
        }

        // Render Tables
        function populateProductsTable() {
            productsTable.innerHTML = '';
            const searchInput = document.getElementById('productSearchById');
            const searchVal = searchInput ? searchInput.value.toLowerCase().trim() : '';

            const filteredProducts = adminProducts.filter(p => {
                if (!searchVal) return true;
                const pidStr = (p.pid || '').toLowerCase();
                const variantMatch = p.variants && p.variants.some(v => (v.variantId || '').toLowerCase().includes(searchVal));
                return pidStr.includes(searchVal) || variantMatch;
            });

            filteredProducts.forEach(p => {
                const img = (p.images && p.images.length > 0) ? p.images[0] : '';
                let currentStatus = p.status || 'Active';
                if (p.stock <= 0 && currentStatus !== 'Inactive') currentStatus = 'Out of Stock';
                let statusClass = 'status-active';
                if (currentStatus === 'Out of Stock') statusClass = 'status-out';
                if (currentStatus === 'Inactive') statusClass = 'status-cancelled';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="display:flex; align-items:center; gap:12px;">
                            <img src="${img}" style="width:45px; height:45px; border-radius:8px; object-fit:cover; border: 1px solid var(--border-color);">
                            <strong style="color:var(--primary-color); font-size: 13px;">${p.pid || 'N/A'}</strong>
                        </div>
                    </td>
                    <td style="font-weight: 500;">${p.name}</td>
                    <td>${p.category}</td>
                    <td style="font-weight: 600;">৳${p.price}</td>
                    <td>${p.stock || 0}</td>
                    <td><span class="status ${statusClass}">${currentStatus}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-edit" onclick="editProduct('${p.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn-action btn-delete" onclick="deleteProduct('${p.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                productsTable.appendChild(row);

                if (p.variants && p.variants.length > 0) {
                    p.variants.forEach(v => {
                        const varRow = document.createElement('tr');
                        varRow.style.backgroundColor = 'rgba(59, 130, 246, 0.02)';
                        const varImg = v.image ? `<img src="${v.image}" style="width:30px; height:30px; border-radius:6px; object-fit:cover;">` : `<i class="fas fa-level-up-alt fa-rotate-90" style="color: var(--gray-color); margin-left: 10px;"></i>`;
                        varRow.innerHTML = `
                            <td style="padding-left: 35px;">
                                <div style="display:flex; align-items:center; gap:10px;">
                                    ${varImg}
                                    <span style="font-size: 12px; color: var(--gray-color); font-weight: 600;">${v.variantId || 'N/A'}</span>
                                </div>
                            </td>
                            <td colspan="2" style="font-size: 13px; color: var(--gray-color);">Variant: ${v.color} ${v.size !== 'N/A' ? `(${v.size})` : ''}</td>
                            <td style="font-size: 13px; font-weight: 600;">৳${v.price}</td>
                            <td colspan="3"></td>
                        `;
                        productsTable.appendChild(varRow);
                    });
                }
            });
        }

        function populateCategoriesTable() {
            categoriesTable.innerHTML = '';
            adminCategories.forEach(c => {
                const count = adminProducts.filter(p => p.category === c.slug).length;
                let mediaHtml = c.mediaType === 'image' && c.imageUrl 
                    ? `<img src="${c.imageUrl}" style="width: 40px; height: 40px; border-radius: 8px; object-fit: cover;">` 
                    : `<div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: rgba(59, 130, 246, 0.1); border-radius: 8px;"><i class="${c.iconClass || 'fas fa-layer-group'}" style="font-size:18px; color:var(--primary-color);"></i></div>`;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${mediaHtml}</td>
                    <td style="font-weight: 500;">${c.name}</td>
                    <td><span style="background: var(--light-gray); padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">${count} Items</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-edit" onclick="editCategory('${c.id}')"><i class="fas fa-edit"></i> Edit</button>
                            <button class="btn-action btn-delete" onclick="deleteCategory('${c.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                categoriesTable.appendChild(row);
            });
        }

        function populateOrdersTable() {
            ordersTable.innerHTML = '';
            const filteredOrders = adminOrders.filter(order => {
                if (currentOrderFilter === 'Pending') return ['Pending', 'Received', 'Packing', 'Handover', 'Processing'].includes(order.status) || !order.status;
                if (currentOrderFilter === 'Delivered') return order.status === 'Delivered';
                if (currentOrderFilter === 'Cancelled') return order.status === 'Cancelled';
                return false;
            });
            if (filteredOrders.length === 0) {
                ordersTable.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 30px; color: var(--gray-color);">No orders found in this category.</td></tr>`;
                return;
            }
            filteredOrders.forEach(o => {
                let productsHtml = '';
                let itemsArray = Array.isArray(o.cartItems) ? o.cartItems : (Array.isArray(o.products) ? o.products : null);
                
                if (itemsArray) {
                    itemsArray.forEach(item => {
                        let variantInfo = [];
                        if (item.color && item.color !== 'N/A') variantInfo.push(item.color);
                        if (item.size && item.size !== 'N/A') variantInfo.push(item.size);
                        let varStr = variantInfo.length ? ` <span style="color:var(--gray-color)">| ${variantInfo.join(', ')}</span>` : '';
                        
                        let imgHtml = item.image ? `<img src="${item.image}" style="width:40px;height:40px;object-fit:cover;border-radius:6px;flex-shrink:0;">` : `<div style="width:40px;height:40px;background:var(--light-gray);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0;">No Img</div>`;
                        
                        productsHtml += `
                            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px; border-bottom:1px dashed var(--border-color); padding-bottom:8px;">
                                ${imgHtml}
                                <div style="font-size:13px; line-height:1.4;">
                                    <div style="font-weight: 500;">${item.name} <span style="color: var(--primary-color)">(x${item.qty || 1})</span></div>
                                    <div style="font-size:11px; margin-top:2px;">
                                        <span style="background: var(--light-gray); padding: 2px 6px; border-radius: 4px; font-weight:600;">${item.pid || 'PID: N/A'}</span>${varStr}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                } else { productsHtml = o.products || 'N/A'; }

                let paymentHtml = `<div style="font-weight:600; color:var(--dark-color);">${o.payment || 'N/A'}</div>`;
                if (o.payment && o.payment.toUpperCase() !== 'COD' && o.trxId) {
                    paymentHtml += `
                    <div style="font-size:12px; margin-top:5px; background:rgba(59,130,246,0.1); padding:4px 8px; border-radius:6px; display:inline-flex; align-items: center; color:var(--primary-color); font-weight: 500;">
                        ${o.trxId} 
                        <i class="fas fa-copy" style="cursor:pointer; margin-left:8px;" onclick="navigator.clipboard.writeText('${o.trxId}'); alert('TrxID Copied!')" title="Copy TrxID"></i>
                    </div>`;
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 600; color: var(--primary-color);">#${o.id.substring(0,8)}</td>
                    <td style="font-weight: 500;">${o.customer}</td>
                    <td style="min-width: 280px; white-space: normal;">${productsHtml}</td>
                    <td style="font-weight: 600; font-size: 15px;">৳${o.amount}</td>
                    <td>${paymentHtml}</td>
                    <td>
                        <select class="status-select" onchange="updateOrderStatus('${o.id}', this.value)">
                            <option value="Pending" ${o.status === 'Pending' || !o.status ? 'selected' : ''}>Pending</option>
                            <option value="Received" ${o.status === 'Received' ? 'selected' : ''}>Received</option>
                            <option value="Packing" ${o.status === 'Packing' ? 'selected' : ''}>Packing</option>
                            <option value="Handover" ${o.status === 'Handover' ? 'selected' : ''}>Handover</option>
                            <option value="Delivered" ${o.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                            <option value="Cancelled" ${o.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-view" onclick="viewOrderDetails('${o.id}')"><i class="fas fa-eye"></i></button>
                            <button class="btn-action btn-delete" onclick="deleteOrder('${o.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                ordersTable.appendChild(row);
            });
        }

        function populateRecentOrdersTable() {
            recentOrdersTable.innerHTML = '';
            const recent = adminOrders.slice(0, 5);
            recent.forEach(o => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 600; color: var(--primary-color);">#${o.id.substring(0,8)}</td>
                    <td style="font-weight: 500;">${o.customer}</td>
                    <td style="font-weight: 600;">৳${o.amount}</td>
                    <td><span class="status ${o.status==='Delivered'?'status-delivered':(o.status==='Cancelled'?'status-cancelled':'status-pending')}">${o.status || 'Pending'}</span></td>
                    <td style="color: var(--gray-color); font-size: 13px;">${o.date || 'N/A'}</td>
                `;
                recentOrdersTable.appendChild(row);
            });
        }

        function populateCustomersTable() {
            customersTable.innerHTML = '';
            adminCustomers.forEach(c => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 500;">${c.name}</td>
                    <td style="color: var(--primary-color);">${c.email}</td>
                    <td>${c.phone || '<span style="color:var(--gray-color)">N/A</span>'}</td>
                    <td style="font-weight: 600;">-</td>
                `;
                customersTable.appendChild(row);
            });
        }

        function populateOffersTable() {
            offersTable.innerHTML = '';
            adminOffers.forEach(o => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 500;">${o.name}</td>
                    <td style="color: var(--danger-color); font-weight: 600;">${o.discount}%</td>
                    <td><span style="background: var(--light-gray); padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">${o.category}</span></td>
                    <td style="color: var(--gray-color); font-size: 13px;">${o.expiry}</td>
                    <td><span class="status status-active">Active</span></td>
                    <td><button class="btn-action btn-delete" onclick="db.collection('offers').doc('${o.id}').delete()"><i class="fas fa-trash"></i></button></td>
                `;
                offersTable.appendChild(row);
            });
        }

        function populatePopUpsTable() {
            popUpsTable.innerHTML = '';
            adminPopups.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><img src="${p.bannerLogo || p.image || ''}" width="50" style="object-fit:cover; border-radius: 8px; border: 1px solid var(--border-color);"></td>
                    <td style="font-weight: 500;">${p.section === 'random-product' ? (p.name || 'N/A') : 'Opening App Ad'}</td>
                    <td><span style="background: var(--light-gray); padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">${p.section === 'opening' ? 'Opening Page' : 'Random Product'}</span></td>
                    <td>${p.actionButton ? `<span style="color:var(--primary-color); font-weight:500;">${p.actionButtonName}</span>` : '<span style="color:var(--gray-color)">None</span>'}</td>
                    <td><span class="status status-active">Live</span></td>
                    <td>
                        <button class="btn-action btn-edit" onclick="editPopUp('${p.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn-action btn-delete" onclick="db.collection('popups').doc('${p.id}').delete()"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                popUpsTable.appendChild(row);
            });
        }

        function populateGatewaysTable() {
            gatewaysTable.innerHTML = '';
            adminGateways.forEach(g => {
                let linkHref = g.integrationType === 'plugin' ? g.pluginUrl : g.link;
                let linkType = g.integrationType === 'plugin' ? 'API Plugin' : 'Local Page';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><img src="${g.logo}" width="45" height="45" style="object-fit:contain; border-radius:8px; border: 1px solid var(--border-color); background: #fff; padding: 2px;"></td>
                    <td style="font-weight: 600; font-size: 15px;">${g.name}</td>
                    <td><a href="${linkHref}" target="_blank" style="color:var(--primary-color); font-weight: 500;">${linkType} <i class="fas fa-external-link-alt" style="font-size: 10px;"></i></a></td>
                    <td>
                        <button class="btn-action btn-edit" onclick="editGateway('${g.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn-action btn-delete" onclick="deleteGateway('${g.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                gatewaysTable.appendChild(row);
            });
        }

        function populateCategoryDropdowns() {
            while (productCategorySelect.options.length > 1) { productCategorySelect.remove(1); }
            while (offerCategorySelect.options.length > 1) { offerCategorySelect.remove(1); }
            adminCategories.forEach(c => {
                const option1 = document.createElement('option');
                option1.value = c.slug; option1.textContent = c.name;
                productCategorySelect.appendChild(option1);
                const option2 = document.createElement('option');
                option2.value = c.slug; option2.textContent = c.name;
                offerCategorySelect.appendChild(option2);
            });
        }

        function updateDashboardStats() {
            document.getElementById('totalProducts').textContent = adminProducts.length;
            document.getElementById('totalOrders').textContent = adminOrders.length;
            document.getElementById('totalCustomers').textContent = adminCustomers.length;
            const revenue = adminOrders.filter(o => o.status === 'Delivered').reduce((sum, o) => sum + Number(o.amount), 0);
            document.getElementById('totalRevenue').textContent = '৳' + revenue.toFixed(2);
        }

        // Submits & Actions
        async function handleProductSubmit(e) {
            e.preventDefault();
            let pid = (isEditingProduct && editingProductId) ? (adminProducts.find(p => p.id === editingProductId)?.pid || generatePID()) : generatePID();

            const name = document.getElementById('productName').value;
            const category = document.getElementById('productCategory').value;
            const originalPrice = parseFloat(document.getElementById('productOriginalPrice').value) || 0;
            const price = parseFloat(document.getElementById('productPrice').value);
            const discount = parseInt(document.getElementById('productDiscount').value) || 0;
            const stock = parseInt(document.getElementById('productStock').value) || 0;
            const sales = parseInt(document.getElementById('productSales').value) || 0;
            const description = document.getElementById('productDescription').value;
            let status = document.getElementById('productStatus').value;
            
            if(stock <= 0 && status !== 'Inactive') status = 'Out of Stock';

            const imageInputs = document.querySelectorAll('.product-media-input');
            const images = Array.from(imageInputs).map(inp => inp.value).filter(val => val.trim() !== '');
            const keywords = [...adminSeoKeywords];

            let variants = [];
            if(document.getElementById('sizeColorToggle').checked) {
                const varItems = document.querySelectorAll('#sizeColorContainer .dynamic-item');
                varItems.forEach((item, idx) => {
                    const typeVal = item.querySelector('.var-color-size').value;
                    const priceVal = parseFloat(item.querySelector('.var-price').value) || price;
                    const imgVal = item.querySelector('.var-image').value || '';
                    if(typeVal) {
                        let colorStr = typeVal; let sizeStr = "N/A";
                        if(typeVal.includes(',')) {
                            const parts = typeVal.split(',');
                            colorStr = parts[0].trim(); sizeStr = parts[1].trim();
                        }
                        variants.push({ variantId: `${pid}-V${idx+1}`, color: colorStr, size: sizeStr, price: priceVal, image: imgVal });
                    }
                });
            }

            const gatewayCheckboxes = document.querySelectorAll('.gateway-checkbox:checked');
            const allowedGateways = Array.from(gatewayCheckboxes).map(cb => cb.value);

            const payload = { pid, name, category, originalPrice, price, discount, stock, sales, description, status, images, keywords, variants, allowedGateways };
            
            try {
                if(isEditingProduct && editingProductId) {
                    await db.collection('products').doc(editingProductId).update(payload);
                } else {
                    await db.collection('products').add(payload);
                }
                closeModal('productModal');
            } catch(e) { alert(e.message); }
        }

        async function handleCategorySubmit(e) {
            e.preventDefault();
            const name = document.getElementById('categoryName').value;
            const slug = name.toLowerCase().replace(/\s+/g, '-');
            const mediaType = document.querySelector('input[name="catMediaType"]:checked').value;
            const iconClass = document.getElementById('categoryIcon').value;
            const imageUrl = document.getElementById('categoryImage').value;

            const payload = { 
                name, slug, mediaType, 
                iconClass: mediaType === 'icon' ? iconClass : '', 
                imageUrl: mediaType === 'image' ? imageUrl : '' 
            };

            try {
                if (isEditingCategory && editingCategoryId) {
                    await db.collection('categories').doc(editingCategoryId).update(payload);
                } else {
                    await db.collection('categories').add(payload);
                }
                closeModal('categoryModal');
            } catch(e) { alert(e.message); }
        }

        async function handleOfferSubmit(e) {
            e.preventDefault();
            const payload = {
                name: document.getElementById('offerName').value,
                discount: parseInt(document.getElementById('offerDiscount').value),
                category: document.getElementById('offerCategory').value || 'All Categories',
                expiry: document.getElementById('offerExpiry').value,
                offerTitle: document.getElementById('offerTitle').value,
                offerSubtitle: document.getElementById('offerSubtitle').value,
                offerDesc: document.getElementById('offerDesc').value
            };
            if(offerForm.hasAttribute('data-editing-id')) {
                const editId = offerForm.getAttribute('data-editing-id');
                await db.collection('offers').doc(editId).update(payload);
                offerForm.removeAttribute('data-editing-id');
            } else {
                await db.collection('offers').add(payload);
            }
            closeModal('offerModal');
        }

        async function handlePopUpSubmit(e) {
            e.preventDefault();
            const section = document.getElementById('popUpSection').value;
            const actionButton = document.getElementById('popUpActionButtonToggle').checked;
            const payload = {
                section: section,
                name: section === 'random-product' ? document.getElementById('popUpName').value : '',
                bannerLogo: document.getElementById('popUpBannerLogo').value,
                actionButton: actionButton,
                actionButtonName: actionButton ? document.getElementById('popUpActionButtonName').value : '',
                actionButtonLink: actionButton ? document.getElementById('popUpActionButtonLink').value : ''
            };
            if(isEditingPopUp && editingPopUpId) {
                await db.collection('popups').doc(editingPopUpId).update(payload);
            } else {
                await db.collection('popups').add(payload);
            }
            closeModal('popUpModal');
        }

        async function handleGatewaySubmit(e) {
            e.preventDefault();
            const integrationType = document.querySelector('input[name="gatewayIntegrationType"]:checked').value;
            const payload = {
                logo: document.getElementById('gatewayLogo').value,
                name: document.getElementById('gatewayName').value,
                integrationType: integrationType,
                link: integrationType === 'link' ? document.getElementById('gatewayLink').value : '',
                pluginUrl: integrationType === 'plugin' ? document.getElementById('gatewayPlugin').value : ''
            };
            if(isEditingGateway && editingGatewayId) {
                await db.collection('paymentGateways').doc(editingGatewayId).update(payload);
            } else {
                await db.collection('paymentGateways').add(payload);
            }
            closeModal('gatewayModal');
        }

        async function saveGeneralSettings(e) {
            e.preventDefault();
            const payload = {
                siteName: document.getElementById('siteName').value,
                logoUrl: document.getElementById('logoUrl').value,
                heroTitle: document.getElementById('heroTitle').value,
                heroDesc: document.getElementById('heroDesc').value,
                deliveryInside: parseFloat(document.getElementById('deliveryInside').value),
                deliveryOutside: parseFloat(document.getElementById('deliveryOutside').value),
                footerPhone: document.getElementById('footerPhone').value,
                footerEmail: document.getElementById('footerEmail').value,
                footerAddress: document.getElementById('footerAddress').value,
                footerAbout: document.getElementById('footerAbout').value,
                footerCopyright: document.getElementById('footerCopyright').value
            };
            await db.collection('settings').doc('general').set(payload, {merge:true});
            alert('Settings Saved Successfully!');
        }

        async function saveSlidesAndSocials(e) {
            e.preventDefault();
            const slideDocs = await db.collection('heroSlides').get();
            const socialDocs = await db.collection('socials').get();
            
            const batch = db.batch();
            slideDocs.forEach(d => batch.delete(d.ref));
            socialDocs.forEach(d => batch.delete(d.ref));

            const bannerItems = document.querySelectorAll('#bannerContainer .dynamic-item');
            bannerItems.forEach((item, idx) => {
                const src = item.querySelector('.banner-url').value;
                const type = item.querySelector('.banner-type').value;
                if(src) {
                    const ref = db.collection('heroSlides').doc();
                    batch.set(ref, { src, type, order: idx });
                }
            });

            const socialItems = document.querySelectorAll('#socialsContainer .dynamic-item');
            socialItems.forEach((item) => {
                const iconClass = item.querySelector('.social-icon-input').value;
                const url = item.querySelector('.social-url').value;
                if(url && iconClass) {
                    const ref = db.collection('socials').doc();
                    batch.set(ref, { iconClass, url });
                }
            });

            await batch.commit();
            alert('Hero Slides & Socials Updated!');
        }

        // Edit & Delete
        window.editProduct = function(id) {
            const p = adminProducts.find(x => x.id === id);
            if(!p) return;
            document.getElementById('productName').value = p.name;
            document.getElementById('productCategory').value = p.category;
            document.getElementById('productOriginalPrice').value = p.originalPrice || '';
            document.getElementById('productPrice').value = p.price;
            document.getElementById('productDiscount').value = p.discount || 0;
            document.getElementById('productStock').value = p.stock || 0;
            document.getElementById('productSales').value = p.sales || 0;
            document.getElementById('productDescription').value = p.description || '';
            document.getElementById('productStatus').value = p.status || 'Active';

            const mc = document.getElementById('mediaContainer'); mc.innerHTML = '';
            if(p.images) p.images.forEach(img => {
                const html = `<div class="dynamic-item"><input type="text" class="form-control product-media-input" value="${img}"><button type="button" class="btn-icon-remove" onclick="this.parentElement.remove()">-</button></div>`;
                mc.insertAdjacentHTML('beforeend', html);
            });

            adminSeoKeywords = p.keywords ? [...p.keywords] : [];
            renderTags();

            const sc = document.getElementById('sizeColorContainer'); sc.innerHTML = '';
            if(p.variants && p.variants.length > 0) {
                document.getElementById('sizeColorToggle').checked = true;
                toggleSizeColor();
                p.variants.forEach(v => {
                    const str = v.size !== "N/A" ? `${v.color}, ${v.size}` : v.color;
                    addSizeColorField(str, v.price, v.image || "");
                });
            } else {
                document.getElementById('sizeColorToggle').checked = false; toggleSizeColor();
            }

            renderProductGateways(p.allowedGateways || null);

            isEditingProduct = true; editingProductId = id;
            document.getElementById('modalTitle').textContent = 'Modify Product Details';
            openModal('productModal');
        };

        window.editCategory = function(id) {
            const c = adminCategories.find(x => x.id === id);
            if(!c) return;
            document.getElementById('categoryName').value = c.name;
            
            const mediaType = c.mediaType || 'icon';
            document.querySelector(`input[name="catMediaType"][value="${mediaType}"]`).checked = true;
            toggleCategoryMedia();
            
            if (mediaType === 'icon') {
                document.getElementById('categoryIcon').value = c.iconClass || '';
                document.getElementById('categoryImage').value = '';
            } else {
                document.getElementById('categoryImage').value = c.imageUrl || '';
                document.getElementById('categoryIcon').value = '';
            }

            isEditingCategory = true;
            editingCategoryId = id;
            document.getElementById('categoryModalTitle').textContent = 'Update Category';
            openModal('categoryModal');
        };

        window.deleteProduct = function(id) { if(confirm("Confirm product deletion?")) db.collection('products').doc(id).delete(); };
        window.deleteCategory = function(id) { if(confirm("Confirm category deletion?")) db.collection('categories').doc(id).delete(); };

        window.editPopUp = function(id) {
            const p = adminPopups.find(x => x.id === id);
            if(!p) return;
            document.getElementById('popUpSection').value = p.section;
            togglePopUpFields();
            if(p.section === 'random-product') document.getElementById('popUpName').value = p.name || '';
            document.getElementById('popUpBannerLogo').value = p.bannerLogo || p.image || '';
            document.getElementById('popUpActionButtonToggle').checked = p.actionButton || false;
            togglePopUpActionButton();
            if(p.actionButton) {
                document.getElementById('popUpActionButtonName').value = p.actionButtonName || '';
                document.getElementById('popUpActionButtonLink').value = p.actionButtonLink || '';
            } else {
                document.getElementById('popUpActionButtonName').value = '';
                document.getElementById('popUpActionButtonLink').value = '';
            }
            isEditingPopUp = true; editingPopUpId = id;
            document.getElementById('popUpModalTitle').textContent = 'Update Pop Up Config';
            openModal('popUpModal');
        };

        window.editGateway = function(id) {
            const g = adminGateways.find(x => x.id === id);
            if(!g) return;
            document.getElementById('gatewayLogo').value = g.logo || '';
            document.getElementById('gatewayName').value = g.name || '';
            
            const intType = g.integrationType || 'link';
            document.querySelector(`input[name="gatewayIntegrationType"][value="${intType}"]`).checked = true;
            toggleGatewayIntegration();
            
            if (intType === 'link') {
                document.getElementById('gatewayLink').value = g.link || '';
                document.getElementById('gatewayPlugin').value = '';
            } else {
                document.getElementById('gatewayPlugin').value = g.pluginUrl || '';
                document.getElementById('gatewayLink').value = '';
            }
            isEditingGateway = true; editingGatewayId = id;
            document.getElementById('gatewayModalTitle').textContent = 'Modify Payment Gateway';
            openModal('gatewayModal');
        };

        window.deleteGateway = function(id) { if(confirm("Delete this Payment Gateway?")) db.collection('paymentGateways').doc(id).delete(); };

        function updateOrderStatus(id, status) { db.collection('orders').doc(id).update({status: status}); }
        window.deleteOrder = function(id) { if(confirm("Permanently delete this order?")) db.collection('orders').doc(id).delete(); };

        // Dynamic Field Generators - Fix 2 (Replaced innerHTML += with insertAdjacentHTML)
        window.addMediaField = function() {
            const html = `<div class="dynamic-item"><input type="text" class="form-control product-media-input" placeholder="Image URL" style="flex:1;"><button type="button" class="btn-icon-remove" onclick="this.parentElement.remove()">-</button></div>`;
            document.getElementById('mediaContainer').insertAdjacentHTML('beforeend', html);
        };
        
        window.addSizeColorField = function(colorSize = '', price = '', image = '') {
            const html = `
            <div class="dynamic-item" style="flex-wrap: wrap; gap: 10px; border-bottom: 1px dashed var(--border-color); padding-bottom: 12px; margin-bottom: 10px;">
                <input type="text" class="form-control var-color-size" placeholder="Color, Size" value="${colorSize}" style="flex: 2; min-width: 120px;">
                <input type="number" class="form-control var-price" placeholder="Price (৳)" value="${price}" style="flex: 1; min-width: 80px;">
                <input type="text" class="form-control var-image" placeholder="Image URL (Optional)" value="${image}" style="flex: 2; min-width: 150px;">
                <button type="button" class="btn-icon-remove" onclick="this.parentElement.remove()" style="margin-top: 5px;">-</button>
            </div>`;
            document.getElementById('sizeColorContainer').insertAdjacentHTML('beforeend', html);
        };
        
        window.addBannerField = function(src="", type="image", id="") {
            const html = `<div class="dynamic-item" data-id="${id}"><select class="form-control banner-type" style="flex:1;"><option value="image" ${type==='image'?'selected':''}>Image</option><option value="iframe" ${type==='iframe'?'selected':''}>Iframe</option></select><input type="text" class="form-control banner-url" placeholder="URL Source" value="${src}" style="flex:3;"><button type="button" class="btn-icon-remove" onclick="this.parentElement.remove()">-</button></div>`;
            document.getElementById('bannerContainer').insertAdjacentHTML('beforeend', html);
        };
        window.addSocialField = function(icon="", url="", id="") {
            const html = `<div class="dynamic-item" data-id="${id}"><input type="text" class="form-control social-icon-input" placeholder="Icon (e.g. fab fa-facebook)" value="${icon}" style="flex:1;"><input type="text" class="form-control social-url" placeholder="Link URL" value="${url}" style="flex:2;"><button type="button" class="btn-icon-remove" onclick="this.parentElement.remove()">-</button></div>`;
            document.getElementById('socialsContainer').insertAdjacentHTML('beforeend', html);
        };
        
        function handleSeoInput(e) {
            if (e.key === ',' || e.key === 'Enter') {
                e.preventDefault();
                const val = this.value.replace(/,/g, '').trim();
                if (val && !adminSeoKeywords.includes(val)) {
                    adminSeoKeywords.push(val); 
                    renderTags();
                }
                this.value = '';
            }
        }
        function renderTags() {
            const tags = seoTagsContainer.querySelectorAll('.tag');
            tags.forEach(t => t.remove());
            adminSeoKeywords.forEach((tag, idx) => {
                const el = document.createElement('div'); el.className = 'tag';
                el.innerHTML = `${tag} <i class="fas fa-times" onclick="adminSeoKeywords.splice(${idx},1); renderTags()"></i>`;
                seoTagsContainer.insertBefore(el, seoInput);
            });
        }
        window.removeTag = function(index) { adminSeoKeywords.splice(index, 1); renderTags(); }
        function resetSEO() { adminSeoKeywords = []; renderTags(); }
        
        window.toggleSizeColor = function() {
            const sec = document.getElementById('sizeColorSection');
            if(document.getElementById('sizeColorToggle').checked) {
                sec.classList.remove('hidden');
                if(document.getElementById('sizeColorContainer').children.length === 0) addSizeColorField();
            } else sec.classList.add('hidden');
        }
        window.togglePopUpActionButton = function() {
            if (document.getElementById('popUpActionButtonToggle').checked) document.getElementById('popUpActionButtonFields').classList.remove('hidden');
            else document.getElementById('popUpActionButtonFields').classList.add('hidden');
        }

        // Modals Logic
        function openModal(id) { document.getElementById(id).classList.add('show'); }
        window.closeModal = function(id) { 
            document.getElementById(id).classList.remove('show'); 
            if(id === 'productModal') { isEditingProduct = false; editingProductId = null; }
            if(id === 'categoryModal') { isEditingCategory = false; editingCategoryId = null; }
            if(id === 'popUpModal') { isEditingPopUp = false; editingPopUpId = null; }
            if(id === 'gatewayModal') { isEditingGateway = false; editingGatewayId = null; }
            if(id === 'offerModal') { offerForm.removeAttribute('data-editing-id'); document.querySelector('#offerForm button[type="submit"]').textContent = 'Save Offer'; }
        };
        
        window.switchOrderTab = function(status, btn) {
            currentOrderFilter = status;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            populateOrdersTable();
        }
        
        window.refreshOrders = function() { populateOrdersTable(); }
        
        window.viewOrderDetails = function(id) {
            const o = adminOrders.find(x => x.id === id);
            if(!o) return;
            
            let productsDetailHtml = o.products || 'N/A';
            let itemsArray = Array.isArray(o.cartItems) ? o.cartItems : (Array.isArray(o.products) ? o.products : null);
            if (itemsArray) {
                productsDetailHtml = itemsArray.map(item => {
                    let v = [];
                    if (item.color && item.color !== 'N/A') v.push(item.color);
                    if (item.size && item.size !== 'N/A') v.push(item.size);
                    return `<div style="padding-bottom: 8px; border-bottom: 1px dashed var(--border-color); margin-bottom: 8px;"><strong>${item.name}</strong> (x${item.qty||1}) <br> <span style="color:var(--primary-color); font-size:13px; font-weight:600;">${item.pid||'PID: N/A'}</span> ${v.length ? `<span style="font-size:13px; color:var(--gray-color);"> | [${v.join(', ')}]</span>` : ''}</div>`;
                }).join('');
            }

            document.getElementById('detailOrderId').innerText = `#${id.substring(0,8)}`;
            document.getElementById('orderDetailsContent').innerHTML = `
                <div class="detail-row"><div class="detail-label">Cart Items:</div><div class="detail-value" style="line-height:1.6;">${productsDetailHtml}</div></div>
                <div class="detail-row"><div class="detail-label">Total Payable:</div><div class="detail-value" style="font-size: 16px; font-weight: 700; color: var(--primary-color);">৳${o.amount}</div></div>
                <div class="detail-row"><div class="detail-label">Address:</div><div class="detail-value" style="font-weight: 500;">${o.address || 'N/A'}</div></div>
                <div class="detail-row"><div class="detail-label">Payment Mode:</div><div class="detail-value"><span style="background:var(--light-color); border:1px solid var(--border-color); padding: 4px 8px; border-radius: 6px; font-weight: 600;">${o.payment || 'N/A'}</span> ${o.trxId ? `<br><small style="color:var(--success-color);font-weight:600; display:inline-block; margin-top:5px;">TrxID: ${o.trxId}</small>` : ''}</div></div>
                <div class="detail-row"><div class="detail-label">Customer Name:</div><div class="detail-value" style="font-weight: 600;">${o.customer || 'N/A'}</div></div>
                <div class="detail-row"><div class="detail-label">Order Date:</div><div class="detail-value" style="color: var(--gray-color);">${o.date || 'N/A'}</div></div>
            `;
            openModal('orderDetailsModal');
        };
    </script>
</body>
</html>
